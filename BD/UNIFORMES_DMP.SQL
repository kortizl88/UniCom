--
-- Create Schema Script 
--   Database Version   : 11.2.0.1.0 
--   TOAD Version       : 9.7.2.5 
--   DB Connect String  : PVBDDES 
--   Schema             : UNIFORMES 
--   Script Created by  : USRBDDBA 
--   Script Created at  : 20/03/2018 12:17:59 pm 
--   Physical Location  :  
--   Notes              :  
--

-- Object Counts: 
--   Indexes: 53        Columns: 126        
--   Object Privileges: 4 
--   Packages: 7        Lines of Code: 569 
--   Package Bodies: 7  Lines of Code: 5270 
--   Sequences: 3 
--   Tables: 49         Columns: 340        Constraints: 97     
--   Types: 14 


CREATE OR REPLACE TYPE TYPARRTIENDASDIRIP AS TABLE OF UNIFORMES.TYPTIENDADIRIP;
/

SHOW ERRORS;


CREATE OR REPLACE TYPE TYPEARRCONFIRMACIONENTREGA AS TABLE OF UNIFORMES.TYPECONFIRMACIONENTREGA;
/

SHOW ERRORS;


CREATE OR REPLACE TYPE TYPEARRDESCUENTOSSAP AS TABLE OF UNIFORMES.TYPEDESCUENTOSSAP;
/

SHOW ERRORS;


CREATE OR REPLACE TYPE           TYPEARRPRENDAS AS TABLE OF UNIFORMES.TYPEPRENDA;
/

SHOW ERRORS;


CREATE OR REPLACE TYPE TYPEARRSEGUIMIENTOPEDDESCSAP AS TABLE OF UNIFORMES.TYPESEGUIMIENTOPEDDESCSAP;
/

SHOW ERRORS;


CREATE OR REPLACE TYPE           TYPEARRSOLICITUDPRENDA AS TABLE OF UNIFORMES.TYPESOLICITUDPRENDA;
/

SHOW ERRORS;


CREATE OR REPLACE TYPE TYPEARRWSPEDIDOSCD AS TABLE OF UNIFORMES.TYPEWSPEDIDOSCD;
/

SHOW ERRORS;


CREATE OR REPLACE TYPE TYPECONFIRMACIONENTREGA AS OBJECT 
( 
    FIFOLIOSOLICITUD    NUMBER(20),
    FIIDDETALLE         NUMBER(10),
    FIPAIS              NUMBER(3),
    FICANAL             NUMBER(10),
    FIIDSUCURSAL        NUMBER(10),
    FINUMPEDIDO         NUMBER(10),
    FISKU               NUMBER(20),
    FIIDTIPOEVENTO      NUMBER(5),
    FCDATOS             VARCHAR2(500),
    FIIDESTATUSANT      NUMBER(3),
    FIIDESTATUSNVO      NUMBER(3),
    FIERROR             NUMBER(5),
    FCCOMENTARIOS       VARCHAR2(100)
)
/

SHOW ERRORS;


CREATE OR REPLACE TYPE TYPEDESCUENTOSSAP AS OBJECT 
( 
	FIFOLIOSOLICITUD	NUMBER(10),
	FIPEDIDO			NUMBER(10),
    FCSOCIEDAD     		VARCHAR2(4 CHAR),
	FCREFERENCIA   		VARCHAR2(20 CHAR),
    FCCNOMINA      		VARCHAR2(4 CHAR),
    FNTOTAL        		NUMBER(13,2),
    FDFECHAPAGO     	DATE,
    FISEMACTUAL    		NUMBER(2),
    FNSALDO      		NUMBER(15,2),
    FNPAGO         		NUMBER(15,2)
);
/

SHOW ERRORS;


CREATE OR REPLACE TYPE           TYPEPRENDA AS OBJECT
   (
   	  FIPAIS NUMBER(3),
   	  FICANAL VARCHAR2(40 CHAR),
   	  FISUCURSAL NUMBER(10),
      FIIDTIPOPRENDA NUMBER(3),
      FITALLA    NUMBER(5),
      FICANTIDAD NUMBER(10),
      FIPRECIOUNITARIO   NUMBER(10,2)
   );
/

SHOW ERRORS;


CREATE OR REPLACE TYPE TYPESEGUIMIENTOPEDDESCSAP AS OBJECT 
	( 
    FIFOLIOSOLICITUD    NUMBER(20),    
	FIIDDETALLE 		NUMBER (10),
    FIPAIS              NUMBER(3),
    FICANAL             NUMBER(10),
    FIIDSUCURSAL        NUMBER(10),
    FIPEDIDO            NUMBER(10),
    FISKU               NUMBER(20),
    FCREFERENCIASAP     VARCHAR2(20 CHAR),
    FIESTATUSSAP        NUMBER(3),
    FCXMLREQUEST        CLOB,
    FCXMLRESPONSE       CLOB,
	FCTEXTXMLRESPONSE	VARCHAR2(500 CHAR),
	FIIDERROR			NUMBER(5)
	);
/

SHOW ERRORS;


CREATE OR REPLACE TYPE           TYPESOLICITUDPRENDA AS OBJECT
   (
      FIEMPLEADO NUMBER(10),
      FIIDTIPOSOLICITUD NUMBER(3),
      FIIDNEGOCIO NUMBER(3),
      FIFUNCIONSAP NUMBER(10),
      FIEMPLEADOCAPTURA NUMBER(10),
      PRENDAS UNIFORMES.TYPEARRPRENDAS
      
   );
/

SHOW ERRORS;


CREATE OR REPLACE TYPE TYPEWSPEDIDOSCD AS OBJECT 
( 
	FIPAIS 				NUMBER (3),
	FICANAL 			NUMBER (10),
	FIIDSUCURSAL 		NUMBER (10),
	FIPEDIDO 			NUMBER (10),
	FISKU 				NUMBER (20),
	FICANTIDAD 			NUMBER (3),
	FIFOLIOSOLICITUD 	NUMBER (20),
	FIIDDETALLE 		NUMBER (10),
	FIIDESTATUSPEDIDO 	NUMBER (3),
	FIBANDERAERROR 		NUMBER (3),
	FIESTATUSCD 		NUMBER (3),
	FCDESCRIPCIONCD 	VARCHAR2 (100),
	FICANCELADO 		NUMBER (1),
	FIRUTA				NUMBER(10),
	FCXMLRESPONSE			CLOB
);
/

SHOW ERRORS;


CREATE OR REPLACE TYPE TYPTIENDADIRIP AS OBJECT 
(
	FITIENDAID    NUMBER(10),         
	FIPAISID      NUMBER(10),        
	FICANAL       NUMBER(10),         
	FICANALCECO   NUMBER(10),         
	FCDESCRIPCION VARCHAR2(100 CHAR), 
	FCDIRECCIONIP VARCHAR2(20 CHAR)  
);
/

SHOW ERRORS;


CREATE SEQUENCE SEDETALLESOLICITUD
  START WITH 1
  MAXVALUE 99999999999999999999
  MINVALUE 1
  NOCYCLE
  NOCACHE
  NOORDER;


CREATE SEQUENCE SESOLICITUD
  START WITH 1
  MAXVALUE 99999999999999999999
  MINVALUE 1
  NOCYCLE
  NOCACHE
  NOORDER;


CREATE SEQUENCE SEWSGRABAPEDIDO
  START WITH 89188
  MAXVALUE 99999999999999999999
  MINVALUE 1
  NOCYCLE
  CACHE 500
  ORDER;


CREATE TABLE TADESCUENTOSSAP
(
  FIFOLIOCENTRAL   NUMBER(10)                   NOT NULL,
  FIPEDIDO         NUMBER(10)                   NOT NULL,
  FCSOCIEDAD       VARCHAR2(6 CHAR)             NOT NULL,
  FDPAGO           DATE                         NOT NULL,
  FCREFERENCIA     VARCHAR2(60 CHAR)            NOT NULL,
  FCCCNOMINA       VARCHAR2(6 CHAR)             NOT NULL,
  FNTOTDESCUENTO   NUMBER(6,2)                  NOT NULL,
  FISEMADESCUENTO  NUMBER(2)                    NOT NULL,
  FNSALDO          NUMBER(5,2)                  NOT NULL,
  FNPAGO           NUMBER(5,2)                  DEFAULT 0                     NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TATIPOSPRODUCTO
(
  FITIPO         NUMBER(3)                      NOT NULL,
  FCDESCRIPCION  VARCHAR2(50 CHAR)              NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TATALLAS
(
  FITALLA        NUMBER(5)                      NOT NULL,
  FCDESCRIPCION  VARCHAR2(50 CHAR)              NOT NULL,
  FCCLAVE        VARCHAR2(20 CHAR)              NOT NULL,
  FIORDEN        NUMBER(10)                     DEFAULT 0                     NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TASUCURSALES
(
  FISUCURSAL         NUMBER(5)                  NOT NULL,
  FCDESCRIPCION      VARCHAR2(100 CHAR)         NOT NULL,
  FCDIRIP            VARCHAR2(20 CHAR)          NOT NULL,
  FIIDCDISTRIBUCION  NUMBER(5)                  NOT NULL,
  FIIDFORMADOR       NUMBER(10)                 NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAREMISIONES
(
  FIFOLIOCENTRAL    NUMBER(10)                  NOT NULL,
  FIPAIS            NUMBER(5)                   NOT NULL,
  FICANAL           NUMBER(5)                   NOT NULL,
  FISUCURSAL        NUMBER(5)                   NOT NULL,
  FIPEDIDO          NUMBER(10)                  NOT NULL,
  FISKU             NUMBER(10)                  NOT NULL,
  FIREMISION        NUMBER(10)                  NOT NULL,
  FICANTIDAD        NUMBER(5)                   NOT NULL,
  FIEMPLEADORECIBE  NUMBER(10)                  NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TARELACIONESCANAL
(
  FIUNIDADNEGOCIO  NUMBER(5)                    NOT NULL,
  FCIDCANAL        VARCHAR2(5 CHAR)             NOT NULL,
  FCABREVIATURA    VARCHAR2(20 CHAR)            NOT NULL,
  FCCOMPANIA       VARCHAR2(50 CHAR)            NOT NULL,
  FCCANAL          VARCHAR2(50 CHAR)            NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAPRODUCTOSXKIT
(
  FIKIT  NUMBER(5)                              NOT NULL,
  FISKU  NUMBER(10)                             NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAPRODUCTOS
(
  FISKU        NUMBER(10)                       NOT NULL,
  FITIPO       NUMBER(3)                        NOT NULL,
  FITALLA      NUMBER(5)                        NOT NULL,
  FNCOSTO      NUMBER(10,2)                     NOT NULL,
  FNDESCUENTO  NUMBER(10,2)                     NOT NULL,
  FCGENERO     CHAR(1 CHAR)                     NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAPEDIDOS
(
  FIFOLIOCENTRAL      NUMBER(10)                NOT NULL,
  FIEMPLEADO          NUMBER(10)                NOT NULL,
  FIESTADOGENERAL     NUMBER(3)                 NOT NULL,
  FITIPO              NUMBER(3)                 NOT NULL,
  FIIDCARGA           NUMBER(5)                 NOT NULL,
  FIEMPLEADOSOLICITA  NUMBER(10)                NOT NULL,
  FIFUNCION           NUMBER(10)                NOT NULL,
  FDREGISTRO          DATE                      NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAPARAMETROSSPPI
(
  FICANAL                 NUMBER(3)             NOT NULL,
  FISERVICIO              NUMBER(3)             NOT NULL,
  FCIDCIA                 VARCHAR2(10 CHAR),
  FIIDINICC               NUMBER(3)             NOT NULL,
  FCCLAVEUSUARIO          VARCHAR2(200 CHAR),
  FCIDSISTEMASATELITAL    VARCHAR2(200 CHAR),
  FCCLAVECENTROPROVEEDOR  VARCHAR2(200 CHAR),
  FCCLAVESERVICIO         VARCHAR2(200 CHAR),
  FCCLAVESOCIEDAD         VARCHAR2(200 CHAR),
  FCDESCRIPCION           VARCHAR2(200 CHAR),
  FCCONCEPTO              VARCHAR2(200 CHAR),
  FCMONEDA                VARCHAR2(200 CHAR),
  FCORDEN                 VARCHAR2(200 CHAR),
  FIENTIDCECO             NUMBER(5)             NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAMOVTODETALLEPEDIDOS
(
  FIFOLIOCENTRAL  NUMBER(10)                    NOT NULL,
  FIPAIS          NUMBER(5)                     NOT NULL,
  FICANAL         NUMBER(5)                     NOT NULL,
  FISUCURSAL      NUMBER(5)                     NOT NULL,
  FIPEDIDO        NUMBER(10)                    NOT NULL,
  FISKU           NUMBER(10)                    NOT NULL,
  FIESTADO        NUMBER(3)                     NOT NULL,
  FDMOVIMIENTO    DATE                          NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAKITS
(
  FIKIT          NUMBER(5)                      NOT NULL,
  FCDESCRIPCION  VARCHAR2(50 CHAR)              NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAFUNCIONES
(
  FIFUNCIONSAP     NUMBER(10)                   NOT NULL,
  FIUNIDADNEGOCIO  NUMBER(5)                    NOT NULL,
  FCIDCANAL        VARCHAR2(5 CHAR)             NOT NULL,
  FCDESCRIPCION    VARCHAR2(60 CHAR)            NOT NULL,
  FIKIT            NUMBER(5)                    NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAEMPLEADOS
(
  FIEMPLEADO    NUMBER(10)                      NOT NULL,
  FCNOMBRE      VARCHAR2(60 CHAR)               NOT NULL,
  FCGENERO      CHAR(1 CHAR)                    NOT NULL,
  FIPOSICION    NUMBER(10)                      NOT NULL,
  FCPOSICION    VARCHAR2(50 CHAR),
  FCSITUACION   CHAR(1 CHAR),
  FIFUNCION     NUMBER(10),
  FICECO        NUMBER(10)                      NOT NULL,
  FCCECO        VARCHAR2(40 CHAR),
  FCPAIS        VARCHAR2(40 CHAR),
  FDINGRESO     DATE,
  FDBAJA        DATE,
  FDANTERIOR    DATE,
  FDMOVIMIENTO  DATE
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TADETALLEPEDIDOS
(
  FIFOLIOCENTRAL    NUMBER(10)                  NOT NULL,
  FIPAIS            NUMBER(5)                   NOT NULL,
  FICANAL           NUMBER(5)                   NOT NULL,
  FISUCURSAL        NUMBER(5)                   NOT NULL,
  FIPEDIDO          NUMBER(10)                  NOT NULL,
  FISKU             NUMBER(10)                  NOT NULL,
  FICANTIDAD        NUMBER(5)                   NOT NULL,
  FIESTATUS         NUMBER(3)                   NOT NULL,
  FNCOSTO           NUMBER(10,2)                NOT NULL,
  FNDESCUENTO       NUMBER(10,2)                NOT NULL,
  FIGERENTEENTREGA  NUMBER(10)                  NOT NULL,
  FDACTUALIZACION   DATE                        NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TACECO
(
  FICC               NUMBER(10)                 NOT NULL,
  FCN1               VARCHAR2(100 CHAR),
  FCN2               VARCHAR2(100 CHAR),
  FCN3               VARCHAR2(100 CHAR),
  FCN4               VARCHAR2(100 CHAR),
  FCN5               VARCHAR2(100 CHAR),
  FCN6               VARCHAR2(100 CHAR),
  FCN7               VARCHAR2(100 CHAR),
  FCN8               VARCHAR2(100 CHAR),
  FCN9               VARCHAR2(100 CHAR),
  FCN10              VARCHAR2(100 CHAR),
  FCN11              VARCHAR2(100 CHAR),
  FCN12              VARCHAR2(100 CHAR),
  FCN13              VARCHAR2(100 CHAR),
  FINUMECO           NUMBER(5)                  NOT NULL,
  FCNOMBRE           VARCHAR2(100 CHAR),
  FCIDCCPADRE        VARCHAR2(15 CHAR),
  FCNOMBREPADRE      VARCHAR2(100 CHAR),
  FIIDENTIDAD        NUMBER(5)                  NOT NULL,
  FCNOMBREENTIDAD    VARCHAR2(100 CHAR),
  FCIDCANAL          VARCHAR2(10 CHAR),
  FCCANAL            VARCHAR2(50 CHAR)          NOT NULL,
  FCCOLOR            VARCHAR2(2 CHAR),
  FCTIPOCANAL        CHAR(1 CHAR),
  FIIDTIPOOP         NUMBER(3)                  NOT NULL,
  FCTIPOCENTRO       VARCHAR2(15 CHAR),
  FINIVEL            NUMBER(3)                  NOT NULL,
  FIESTATUS          NUMBER(3)                  NOT NULL,
  FCESTATUSDESC      VARCHAR2(20 CHAR),
  FIPAIS             NUMBER(5)                  NOT NULL,
  FCPAIS             VARCHAR2(30 CHAR),
  FIIDRESP           NUMBER(10)                 NOT NULL,
  FCNOMBRERESP       VARCHAR2(60 CHAR),
  FIIDGUNCORP        NUMBER(3)                  NOT NULL,
  FCGUNCORP          VARCHAR2(100 CHAR),
  FIIDDIRECCIONRH    NUMBER(3)                  NOT NULL,
  FCDIRECCIONRH      VARCHAR2(40 CHAR),
  FIIDAREARH         NUMBER(3)                  NOT NULL,
  FCAREARH           VARCHAR2(40 CHAR),
  FCTIPOSUCURSAL     CHAR(1 CHAR),
  FCNOMTIPOSUCURSAL  VARCHAR2(100 CHAR)
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TACARGAS
(
  FIIDCARGA        NUMBER(5)                    NOT NULL,
  FCDESCRIPCION    VARCHAR2(40 CHAR)            NOT NULL,
  FDFECHAINICIAL   DATE                         NOT NULL,
  FDFECHAFINAL     DATE                         NOT NULL,
  FIESTATUS        NUMBER(3)                    NOT NULL,
  FIGENERARPEDIDO  NUMBER(1)                    DEFAULT 0
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TADESCUENTOSXPEDIDOS
(
  FIFOLIOCENTRAL  NUMBER(10)                    NOT NULL,
  FIPAIS          NUMBER(5)                     NOT NULL,
  FICANAL         NUMBER(5)                     NOT NULL,
  FISUCURSAL      NUMBER(5)                     NOT NULL,
  FIPEDIDO        NUMBER(10)                    NOT NULL,
  FISKU           NUMBER(10)                    NOT NULL,
  FCREFERENCIA    VARCHAR2(20 CHAR)             NOT NULL,
  FICONSECUTIVO   NUMBER(10)                    NOT NULL,
  FIESTATUS       NUMBER(3)                     NOT NULL,
  FCPETICION      CLOB                          NOT NULL,
  FCRESPUESTA     CLOB                          NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TADESCUENTOSSPPI
(
  FIFOLIOCENTRAL      NUMBER(10)                NOT NULL,
  FIPAIS              NUMBER(5)                 NOT NULL,
  FICANAL             NUMBER(5)                 NOT NULL,
  FISUCURSAL          NUMBER(5)                 NOT NULL,
  FIPEDIDO            NUMBER(10)                NOT NULL,
  FISKU               NUMBER(10)                NOT NULL,
  FICONSECUTIVO       NUMBER(10)                NOT NULL,
  FIESTATUS           NUMBER(3)                 NOT NULL,
  FCPETICION          CLOB                      NOT NULL,
  FCRESPUESTA         CLOB                      NOT NULL,
  FIFOLIOSPPI         NUMBER(10)                NOT NULL,
  FIPORCENTAJEAVANCE  NUMBER(5,2)               NOT NULL,
  FCDETALLEERROR      VARCHAR2(200 CHAR)        NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TATIPOSERROR
(
  FIIDERROR      NUMBER(5)                      NOT NULL,
  FCDESCRIPCION  VARCHAR2(50 CHAR)              NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAEMPLEADOSCOMERCIO
(
  FIEMPLEADO    NUMBER(10)                      NOT NULL,
  FCNOMBRE      VARCHAR2(60 CHAR)               NOT NULL,
  FCGENERO      CHAR(1 CHAR)                    NOT NULL,
  FIPOSICION    NUMBER(10)                      NOT NULL,
  FCPOSICION    VARCHAR2(50 CHAR),
  FCSITUACION   CHAR(1 CHAR),
  FIFUNCION     NUMBER(10),
  FICECO        NUMBER(10)                      NOT NULL,
  FCCECO        VARCHAR2(40 CHAR),
  FCPAIS        VARCHAR2(40 CHAR),
  FDINGRESO     DATE,
  FDBAJA        DATE,
  FDANTERIOR    DATE,
  FDMOVIMIENTO  DATE
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TATIENDASDIRIP
(
  FITIENDAID     NUMBER(10)                     NOT NULL,
  FIPAISID       NUMBER(10)                     NOT NULL,
  FICANAL        NUMBER(10)                     NOT NULL,
  FICANALCECO    NUMBER(10)                     NOT NULL,
  FCDESCRIPCION  VARCHAR2(100 CHAR)             NOT NULL,
  FCDIRECCIONIP  VARCHAR2(20 CHAR)              NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAEQUIVALENCIACANALES
(
  FICANALCECO    NUMBER(10)                     NOT NULL,
  FICANAL        NUMBER(10)                     NOT NULL,
  FCDESCRIPCION  VARCHAR2(50 CHAR)              NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAREINYECCIONPEDIDOSCD
(
  FIPAIS           NUMBER(3)                    NOT NULL,
  FICANAL          NUMBER(10)                   NOT NULL,
  FIIDSUCURSAL     NUMBER(10)                   NOT NULL,
  FIPEDIDO         NUMBER(10)                   NOT NULL,
  FISKU            NUMBER(20)                   NOT NULL,
  FIACTIVA         NUMBER(1)                    NOT NULL,
  FCDESCRIPCIONCD  VARCHAR2(100 BYTE)           NOT NULL,
  FDFECHA          DATE                         NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAESTATUSPEDIDOS
(
  FIIDESTATUSPEDIDO  NUMBER(3)                  NOT NULL,
  FCDESCRIPCION      VARCHAR2(50 CHAR)          NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TATIPOSOLICITUD
(
  FIIDTIPOSOLICITUD  NUMBER(3)                  NOT NULL,
  FCDESCRIPCION      VARCHAR2(50 CHAR)          NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TASOLICITUDES
(
  FIFOLIOSOLICITUD   NUMBER(20)                 NOT NULL,
  FIIDEMPLEADO       NUMBER(10)                 NOT NULL,
  FIIDTIPOSOLICITUD  NUMBER(3)                  NOT NULL,
  FIIDNEGOCIO        NUMBER(3)                  NOT NULL,
  FIFUNCIONSAP       NUMBER(10)                 NOT NULL,
  FIIDEMPCAPTURA     NUMBER(10)                 NOT NULL,
  FDFECHACAPTURA     DATE                       NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TASOLICITUDESDETALLE
(
  FIFOLIOSOLICITUD  NUMBER(20)                  NOT NULL,
  FIIDDETALLE       NUMBER(10)                  NOT NULL,
  FIIDTIPOPRENDA    NUMBER(3)                   NOT NULL,
  FITALLA           NUMBER(10)                  NOT NULL,
  FICANTIDAD        NUMBER(3)                   NOT NULL,
  FNPRECIOUNITARIO  NUMBER(10,2)                NOT NULL,
  FNPRECIOTOTAL     NUMBER(10,2)                NOT NULL,
  FIBANDERAACTIVA   NUMBER(3)                   NOT NULL,
  FIPAIS            NUMBER(3)                   NOT NULL,
  FICANAL           NUMBER(10)                  NOT NULL,
  FISUCURSAL        NUMBER(10)                  NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TATIENDAS
(
  FIPAIS             NUMBER(3)                  NOT NULL,
  FICANAL            NUMBER(10)                 NOT NULL,
  FISUCURSAL         NUMBER(10)                 NOT NULL,
  FCNOMBRE           VARCHAR2(100 CHAR)         NOT NULL,
  FCDIRIP            VARCHAR2(20 CHAR)          NOT NULL,
  FIIDCDISTRIBUCION  NUMBER(10)                 NOT NULL,
  FIIDFORMADOR       NUMBER(10)                 NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAPEDIDOSCD
(
  FIPAIS             NUMBER(3)                  NOT NULL,
  FICANAL            NUMBER(10)                 NOT NULL,
  FIIDSUCURSAL       NUMBER(10)                 NOT NULL,
  FIPEDIDO           NUMBER(10)                 NOT NULL,
  FISKU              NUMBER(20)                 NOT NULL,
  FICANTIDAD         NUMBER(3)                  NOT NULL,
  FIFOLIOSOLICITUD   NUMBER(20)                 NOT NULL,
  FIIDDETALLE        NUMBER(10)                 NOT NULL,
  FIIDESTATUSPEDIDO  NUMBER(3)                  NOT NULL,
  FIBANDERAERROR     NUMBER(3)                  NOT NULL,
  FIESTATUSCD        NUMBER(3)                  NOT NULL,
  FCDESCRIPCIONCD    VARCHAR2(100 CHAR)         NOT NULL,
  FICANCELADO        NUMBER(10)                 NOT NULL,
  FIRUTA             NUMBER(10)
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAREMISIONESXPEDIDO
(
  FIPAIS            NUMBER(3)                   NOT NULL,
  FICANAL           NUMBER(10)                  NOT NULL,
  FISUCURSAL        NUMBER(10)                  NOT NULL,
  FIPEDIDO          NUMBER(10)                  NOT NULL,
  FISKU             NUMBER(20)                  NOT NULL,
  FIREMISION        NUMBER(20)                  NOT NULL,
  FICANTIDAD        NUMBER(3)                   NOT NULL,
  FIEMPLEADORECIBE  NUMBER(10)                  NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TATIPOCALCULOPRECIO
(
  FIIDTIPOCALCULO  NUMBER(3)                    NOT NULL,
  FCDESCRIPCION    VARCHAR2(50 CHAR)            NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TATIPOSEVENTO
(
  FIIDTIPOEVENTO  NUMBER(5)                     NOT NULL,
  FCDESCRIPCION   VARCHAR2(50 CHAR)             NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TABITACORASOLICITUD
(
  FIIDBITACORA      NUMBER(20)                  NOT NULL,
  FIFOLIOSOLICITUD  NUMBER(20)                  NOT NULL,
  FIIDDETALLE       NUMBER(10)                  NOT NULL,
  FIPAIS            NUMBER(3)                   NOT NULL,
  FICANAL           NUMBER(10)                  NOT NULL,
  FIIDSUCURSAL      NUMBER(10)                  NOT NULL,
  FINUMPEDIDO       NUMBER(10),
  FISKU             NUMBER(20),
  FIIDTIPOEVENTO    NUMBER(5)                   NOT NULL,
  FXDATOS           SYS.XMLTYPE,
  FIIDESTATUSANT    NUMBER(3)                   NOT NULL,
  FIIDESTATUSNVO    NUMBER(3)                   NOT NULL,
  FDFECHAEVENTO     DATE                        NOT NULL,
  FIIDERROR         NUMBER(5)                   NOT NULL,
  FCCOMENTARIOS     VARCHAR2(100 CHAR)          NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TACANTIDADES
(
  FIIDTIPOSOLICITUD  NUMBER(3)                  NOT NULL,
  FIIDTIPOPRENDA     NUMBER(3)                  NOT NULL,
  FIMINIMO           NUMBER(1)                  NOT NULL,
  FIMAXIMO           NUMBER(3)                  NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAPRECIOS
(
  FIIDTIPOSOLICITUD  NUMBER(3)                  NOT NULL,
  FIIDTIPOPRENDA     NUMBER(3)                  NOT NULL,
  FIIDTIPOCALCULO    NUMBER(3)                  NOT NULL,
  FNVALOR            NUMBER(10,2)               NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TASOLICITUDESXCARGA
(
  FIFOLIOSOLICITUD  NUMBER(20)                  NOT NULL,
  FIIDCARGA         NUMBER(10)                  NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAMENUS
(
  FIIDMENU          NUMBER(3)                   NOT NULL,
  FCTITULO          VARCHAR2(300 CHAR)          NOT NULL,
  FCDESCMENU        VARCHAR2(300 CHAR)          NOT NULL,
  FCRUTAENLACE      VARCHAR2(300 CHAR)          NOT NULL,
  FIAPLICACARGA     NUMBER(1)                   NOT NULL,
  FIBLOQUEADOCARGA  NUMBER(1)                   NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAMENUSFUNCIONESXNEGOCIO
(
  FIIDMENU      NUMBER(3)                       NOT NULL,
  FIIDNEGOCIO   NUMBER(3)                       NOT NULL,
  FIFUNCIONSAP  NUMBER(10)                      NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TACARGASXNEGOCIO
(
  FIIDCARGA    NUMBER(5)                        NOT NULL,
  FIIDNEGOCIO  NUMBER(3)                        NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAGENERO
(
  FIIDGENERO     NUMBER(3)                      NOT NULL,
  FCDESCRIPCION  VARCHAR2(50 CHAR)              NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TATALLASXTIPOPRENDA
(
  FIIDTIPOPRENDA  NUMBER(3)                     NOT NULL,
  FITALLA         NUMBER(3)                     NOT NULL,
  FIIDGENERO      NUMBER(3)                     NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TATIPOSPRENDA
(
  FIIDTIPOPRENDA  NUMBER(3)                     NOT NULL,
  FCDESCRIPCION   VARCHAR2(50 CHAR)             NOT NULL,
  FCIMAGEN        VARCHAR2(300 CHAR)            NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAPRENDAS
(
  FISKU           NUMBER(20)                    NOT NULL,
  FCDESCRIPCION   VARCHAR2(50 CHAR)             NOT NULL,
  FIIDTIPOPRENDA  NUMBER(3)                     NOT NULL,
  FITALLA         NUMBER(3)                     NOT NULL,
  FIIDGENERO      NUMBER(3)                     NOT NULL,
  FNCOSTO         NUMBER(10,2)                  NOT NULL,
  FIDISCONTINUO   NUMBER(3)                     NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TASKUSXKIT
(
  FISKU  NUMBER(20)                             NOT NULL,
  FIKIT  NUMBER(10)                             NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TANEGOCIOS
(
  FIIDNEGOCIO         NUMBER(3)                 NOT NULL,
  FCDESCRIPCION       VARCHAR2(50 CHAR)         NOT NULL,
  FCDESCRCORTA        VARCHAR2(30 CHAR)         NOT NULL,
  FISOLICITAENTIENDA  NUMBER(1)                 DEFAULT 1
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TAFUNCIONESXNEGOCIO
(
  FIIDNEGOCIO           NUMBER(3)               NOT NULL,
  FIFUNCIONSAP          NUMBER(10)              NOT NULL,
  FIKIT                 NUMBER(10)              NOT NULL,
  FCDESCFUNCION         VARCHAR2(300 CHAR)      DEFAULT ' '                   NOT NULL,
  FISOLICITUDPLANTILLA  NUMBER(1)               DEFAULT 0,
  FICANAL               NUMBER(10)              NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TATIPOSPRENDAXKIT
(
  FIKIT           NUMBER(10)                    NOT NULL,
  FIIDTIPOPRENDA  NUMBER(3)                     NOT NULL
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE TABLE TADESCUENTOSSAPTEST
(
  FIFOLIOCENTRAL   NUMBER(10),
  FIPEDIDO         NUMBER(10),
  FCSOCIEDAD       VARCHAR2(6 CHAR),
  FDPAGO           DATE,
  FCREFERENCIA     VARCHAR2(60 CHAR),
  FCCCNOMINA       VARCHAR2(6 CHAR),
  FNTOTDESCUENTO   NUMBER(6,2),
  FISEMADESCUENTO  NUMBER(2),
  FNSALDO          NUMBER(5,2),
  FNPAGO           NUMBER(5,2)
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE UNIQUE INDEX PK_TACARGAS ON TACARGAS
(FIIDCARGA)
LOGGING
NOPARALLEL;


CREATE INDEX IX_TACARGAS_01 ON TACARGAS
(FIESTATUS)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TACECO ON TACECO
(FICC)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TADESCUENTOSSPPI ON TADESCUENTOSSPPI
(FIFOLIOCENTRAL, FIPAIS, FICANAL, FISUCURSAL, FIPEDIDO, 
FISKU, FICONSECUTIVO)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TADESCUENTOSXPEDIDOS ON TADESCUENTOSXPEDIDOS
(FIFOLIOCENTRAL, FIPAIS, FICANAL, FISUCURSAL, FIPEDIDO, 
FISKU, FCREFERENCIA, FICONSECUTIVO)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TADETALLEPEDIDOS ON TADETALLEPEDIDOS
(FIFOLIOCENTRAL, FIPAIS, FICANAL, FISUCURSAL, FIPEDIDO, 
FISKU)
LOGGING
NOPARALLEL;


CREATE INDEX IX_TADETALLEPEDIDOS_01 ON TADETALLEPEDIDOS
(FIESTATUS)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TAEMPLEADOS ON TAEMPLEADOS
(FIEMPLEADO)
LOGGING
NOPARALLEL;


CREATE INDEX IX_TAEMPLEADOS_01 ON TAEMPLEADOS
(FCSITUACION, FIFUNCION, FICECO)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TAFUNCIONES ON TAFUNCIONES
(FIFUNCIONSAP, FIUNIDADNEGOCIO, FCIDCANAL)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TATIPOSERROR ON TATIPOSERROR
(FIIDERROR)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TAEQUIVALENCIACANALES ON TAEQUIVALENCIACANALES
(FICANALCECO, FICANAL)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TATIENDASDIRIP ON TATIENDASDIRIP
(FITIENDAID, FIPAISID, FICANAL, FICANALCECO)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TAREINYECCIONPEDIDOSCD ON TAREINYECCIONPEDIDOSCD
(FIPAIS, FICANAL, FIIDSUCURSAL, FIPEDIDO, FISKU)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TAKITS ON TAKITS
(FIKIT)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TAMOVTODETALLEPEDIDOS ON TAMOVTODETALLEPEDIDOS
(FIFOLIOCENTRAL, FIPAIS, FICANAL, FISUCURSAL, FIPEDIDO, 
FISKU, FIESTADO)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TAPARAMETROSSPPI ON TAPARAMETROSSPPI
(FICANAL)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TAPEDIDOS ON TAPEDIDOS
(FIFOLIOCENTRAL)
LOGGING
NOPARALLEL;


CREATE INDEX IX_TAPEDIDOS_01 ON TAPEDIDOS
(FITIPO, FIIDCARGA)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TAPRODUCTOS ON TAPRODUCTOS
(FISKU)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TAPRODUCTOSXKIT ON TAPRODUCTOSXKIT
(FIKIT, FISKU)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TARELACIONESCANAL ON TARELACIONESCANAL
(FIUNIDADNEGOCIO, FCIDCANAL)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TAREMISIONES ON TAREMISIONES
(FIFOLIOCENTRAL, FIPAIS, FICANAL, FISUCURSAL, FIPEDIDO, 
FISKU, FIREMISION)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TASUCURSALES ON TASUCURSALES
(FISUCURSAL)
LOGGING
NOPARALLEL;


CREATE INDEX IX_TASUCURSALES_01 ON TASUCURSALES
(FIIDFORMADOR)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TATALLAS ON TATALLAS
(FITALLA)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TATIPOSPRODUCTO ON TATIPOSPRODUCTO
(FITIPO)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TADESCUENTOSSAP ON TADESCUENTOSSAP
(FIFOLIOCENTRAL, FIPEDIDO, FCSOCIEDAD, FDPAGO)
LOGGING
NOPARALLEL;


CREATE INDEX IX_TAFUNCIONES_01 ON TAFUNCIONES
(FIFUNCIONSAP, FCIDCANAL, FIKIT)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TAESTATUSPEDIDOS ON TAESTATUSPEDIDOS
(FIIDESTATUSPEDIDO)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TATIPOSOLICITUD ON TATIPOSOLICITUD
(FIIDTIPOSOLICITUD)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TASOLICITUDES ON TASOLICITUDES
(FIFOLIOSOLICITUD)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TASOLICITUDESDETALLE ON TASOLICITUDESDETALLE
(FIFOLIOSOLICITUD, FIIDDETALLE)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TATIENDAS ON TATIENDAS
(FIPAIS, FICANAL, FISUCURSAL)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TAPEDIDOSCD ON TAPEDIDOSCD
(FIPAIS, FICANAL, FIIDSUCURSAL, FIPEDIDO, FISKU)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TAREMISIONESXPEDIDO ON TAREMISIONESXPEDIDO
(FIPAIS, FICANAL, FISUCURSAL, FIPEDIDO, FISKU, 
FIREMISION)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TATIPOCALCULOPRECIO ON TATIPOCALCULOPRECIO
(FIIDTIPOCALCULO)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TATIPOSEVENTO ON TATIPOSEVENTO
(FIIDTIPOEVENTO)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TABITACORASOLICITUD ON TABITACORASOLICITUD
(FIIDBITACORA)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TACANTIDADES ON TACANTIDADES
(FIIDTIPOSOLICITUD, FIIDTIPOPRENDA)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TAPRECIOS ON TAPRECIOS
(FIIDTIPOSOLICITUD, FIIDTIPOPRENDA)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TASOLICITUDESXCARGA ON TASOLICITUDESXCARGA
(FIFOLIOSOLICITUD, FIIDCARGA)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TAMENUS ON TAMENUS
(FIIDMENU)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TAMENUSFUNCIONESXNEGOCIO ON TAMENUSFUNCIONESXNEGOCIO
(FIIDMENU, FIIDNEGOCIO, FIFUNCIONSAP)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TACARGASXNEGOCIO ON TACARGASXNEGOCIO
(FIIDCARGA, FIIDNEGOCIO)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TATIPOSPRENDA ON TATIPOSPRENDA
(FIIDTIPOPRENDA)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TAGENERO ON TAGENERO
(FIIDGENERO)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TATALLASXTIPOPRENDA ON TATALLASXTIPOPRENDA
(FIIDTIPOPRENDA, FITALLA, FIIDGENERO)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TAPRENDAS ON TAPRENDAS
(FISKU)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TASKUSXKIT ON TASKUSXKIT
(FISKU, FIKIT)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TANEGOCIOS ON TANEGOCIOS
(FIIDNEGOCIO)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TAFUNCIONESXNEGOCIO ON TAFUNCIONESXNEGOCIO
(FIIDNEGOCIO, FIFUNCIONSAP)
LOGGING
NOPARALLEL;


CREATE UNIQUE INDEX PK_TATIPOSPRENDAXKIT ON TATIPOSPRENDAXKIT
(FIKIT, FIIDTIPOPRENDA)
LOGGING
NOPARALLEL;


CREATE OR REPLACE PACKAGE           PAWSUNIFORMES
AS
/*************************************************************
   Proyecto:                       Uniformes 
   Descripcion:                    Paquete para Crones De uniformes
   Parametros de entrada:          Todos los campos que expone SAP
   Parametros de salida:           No aplica
   Parametros de entrada-salida    No aplica
   Precondiciones:                 Tener creado el esquema
   Creador:                        Laura Garcia Martinez
   Fecha de creacion:             17 JUNIO 2014
********************************************************************/
   
   TYPE rcgCursor IS REF CURSOR; -- Cursor por referencia


PROCEDURE SPCONSULTAEMPLEADOCARGA(
    paNumEmpleado   IN    UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE
   ,paCurPedidoActual OUT rcgCursor );


PROCEDURE  SPGRABAPEDIDO(
    paIdEmpleado         IN   UNIFORMES.TAPEDIDOS.FIEMPLEADO%TYPE
   ,paEstadoGral         IN   UNIFORMES.TAPEDIDOS.FIESTADOGENERAL%TYPE
   ,paTipo               IN   UNIFORMES.TAPEDIDOS.FITIPO%TYPE
   ,paEmpleadoSolicita   IN   UNIFORMES.TAPEDIDOS.FIEMPLEADOSOLICITA%TYPE
   ,paFuncion            IN   UNIFORMES.TAPEDIDOS.FIFUNCION%TYPE
   ,paFolioCentral       OUT  UNIFORMES.TAPEDIDOS.FIFOLIOCENTRAL%TYPE );


PROCEDURE SPGRABADETPEDIDO(
    paPais             IN    UNIFORMES.TADETALLEPEDIDOS.FIPAIS%TYPE
   ,paCanal            IN    UNIFORMES.TADETALLEPEDIDOS.FICANAL%TYPE
   ,paSucursal         IN    UNIFORMES.TADETALLEPEDIDOS.FISUCURSAL%TYPE 
   ,paPedido           IN    UNIFORMES.TADETALLEPEDIDOS.FIPEDIDO%TYPE
   ,paFolioCentral     IN    UNIFORMES.TADETALLEPEDIDOS.FIFOLIOCENTRAL%TYPE
   ,paSKU              IN    UNIFORMES.TADETALLEPEDIDOS.FISKU%TYPE
   ,paCantidad         IN    UNIFORMES.TADETALLEPEDIDOS.FICANTIDAD%TYPE 
   ,paEstatus          IN    UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE
   ,paCosto            IN    UNIFORMES.TADETALLEPEDIDOS.FNCOSTO%TYPE
   ,paDescuento        IN    UNIFORMES.TADETALLEPEDIDOS.FNDESCUENTO%TYPE );   


PROCEDURE  SPPEDIDOSPENDIENTESABASTO(
   paCurPendientesAb     OUT    rcgCursor );   
   
   
PROCEDURE SPCONSULTAEMPLEADOSOLICITUD(
   paTienda        IN    VARCHAR2
  ,paCurSolicitud  OUT   rcgCursor);

   
PROCEDURE SPSOLICITUDFORMADOR(
   paIdEmpleado    IN    UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE
  ,paCurSolicitud  OUT   rcgCursor);
   
      
FUNCTION FNGRABAREMISION(
    paRemision     IN UNIFORMES.TAREMISIONES.FIREMISION%TYPE
   ,paSucursal     IN UNIFORMES.TAREMISIONES.FISUCURSAL%TYPE
   ,paPedido       IN UNIFORMES.TAREMISIONES.FIPEDIDO%TYPE
   ,paSku          IN UNIFORMES.TAREMISIONES.FISKU%TYPE
   ,paCantidad     IN UNIFORMES.TAREMISIONES.FICANTIDAD%TYPE
   ,paEmpleadoRecibe IN UNIFORMES.TAREMISIONES.FIEMPLEADORECIBE%TYPE)
RETURN PAWSUNIFORMES.rcgCursor;
 

PROCEDURE SPCONSULTAENTREGA
(   paIdEmpleado    IN    UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE
   ,paTienda        IN    UNIFORMES.TASUCURSALES.FISUCURSAL%TYPE
   ,paCurEntrega   OUT   rcgCursor);
   

PROCEDURE SPGRABAENTREGA
(   paFolioCentral  IN    UNIFORMES.TADETALLEPEDIDOS.FIFOLIOCENTRAL%TYPE
   ,paPais          IN    UNIFORMES.TADETALLEPEDIDOS.FIPAIS%TYPE
   ,paCanal         IN    UNIFORMES.TADETALLEPEDIDOS.FICANAL%TYPE
   ,paSucursal      IN    UNIFORMES.TADETALLEPEDIDOS.FISUCURSAL%TYPE
   ,paPedido        IN    UNIFORMES.TADETALLEPEDIDOS.FIPEDIDO%TYPE
   ,paSKU           IN    UNIFORMES.TADETALLEPEDIDOS.FISKU%TYPE
   ,paEstAnterior   IN    UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE
   ,paFecAnterior   IN    VARCHAR2
   ,paGerente       IN    UNIFORMES.TADETALLEPEDIDOS.FIGERENTEENTREGA%TYPE);
   
--lau --
PROCEDURE SPACTMOVTOPEDIDOS(
   paIdPais         IN  UNIFORMES.TADETALLEPEDIDOS.FIPAIS%TYPE
  ,paIdCanal        IN  UNIFORMES.TADETALLEPEDIDOS.FICANAL%TYPE
  ,paSucursal       IN  UNIFORMES.TADETALLEPEDIDOS.FISUCURSAL%TYPE
  ,paPedido         IN  UNIFORMES.TADETALLEPEDIDOS.FIPEDIDO%TYPE
  ,paFolioCentral   IN  UNIFORMES.TADETALLEPEDIDOS.FIFOLIOCENTRAL%TYPE
  ,paSKU            IN  UNIFORMES.TADETALLEPEDIDOS.FISKU%TYPE
  ,paEstatusAnterior IN  UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE
  ,paActualizacion  IN  VARCHAR2
  ,paEstatusNuevo   IN  UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE);
  
PROCEDURE SPCONSULTAKIT(
   paIdEmpleado    IN    UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE
  ,paIdBandera     IN    NUMBER
  ,paCurSolicitud  OUT   rcgCursor);
  
PROCEDURE SPSOLICITUDINDIVIDUAL( 
        paIdEmpleado         IN UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE,
        paFuncionEmpleado    IN UNIFORMES.TAEMPLEADOS.FIFUNCION%TYPE,
        paGeneroEmpleado     IN UNIFORMES.TAEMPLEADOS.FCGENERO%TYPE,
        paCurSolicitud      OUT rcgCursor
     );
     
PROCEDURE SPCONSULTASUCURSALPEDIDO(
   paTienda        IN    UNIFORMES.TASUCURSALES.FISUCURSAL%TYPE,
   paFolioCentral       IN  UNIFORMES.TAPEDIDOS.FIFOLIOCENTRAL%TYPE, 
   paCurSucursal  OUT   rcgCursor,
   parCurSucursalPedido OUT   rcgCursor);
   
END PAWSUNIFORMES;
/

SHOW ERRORS;


CREATE OR REPLACE PACKAGE PAWEBUNIFORMESCOMERCIO2 AS 

  /* TODO enter package declarations (types, exceptions, methods etc) here */ 
  TYPE rcgCursor IS REF CURSOR;
  
 FUNCTION FNCONSULTASOLICITUDES(
      paNumeroEmpleado UNIFORMES.TASOLICITUDES.FIIDEMPLEADO%TYPE, 
      paNumeroSolicitudes NUMBER)
 RETURN rcgCursor;

 FUNCTION FNCONSULTASOLICITUD(
      paNoFolioSolicitud UNIFORMES.TASOLICITUDES.FIFOLIOSOLICITUD%TYPE)  
  RETURN rcgCursor;

 FUNCTION FNDEFINEDESCRIPCIONPRENDA(
    paSKU UNIFORMES.TABITACORASOLICITUD.FISKU%TYPE,
    paIDTipoPrenda UNIFORMES.TASOLICITUDESDETALLE.FIIDTIPOPRENDA%TYPE
 )
 RETURN VARCHAR2;
 
 FUNCTION FNCADENAESTADOESTATUS(
    paNoEstadoNuevo UNIFORMES.TABITACORASOLICITUD.FIIDESTATUSNVO%TYPE
 )
 RETURN VARCHAR2;
 
 FUNCTION FNNOREMISION(
    paNoPedido UNIFORMES.TABITACORASOLICITUD.FINUMPEDIDO%TYPE,
    paNoSKU UNIFORMES.TABITACORASOLICITUD.FISKU%TYPE
 )
 RETURN NUMBER;

 FUNCTION FNCONSULTASOLICITUDAVANCE(
    paNoFolioSolicitud UNIFORMES.TASOLICITUDES.FIFOLIOSOLICITUD%TYPE
 )
 RETURN rcgCursor;

 FUNCTION FNCALCULOPORCENTAJE(
    paNoFolioSolicitud UNIFORMES.TASOLICITUDESDETALLE.FIFOLIOSOLICITUD%TYPE
 )
 RETURN NUMBER;

 FUNCTION FNCONSULTASOLICITUDESV(
  paNumeroEmpleado UNIFORMES.TASOLICITUDES.FIIDEMPLEADO%TYPE,
  paNumeroSolicitudes NUMBER
 )
 RETURN rcgCursor;

 FUNCTION FNPEDIDOSPORPRECIO(
  paFolioSolicitud UNIFORMES.TAPEDIDOSCD.FIFOLIOSOLICITUD%TYPE
 )
 RETURN rcgCursor;

 FUNCTION FNINFORMACIONDESCUENTO(
  paFolioSolicitud UNIFORMES.TAPEDIDOSCD.FIFOLIOSOLICITUD%TYPE,
  paNumeroPedido UNIFORMES.TAPEDIDOSCD.FIPEDIDO%TYPE
 )
 RETURN rcgCursor;
 
 FUNCTION FNCADENAPORCENTAJE(
  paNoPorcentaje NUMBER
 )  
 RETURN VARCHAR2;
 
 PROCEDURE SPGUARDACONFIRMACIONENTREGA(
    paConfirmacionesEntrega IN UNIFORMES.TYPEARRCONFIRMACIONENTREGA,
    paNoConfirmaciones OUT NUMBER
 );
  
END PAWEBUNIFORMESCOMERCIO2;
/

SHOW ERRORS;


CREATE OR REPLACE PACKAGE           PAWEBUNIFORMESCOMERCIO
AS
  /*************************************************************
  Proyecto:                       Uniformes Comercio
  Descripcion:                    Paquete para sistema de uniformes Div. Comercial
  Parametros de entrada:          No aplica
  Parametros de salida:           No aplica
  Parametros de entrada-salida    No aplica
  Precondiciones:                 Tener creado el esquema
  Creador:                        
  Fecha de creacion:              
  *************************************************************/
  TYPE rcgCursor IS REF CURSOR;
  
  FUNCTION FNCONSULTAINFOEMPLEADO(
      paNumEmpleado  IN UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE)
  RETURN rcgCursor;

  FUNCTION FNCONSULTAMENUFUNCIONXNEGOCIO(
    paNoNegocio IN UNIFORMES.TACARGASXNEGOCIO.FIIDNEGOCIO%TYPE,
    paNoFuncionSap IN UNIFORMES.TAMENUSFUNCIONESXNEGOCIO.FIIDNEGOCIO%TYPE
  )
  RETURN rcgCursor;
   
  FUNCTION FNCONSULTAMENUEMPLEADO(
  	paNumEmpleado  IN UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE)
  RETURN rcgCursor;
  
  FUNCTION FNCONSINFOTIENDA(
      paPais UNIFORMES.TATIENDAS.FIPAIS%TYPE,
      paCanal UNIFORMES.TATIENDAS.FICANAL%TYPE,
      paTienda UNIFORMES.TATIENDAS.FISUCURSAL%TYPE)
  RETURN rcgCursor;
  
  FUNCTION FNCONSEMPLEDOSNUEVOINGRESO(
      paCeco UNIFORMES.TAEMPLEADOS.FICECO%TYPE)
  RETURN rcgCursor;
  
  FUNCTION FNCONSTIENDASCERCANAS(
      paPais UNIFORMES.TACECO.FIPAIS%TYPE,
      paCanal UNIFORMES.TACECO.FCIDCANAL%TYPE,
      paTienda UNIFORMES.TACECO.FICC%TYPE)
  RETURN rcgCursor;
  
  FUNCTION FNCONSKITEMPLEADO(
  	paNumEmp UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE,
  	paTipoSol UNIFORMES.TAPRECIOS.FIIDTIPOSOLICITUD%TYPE)
  RETURN rcgCursor;
  
  FUNCTION FNCONSKITEMPLEADOSTIENDA(
  	paPais UNIFORMES.TATIENDAS.FIPAIS%TYPE,
  	paCanal UNIFORMES.TATIENDAS.FICANAL%TYPE,
  	paTienda UNIFORMES.TATIENDAS.FISUCURSAL%TYPE,
  	paTipoSol UNIFORMES.TAPRECIOS.FIIDTIPOSOLICITUD%TYPE)
  RETURN rcgCursor;
  
  PROCEDURE SPGUARDASOLICITUD(
    paSolicitudes IN UNIFORMES.TYPEARRSOLICITUDPRENDA
   ,curResultado OUT rcgCursor );
  
  FUNCTION FNCONSPEDIDOSXENTREGAR(
   paNumEmp UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE
  )
  RETURN rcgCursor;
  
END PAWEBUNIFORMESCOMERCIO;
/

SHOW ERRORS;


CREATE OR REPLACE PACKAGE           PAWEBUNIFORMES
AS
/*************************************************************
   Proyecto:                       Uniformes 
   Descripcion:                    Paquete para Paginas WEB de Uniformes
   Parametros de entrada:          No aplica
   Parametros de salida:           No aplica
   Parametros de entrada-salida    No aplica
   Precondiciones:                 Tener creado el esquema
   Creador:                        Carolina Pérez Vite
   Fecha de creacion:              31 de Agosto del 2016
********************************************************************/
   
   TYPE rcgCursor IS REF CURSOR; -- Cursor por referencia


FUNCTION FNCONSULTAPEDIDOS
   (paSucursal UNIFORMES.TADETALLEPEDIDOS.FISUCURSAL%TYPE,
    paNoEmpelado UNIFORMES.TAPEDIDOS.FIEMPLEADO%TYPE,
    paNoPedido UNIFORMES.TADETALLEPEDIDOS.FIPEDIDO%TYPE)
RETURN PAWEBUNIFORMES.rcgCursor;
   
END PAWEBUNIFORMES;
/

SHOW ERRORS;


CREATE OR REPLACE PACKAGE           PASRVUNIFORMESCOMERCIO
AS
  /*************************************************************
  Proyecto:                       Uniformes Comercio
  Descripcion:                    Paquete para sistema de uniformes Div. Comercial
  Parametros de entrada:          No aplica
  Parametros de salida:           No aplica
  Parametros de entrada-salida    No aplica
  Precondiciones:                 Tener creado el esquema
  Creador:                        
  Fecha de creacion:              
  *************************************************************/
    TYPE rcgCursor IS REF CURSOR;

    FUNCTION FNCONSSOLPENDGRABARTIENDA
        RETURN rcgCursor;
  
  PROCEDURE SPACTUALIZARPEDIDOSCD
  			(paWSPedidosCD IN UNIFORMES.TYPEARRWSPEDIDOSCD,
  			 paResultado OUT NUMBER);
  
    FUNCTION FNCONSSOLPENDGRABARCD
        RETURN rcgCursor;
    
    FUNCTION FNCONSULTAPEDIDOSENCD
        RETURN rcgCursor;
  
    PROCEDURE SPCONSULTAPEDIDOSDESCUENTOSSAP(
        curResultado OUT rcgCursor);
            
    PROCEDURE SPSEGUIMIENTOPEDDESCSAP( 
        paSeguimientoPedidosDescuentos IN UNIFORMES.TYPEARRSEGUIMIENTOPEDDESCSAP);        
    
    PROCEDURE SPACTUALIZATIENDAS(
        noTiendas out NUMBER);

    FUNCTION FNREGRESANUMERO(
        paCadena UNIFORMES.TACECO.FCIDCANAL%TYPE)
    RETURN NUMBER;
 
     PROCEDURE SPCARGATIENDASDIRIP(
        paTiendas   IN OUT UNIFORMES.TYPARRTIENDASDIRIP,
        paNoTiendas OUT NUMBER,
        curResultado OUT rcgCursor);
    
    PROCEDURE SPACTUALIZADESCUENTOSSAP(
        paDescuentosSAP IN UNIFORMES.TYPEARRDESCUENTOSSAP,
        paNoRegistrosAct OUT NUMBER);
        
 FUNCTION FNESTATUSPEDIDOSCD(
    paNoPais        UNIFORMES.TAPEDIDOSCD.FIPAIS%TYPE,
    paNoCanal       UNIFORMES.TAPEDIDOSCD.FICANAL%TYPE,
    paNoSucursal    UNIFORMES.TAPEDIDOSCD.FIIDSUCURSAL%TYPE,
    paNoPedido      UNIFORMES.TAPEDIDOSCD.FIPEDIDO%TYPE,
    paNoSKU         UNIFORMES.TAPEDIDOSCD.FISKU%TYPE
 ) RETURN NUMBER;        
  
END PASRVUNIFORMESCOMERCIO;
/

SHOW ERRORS;


CREATE OR REPLACE PACKAGE           PASRVOPERAUNIFORMES
AS
/*************************************************************
   Proyecto:                       Uniformes 
   Descripcion:                    Paquete para Crones De uniformes
   Parametros de entrada:          Todos los campos 
   Parametros de salida:           No aplica
   Parametros de entrada-salida    No aplica
   Precondiciones:                 Tener creado el esquema
   Creador:                        R. Isaac Suárez Mercado
   Fecha de creacion:             7 JULIO 2014
********************************************************************/
   
   TYPE rcgCursor IS REF CURSOR; -- Cursor por referencia


FUNCTION FNCONSULTATIENDAS
RETURN rcgCursor;


PROCEDURE SPACTPEDIDOTIENDA(
   paPais      IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FIPAIS%TYPE
  ,paCanal     IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FICANAL%TYPE
  ,paSucursal  IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FISUCURSAL%TYPE
  ,paPedido    IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FIPEDIDO%TYPE
  ,paFolioCentral  IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FIFOLIOCENTRAL%TYPE
  ,paSKU       IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FISKU%TYPE
  ,paEstatusAnt  IN  UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE
  ,paActualizacion  IN VARCHAR2 );

  
FUNCTION FNCONSULTAABASTO
RETURN rcgCursor;

  
PROCEDURE SPACTPEDIDOABASTO(
   paPais      IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FIPAIS%TYPE
  ,paCanal     IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FICANAL%TYPE
  ,paSucursal  IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FISUCURSAL%TYPE
  ,paPedido    IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FIPEDIDO%TYPE
  ,paFolioCentral  IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FIFOLIOCENTRAL%TYPE
  ,paSKU       IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FISKU%TYPE
  ,paEstatusAnt  IN  UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE
  ,paActualizacion  IN VARCHAR2 );
  
   
PROCEDURE SPCANCELAPEDIDOXBAJA(
   paPais      IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FIPAIS%TYPE
  ,paCanal     IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FICANAL%TYPE
  ,paSucursal  IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FISUCURSAL%TYPE
  ,paPedido    IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FIPEDIDO%TYPE
  ,paFolioCentral  IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FIFOLIOCENTRAL%TYPE
  ,paSKU       IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FISKU%TYPE
  ,paEstatusAnt  IN  UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE
  ,paActualizacion  IN VARCHAR2);
  

FUNCTION FNCONSULTAPEDIDOSRH
RETURN rcgCursor;
  

FUNCTION FNCONSULTASPPI
RETURN PASRVCARGADATOS.rcgCursor;


PROCEDURE SPINSCONFIRMACIONSPPI( 
   paPais         IN  UNIFORMES.TADETALLEPEDIDOS.FIPAIS%TYPE
  ,paCanal        IN  UNIFORMES.TADETALLEPEDIDOS.FICANAL%TYPE
  ,paSucursal     IN  UNIFORMES.TADETALLEPEDIDOS.FISUCURSAL%TYPE
  ,paSKU          IN  UNIFORMES.TADETALLEPEDIDOS.FISKU%TYPE
  ,paEstatusAnt    IN UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE
  ,paActualizacion IN VARCHAR2 
  ,paPedido        IN  UNIFORMES.TADESCUENTOSSPPI.FIPEDIDO%TYPE
  ,paFolioCentral  IN  UNIFORMES.TADESCUENTOSSPPI.FIFOLIOCENTRAL%TYPE
  ,paEstatus       IN  UNIFORMES.TADESCUENTOSSPPI.FIESTATUS%TYPE 
  ,paPeticion      IN  UNIFORMES.TADESCUENTOSSPPI.FCPETICION%TYPE
  ,paRespuesta     IN  UNIFORMES.TADESCUENTOSSPPI.FCRESPUESTA%TYPE
  ,paFolioSPPI     IN  UNIFORMES.TADESCUENTOSSPPI.FIFOLIOSPPI%TYPE);


FUNCTION FNOBTIENEDESCEMPSAP
RETURN PASRVOPERAUNIFORMES.rcgCursor;


PROCEDURE SPINSERTACONFIRMACIONWSSAP( 
   paFolioCentral  IN  UNIFORMES.TADESCUENTOSXPEDIDOS.FIFOLIOCENTRAL%TYPE
  ,paPais         IN  UNIFORMES.TADESCUENTOSXPEDIDOS.FIPAIS%TYPE
  ,paCanal        IN  UNIFORMES.TADESCUENTOSXPEDIDOS.FICANAL%TYPE
  ,paSucursal     IN  UNIFORMES.TADESCUENTOSXPEDIDOS.FISUCURSAL%TYPE
  ,paPedido        IN  UNIFORMES.TADESCUENTOSXPEDIDOS.FIPEDIDO%TYPE
  ,paSKU          IN  UNIFORMES.TADESCUENTOSXPEDIDOS.FISKU%TYPE
  ,paReferencia     IN UNIFORMES.TADESCUENTOSXPEDIDOS.FCREFERENCIA%TYPE
  ,paEstatusPedidoAnt  IN UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE
  ,paActualizacion IN VARCHAR2 
  ,paEstatus       IN  UNIFORMES.TADESCUENTOSXPEDIDOS.FIESTATUS%TYPE  -- wsSapResp 
  ,paPeticion      IN  UNIFORMES.TADESCUENTOSXPEDIDOS.FCPETICION%TYPE
  ,paRespuesta     IN  UNIFORMES.TADESCUENTOSXPEDIDOS.FCRESPUESTA%TYPE );
  

PROCEDURE SPACTAVANCECARGASPPI(     paIdPais            IN UNIFORMES.TADETALLEPEDIDOS.FIPAIS%TYPE,
                                 paIdCanal           IN UNIFORMES.TADETALLEPEDIDOS.FICANAL%TYPE,
                                 paSucursal          IN UNIFORMES.TADETALLEPEDIDOS.FISUCURSAL%TYPE,
                                 paPedido            IN UNIFORMES.TADETALLEPEDIDOS.FIPEDIDO%TYPE,
                                 paFolioCentral      IN UNIFORMES.TADETALLEPEDIDOS.FIFOLIOCENTRAL%TYPE,
                                 paSKU               IN UNIFORMES.TADETALLEPEDIDOS.FISKU%TYPE,
                                 paEstatusAnterior   IN UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE,
                                 paFechActualizacion IN VARCHAR2,
                                 paPorcentajeAvance  IN UNIFORMES.TADESCUENTOSSPPI.FIPORCENTAJEAVANCE%TYPE,
                                 paFolioSPPI         IN UNIFORMES.TADESCUENTOSSPPI.FIFOLIOSPPI%TYPE,
                                 paStatusServicio    IN NUMBER,
                                 paPeticion          IN CLOB,
                                 paRespuesta         IN CLOB);

  FUNCTION FNCONSPARAMETROSSPPI(paEstatusDescuento UNIFORMES.TADESCUENTOSSPPI.FIESTATUS%TYPE,
                                paEstatusPedido    UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE)
    RETURN rcgCursor;

  PROCEDURE SPDETALLECARGASPPI(paIdPais            IN UNIFORMES.TADESCUENTOSSPPI.FIPAIS%TYPE,
                               paIdCanal           IN UNIFORMES.TADESCUENTOSSPPI.FICANAL%TYPE,
                               paSucursal          IN UNIFORMES.TADESCUENTOSSPPI.FISUCURSAL%TYPE,
                               paPedido            IN UNIFORMES.TADESCUENTOSSPPI.FIPEDIDO%TYPE,
                               paFolioCentral      IN UNIFORMES.TADESCUENTOSSPPI.FIFOLIOCENTRAL%TYPE,
                               paSKU               IN UNIFORMES.TADESCUENTOSSPPI.FISKU%TYPE,
                               paFolioSPPI         IN UNIFORMES.TADESCUENTOSSPPI.FIFOLIOSPPI%TYPE,
                               paDetalleError      IN UNIFORMES.TADESCUENTOSSPPI.FCDETALLEERROR%TYPE,
                               paEstatusAnterior   IN UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE,
                               paFechActualizacion IN VARCHAR2);

  PROCEDURE SPINSDESCTOSAP(paFolioCentral  IN UNIFORMES.TADESCUENTOSSAP.FIFOLIOCENTRAL%TYPE,
                           paPedido        IN UNIFORMES.TADESCUENTOSSAP.FIPEDIDO%TYPE,
                           paReferencia    IN UNIFORMES.TADESCUENTOSSAP.FCREFERENCIA%TYPE,
                           paSociedad      IN UNIFORMES.TADESCUENTOSSAP.FCSOCIEDAD%TYPE,
                           paCcnomina      IN UNIFORMES.TADESCUENTOSSAP.FCCCNOMINA%TYPE,
                           paTotdescuento  IN UNIFORMES.TADESCUENTOSSAP.FNTOTDESCUENTO%TYPE,
                           paFechaPago     IN VARCHAR2,
                           paSemaDescuento IN UNIFORMES.TADESCUENTOSSAP.FISEMADESCUENTO%TYPE,
                           paSaldo         IN UNIFORMES.TADESCUENTOSSAP.FNSALDO%TYPE,
                           paPago          IN UNIFORMES.TADESCUENTOSSAP.FNPAGO%TYPE);
  
  
END PASRVOPERAUNIFORMES;
/

SHOW ERRORS;


CREATE OR REPLACE PACKAGE           PASRVCARGADATOS
AS
/*************************************************************
   Proyecto:                       Uniformes 
   Descripcion:                    Paquete para Crones De uniformes
   Parametros de entrada:          Todos los campos que expone SAP
   Parametros de salida:           No aplica
   Parametros de entrada-salida    No aplica
   Precondiciones:                 Tener creado el esquema
   Creador:                        Laura Garcia
   Fecha de creacion:             13 JUNIO 2014
********************************************************************/
   
   TYPE rcgCursor IS REF CURSOR; -- Cursor por referencia


PROCEDURE SPINSEMPLEADOS (
    paEmpleadoNum           IN      UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE
   ,paEmpleadoNombre        IN      UNIFORMES.TAEMPLEADOS.FCNOMBRE%TYPE
   ,paGenero                IN      UNIFORMES.TAEMPLEADOS.FCGENERO%TYPE
   ,paPosicion              IN      UNIFORMES.TAEMPLEADOS.FIPOSICION%TYPE
   ,paPosicionDesc          IN      UNIFORMES.TAEMPLEADOS.FCPOSICION%TYPE
   ,paSituacion             IN      UNIFORMES.TAEMPLEADOS.FCSITUACION%TYPE
   ,paFuncion               IN      UNIFORMES.TAEMPLEADOS.FIFUNCION%TYPE
   ,paCeco                  IN      UNIFORMES.TAEMPLEADOS.FICECO%TYPE  
   ,paCecoDesc              IN      UNIFORMES.TAEMPLEADOS.FCCECO%TYPE
   ,paPais                  IN      UNIFORMES.TAEMPLEADOS.FCPAIS%TYPE
   ,paFecIngreso            IN      VARCHAR2
   ,paFecBaja               IN      VARCHAR2
   ,paFecAnterior           IN      VARCHAR2
   ,paFecMovimiento         IN      VARCHAR2 );


PROCEDURE SPINSERTACECO
   (paCC      IN     UNIFORMES.TACECO.FICC%TYPE
   ,paN1      IN     UNIFORMES.TACECO.FCN1%TYPE
   ,paN2      IN     UNIFORMES.TACECO.FCN2%TYPE
   ,paN3      IN     UNIFORMES.TACECO.FCN3%TYPE
   ,paN4      IN     UNIFORMES.TACECO.FCN4%TYPE
   ,paN5      IN     UNIFORMES.TACECO.FCN5%TYPE
   ,paN6      IN     UNIFORMES.TACECO.FCN6%TYPE
   ,paN7      IN     UNIFORMES.TACECO.FCN7%TYPE
   ,paN8      IN     UNIFORMES.TACECO.FCN8%TYPE
   ,paN9      IN     UNIFORMES.TACECO.FCN9%TYPE
   ,paN10     IN     UNIFORMES.TACECO.FCN10%TYPE
   ,paN11     IN     UNIFORMES.TACECO.FCN11%TYPE
   ,paN12     IN     UNIFORMES.TACECO.FCN12%TYPE
   ,paN13     IN     UNIFORMES.TACECO.FCN13%TYPE
   ,paNumeco       IN     UNIFORMES.TACECO.FINUMECO%TYPE
   ,paNombre       IN     UNIFORMES.TACECO.FCNOMBRE%TYPE
   ,paIdCCPadre    IN     UNIFORMES.TACECO.FCIDCCPADRE%TYPE
   ,paNombrePadre  IN     UNIFORMES.TACECO.FCNOMBREPADRE%TYPE
   ,paIdentidad    IN     UNIFORMES.TACECO.FIIDENTIDAD%TYPE
   ,paNombreEntidad  IN     UNIFORMES.TACECO.FCNOMBREENTIDAD%TYPE
   ,paIdCanal        IN     UNIFORMES.TACECO.FCIDCANAL%TYPE
   ,paCanal          IN     UNIFORMES.TACECO.FCCANAL%TYPE
   ,paColor          IN     UNIFORMES.TACECO.FCCOLOR%TYPE
   ,paTipoCanal      IN     UNIFORMES.TACECO.FCTIPOCANAL%TYPE
   ,paIdTipoOp       IN     UNIFORMES.TACECO.FIIDTIPOOP%TYPE
   ,paTipoCentro     IN     UNIFORMES.TACECO.FCTIPOCENTRO%TYPE
   ,paNivel          IN     UNIFORMES.TACECO.FINIVEL%TYPE
   ,paEstatus         IN     UNIFORMES.TACECO.FIESTATUS%TYPE
   ,paEstatusDesc     IN     UNIFORMES.TACECO.FCESTATUSDESC%TYPE
   ,paIdPais         IN     UNIFORMES.TACECO.FIPAIS%TYPE
   ,paPais           IN     UNIFORMES.TACECO.FCPAIS%TYPE
   ,paIdResp         IN     UNIFORMES.TACECO.FIIDRESP%TYPE
   ,paNombreResp     IN     UNIFORMES.TACECO.FCNOMBRERESP%TYPE
   ,paIdGuncorp      IN     UNIFORMES.TACECO.FIIDGUNCORP%TYPE
   ,paGuncorp        IN     UNIFORMES.TACECO.FCGUNCORP%TYPE
   ,paIdDireccionRH  IN     UNIFORMES.TACECO.FIIDDIRECCIONRH%TYPE
   ,paDireccionRH    IN     UNIFORMES.TACECO.FCDIRECCIONRH%TYPE
   ,paIdAreaRH       IN     UNIFORMES.TACECO.FIIDAREARH%TYPE
   ,paAreaRH         IN     UNIFORMES.TACECO.FCAREARH%TYPE
   ,paTipoSucursal   IN     UNIFORMES.TACECO.FCTIPOSUCURSAL%TYPE
   ,paNomTipoSucursal  IN     UNIFORMES.TACECO.FCNOMTIPOSUCURSAL%TYPE);
   

PROCEDURE SPACTUALIZASUCURSAL( 
   paSucursalID   IN  UNIFORMES.TASUCURSALES.FISUCURSAL%TYPE
  ,paSucursalDesc IN  UNIFORMES.TASUCURSALES.FCDESCRIPCION%TYPE
  ,paDireccionIP  IN  UNIFORMES.TASUCURSALES.FCDIRIP%TYPE);
    

PROCEDURE SPCONSULTADATOSPEDIDOUNIFORMES(
   paNumEmpleado   IN    UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE
  ,paCurPedidoActual OUT rcgCursor );
   

PROCEDURE SPCONSULTAPRECSKU(
   paSku  IN   INT
  ,paCurPedidoActual OUT rcgCursor );
  
PROCEDURE SPACTUALIZACD (paCD           IN      UNIFORMES.TASUCURSALES.FIIDCDISTRIBUCION%TYPE
                        ,paTiendas      IN      UNIFORMES.TASUCURSALES.FISUCURSAL%TYPE);
         
        
END PASRVCARGADATOS;
/

SHOW ERRORS;


CREATE OR REPLACE PACKAGE BODY           PAWSUNIFORMES
AS
/*************************************************************
   Proyecto:                       Uniformes 
   Descripcion:                    Paquete para Crones De uniformes
   Parametros de entrada:          Todos los campos que expone SAP
   Parametros de salida:           No aplica
   Parametros de entrada-salida    No aplica
   Precondiciones:                 Tener creado el esquema
   Creador:                     Laura Garcia Martinez
   Fecha de creacion:             17 JUNIO 2014
********************************************************************/

  csgCero  NUMBER(1):= 0;

 PROCEDURE SPCONSULTAEMPLEADOCARGA(
   paNumEmpleado   IN    UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE
   ,paCurPedidoActual OUT rcgCursor )
IS      
/********************************************************************************
   Descripcion: procedimiento consulta empleado pedido  que regresa los datos 
   Parámetros de entrada: paNumEmpleado
   Parámetros de salida: paCurPedidoActual
   Parámetros de entrada-salida: Ninguno
   Valor de retorno: Cursor con resultado.
   Creador: Laura Garcia Martinez
   Fecha de creación: 27 JUNIO 2014
**************************************************************************************/
      
   vlSituacion          UNIFORMES.TAEMPLEADOS.FCSITUACION%TYPE:= 'A';  -- Activo
   vlTipoSemestral      UNIFORMES.TAPEDIDOS.FITIPO%TYPE := 2;   -- Carga Semestral
    
BEGIN
   OPEN paCurPedidoActual FOR 
      SELECT  EMP.FIEMPLEADO 
            , EMP.FCNOMBRE
            , EMP.FCPOSICION
            , EMP.FCGENERO
            , TPROD.FCDESCRIPCION  DESCPROD 
            , PR.FITIPO   --TIPO DE PRENDA
            , PR.FITALLA   
        FROM  UNIFORMES.TAEMPLEADOS EMP 
  INNER JOIN  UNIFORMES.TAPEDIDOS P
          ON (EMP.FIEMPLEADO =  P.FIEMPLEADO) 
  INNER JOIN UNIFORMES.TADETALLEPEDIDOS  DP 
          ON (P.FIFOLIOCENTRAL = DP.FIFOLIOCENTRAL )  
  INNER JOIN UNIFORMES.TAPRODUCTOS PR
          ON (DP.FISKU = PR.FISKU)
  INNER JOIN UNIFORMES.TATIPOSPRODUCTO TPROD
          ON (PR.FITIPO = TPROD.FITIPO)
       WHERE EMP.FCSITUACION = vlSituacion    
         AND P.FITIPO = vlTipoSemestral  
         AND P.FIEMPLEADO = paNumEmpleado;         
  
END SPCONSULTAEMPLEADOCARGA;
   
 
PROCEDURE  SPGRABAPEDIDO(
    paIdEmpleado         IN   UNIFORMES.TAPEDIDOS.FIEMPLEADO%TYPE
   ,paEstadoGral         IN   UNIFORMES.TAPEDIDOS.FIESTADOGENERAL%TYPE
   ,paTipo               IN   UNIFORMES.TAPEDIDOS.FITIPO%TYPE
   ,paEmpleadoSolicita   IN   UNIFORMES.TAPEDIDOS.FIEMPLEADOSOLICITA%TYPE
   ,paFuncion            IN   UNIFORMES.TAPEDIDOS.FIFUNCION%TYPE
   ,paFolioCentral       OUT  UNIFORMES.TAPEDIDOS.FIFOLIOCENTRAL%TYPE )
IS
/********************************************************************************
   Descripcion: Procedimiento que graba el pedido 
   Parámetros de entrada:paIdEmpleado, paEstadoGral, paTipo, paEmpleadoSolicita, pafuncion
   Parámetros de salida: paFolioCentral 
   Parámetros de entrada-salida: Ninguno
   Valor de retorno: 
   * En el flujo completo solo grabará 1 vez al empleado por la carga semestral
    en individual puede grabar tantos pedidos quiera y 1 pedido por empleado desde Tienda Escuela
   Creador: Laura Garcia Martinez
   Fecha de creación: 19 JUNIO 2014
**************************************************************************************/  
     
    vlFechaRegistro       UNIFORMES.TAPEDIDOS.FDREGISTRO%TYPE := SYSDATE;
    vlIdCarga             UNIFORMES.TACARGAS.FIIDCARGA%TYPE:= 0;
    vlTipoSemestral       UNIFORMES.TAPEDIDOS.FITIPO%TYPE := 2;   -- Carga Semestral
    vlTipoFormador        UNIFORMES.TAPEDIDOS.FITIPO%TYPE := 3;   -- Carga Semestral
    vlValida              NUMBER(3) := 0;
    vlError               NUMBER(5):= -20001;
    cslActivo             UNIFORMES.TACARGAS.FIESTATUS%TYPE:= 1;
    cslDos                NUMBER(1):= 2;
    
BEGIN
    
    IF (paTipo=cslDos) THEN   -- SEMESTRAL
      SELECT FIIDCARGA
        INTO vlIdCarga
        FROM UNIFORMES.TACARGAS
       WHERE FIESTATUS = cslActivo;
    END IF;
    
    SELECT COUNT(ROWID)
      INTO vlValida
      FROM UNIFORMES.TAPEDIDOS
     WHERE FITIPO IN(vlTipoSemestral, vlTipoFormador)  -- Tipo formador 
       AND FIIDCARGA IN (vlIdCarga, csgCero)
       AND FIEMPLEADO = paIdEmpleado
       AND TRUNC(FDREGISTRO) = TRUNC(SYSDATE);
    
    IF (vlValida = 0)
    THEN
       INSERT INTO UNIFORMES.TAPEDIDOS( FIFOLIOCENTRAL
                                      , FIEMPLEADO
                                      , FIESTADOGENERAL
                                      , FITIPO
                                      , FIIDCARGA
                                      , FIEMPLEADOSOLICITA
                                      , FIFUNCION
                                      , FDREGISTRO)
                               VALUES ( UNIFORMES.SEWSGRABAPEDIDO.nextval
                                      , paIdEmpleado
                                      , paEstadoGral
                                      , paTipo
                                      , vlIdCarga
                                      , paEmpleadoSolicita
                                      , paFuncion
                                      , vlFechaRegistro ) returning FIFOLIOCENTRAL into paFolioCentral;
    ELSE 
       Raise_Application_Error ( vlError, 'YA SOLICITO EL PEDIDO PREVIAMENTE.');
    END IF;
   

END SPGRABAPEDIDO;


PROCEDURE SPGRABADETPEDIDO(
    paPais             IN    UNIFORMES.TADETALLEPEDIDOS.FIPAIS%TYPE
   ,paCanal            IN    UNIFORMES.TADETALLEPEDIDOS.FICANAL%TYPE
   ,paSucursal         IN    UNIFORMES.TADETALLEPEDIDOS.FISUCURSAL%TYPE 
   ,paPedido           IN    UNIFORMES.TADETALLEPEDIDOS.FIPEDIDO%TYPE
   ,paFolioCentral     IN    UNIFORMES.TADETALLEPEDIDOS.FIFOLIOCENTRAL%TYPE
   ,paSKU              IN    UNIFORMES.TADETALLEPEDIDOS.FISKU%TYPE
   ,paCantidad         IN    UNIFORMES.TADETALLEPEDIDOS.FICANTIDAD%TYPE 
   ,paEstatus          IN    UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE
   ,paCosto            IN    UNIFORMES.TADETALLEPEDIDOS.FNCOSTO%TYPE
   ,paDescuento        IN    UNIFORMES.TADETALLEPEDIDOS.FNDESCUENTO%TYPE )
IS
/********************************************************************************
   Descripcion: Función que regresa los datos 
   Parámetros de entrada: paPais, paCanal, paSucursal, paPedido, paFolioCentral
                        , paSKU, paCantidad, paEstatus, paCosto, paDescuento
   Parámetros de salida: No aplica
   Parámetros de entrada-salida: Ninguno
   Valor de retorno: Cursor con resultado.
   Creador: Laura Garcia Martinez
   Fecha de creación: 11 jul 2014
**************************************************************************************/  
     vlFecha              UNIFORMES.TADETALLEPEDIDOS.FDACTUALIZACION%TYPE := SYSDATE;
     vlGerenteEntrega     UNIFORMES.TADETALLEPEDIDOS.FIGERENTEENTREGA%TYPE:=0; 
   
     
BEGIN
    
    INSERT INTO UNIFORMES.TADETALLEPEDIDOS( FIFOLIOCENTRAL
                                          , FIPAIS
                                          , FICANAL
                                          , FISUCURSAL
                                          , FIPEDIDO
                                          , FISKU
                                          , FICANTIDAD
                                          , FIESTATUS
                                          , FNCOSTO
                                          , FNDESCUENTO
                                          , FIGERENTEENTREGA
                                          , FDACTUALIZACION ) 
                                   VALUES ( paFolioCentral
                                          , paPais
                                          , paCanal 
                                          , paSucursal
                                          , paPedido
                                          , paSKU
                                          , paCantidad
                                          , paEstatus
                                          , paCosto 
                                          , paDescuento
                                          , vlGerenteEntrega
                                          , vlFecha);
                                          

END SPGRABADETPEDIDO;
   

PROCEDURE  SPPEDIDOSPENDIENTESABASTO(
   paCurPendientesAb     OUT    rcgCursor )
IS
/********************************************************************************
   Descripcion: Función que regresa los datos 
   Parámetros de entrada: No aplica
   Parámetros de salida: paCurPendientesAb
   Parámetros de entrada-salida: Ninguno
   Valor de retorno: Cursor con resultado.
   Creador: Laura Garcia Martinez
   Fecha de creación: 19 JUNIO 2014
**************************************************************************************/  

   vlEstatus      UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE:= 30;  -- ENVIADO A TDA
   vlTipo         UNIFORMES.TAPEDIDOS.FITIPO%TYPE:= 2;  --SEMESTRAL
   
BEGIN
   
   OPEN paCurPendientesAb FOR
    SELECT P.FIEMPLEADO
         , P.FIESTADOGENERAL
         , P.FITIPO
         , P.FIEMPLEADOSOLICITA
         , P.FDREGISTRO
         , DP.FIPAIS
         , DP.FICANAL
         , DP.FISUCURSAL
         , DP.FIPEDIDO
         , DP.FIFOLIOCENTRAL
         , DP.FISKU
         , DP.FICANTIDAD
         , DP.FIESTATUS
         , DP.FNCOSTO
         , DP.FNDESCUENTO
         , TO_CHAR(DP.FDACTUALIZACION,'DD/MM/YYYY HH24:MI:SS')  AS FDACTUALIZACION   
   FROM UNIFORMES.TAPEDIDOS P 
   INNER JOIN UNIFORMES.TADETALLEPEDIDOS  DP 
    ON ( P.FIFOLIOCENTRAL = DP.FIFOLIOCENTRAL )  
   WHERE P.FITIPO = vlTipo
    AND DP.FIESTATUS = vlEstatus;  
   
     
END SPPEDIDOSPENDIENTESABASTO;


PROCEDURE SPCONSULTAEMPLEADOSOLICITUD(
    paTienda        IN    VARCHAR2
   ,paCurSolicitud  OUT   rcgCursor)
IS
/********************************************************************************
   Descripcion: Función que regresa los uniformes de los empleados de una sucursal
                en especifico, la solicitud la realiza el Gerente de la tienda
   Parámetros de entrada: paTienda
   Parámetros de salida: paCurSolicitud
   Parámetros de entrada-salida: Ninguno
   Valor de retorno: Cursor con resultado.
   Creador: Laura Garcia Martinez
   Fecha de creación: 23 JUNIO 2014
**************************************************************************************/  
   vlTienda          VARCHAR2(10):='';
   vlTienda2         VARCHAR2(10):='';
   vlTienda3         VARCHAR2(10):='';  
   vlTienda5         VARCHAR2(10):='';
   vlTienda6         VARCHAR2(10):='';
   vlSituacion       UNIFORMES.TAEMPLEADOS.FCSITUACION%TYPE:= 'A';  -- Activo
   vlGeneroU         UNIFORMES.TAPRODUCTOS.FCGENERO%TYPE:= 'U';  -- Unisex       
   vlTipoSemestral   UNIFORMES.TAPEDIDOS.FITIPO%TYPE := 2;   -- Carga Semestral
   vlTipoFormador    UNIFORMES.TAPEDIDOS.FITIPO%TYPE := 3;   -- Carga Semestral
   vlIdCarga         UNIFORMES.TACARGAS.FIIDCARGA%TYPE:= 0;
   vlFecIni          UNIFORMES.TACARGAS.FDFECHAFINAL%TYPE;
   vlFecFin          UNIFORMES.TACARGAS.FDFECHAFINAL%TYPE;
   vlFechaActual     UNIFORMES.TACARGAS.FDFECHAFINAL%TYPE; 
   cslActivo         UNIFORMES.TACARGAS.FIESTATUS%TYPE:= 1;
   vlNoDatos         NUMBER(5):= -20001;
   vlConteo          NUMBER(10):= 0;
   vlDiasAntiguedad  NUMBER(1) := 4;
   vlDosMeses        NUMBER(1) := 2;
BEGIN
   vlTienda := '52' || paTienda;
   vlTienda2 := '80' || paTienda;
   vlTienda3 := '50' || paTienda;
   vlTienda5 := '64' || paTienda;
   vlTienda6 := '79' || paTienda;
   
   SELECT FIIDCARGA
         ,TRUNC(FDFECHAINICIAL)
         ,TRUNC(FDFECHAFINAL)
         ,TRUNC(SYSDATE)
     INTO vlIdCarga
         ,vlFecIni
         ,vlFecFin
         ,vlFechaActual
     FROM UNIFORMES.TACARGAS
    WHERE FIESTATUS = cslActivo; 
    
   IF ( vlFechaActual BETWEEN vlFecIni  AND  vlFecFin ) THEN
       SELECT COUNT(1)
         INTO vlConteo
         FROM UNIFORMES.TAEMPLEADOS EMP
        INNER JOIN UNIFORMES.TACECO CECO
                ON (EMP.FICECO = CECO.FICC)
        INNER JOIN UNIFORMES.TAFUNCIONES FUN
                ON (FUN.FIFUNCIONSAP = EMP.FIFUNCION AND TRIM(CECO.FCIDCANAL)=TRIM(FUN.FCIDCANAL))
        INNER JOIN UNIFORMES.TAKITS KIT
                ON (KIT.FIKIT = FUN.FIKIT)
        INNER JOIN UNIFORMES.TAPRODUCTOSXKIT PXKIT
                ON (KIT.FIKIT = PXKIT.FIKIT)
        INNER JOIN UNIFORMES.TAPRODUCTOS PROD
                ON (PXKIT.FISKU = PROD.FISKU)
        INNER JOIN UNIFORMES.TATIPOSPRODUCTO TPROD
                ON (PROD.FITIPO = TPROD.FITIPO)
        INNER JOIN UNIFORMES.TATALLAS TALLA
                ON (PROD.FITALLA = TALLA.FITALLA)
              WHERE EMP.FICECO IN (TO_NUMBER(vlTienda), TO_NUMBER(vlTienda2), TO_NUMBER(vlTienda3), TO_NUMBER(vlTienda5), TO_NUMBER(vlTienda6) )
               AND EMP.FCSITUACION = vlSituacion    
               AND (PROD.FCGENERO = EMP.FCGENERO OR PROD.FCGENERO = vlGeneroU )  
               AND EMP.FIEMPLEADO NOT IN (SELECT FIEMPLEADO           -- Menos los empleados que ya solicitaron su pedido
                                            FROM UNIFORMES.TAPEDIDOS
                                           WHERE FITIPO IN( vlTipoSemestral, vlTipoFormador)
                                             AND FIIDCARGA IN (vlIdCarga)
                                           UNION 
                                          SELECT FIEMPLEADO     
                                            FROM UNIFORMES.TAPEDIDOS
                                           WHERE FITIPO IN( vlTipoSemestral, vlTipoFormador) 
                                             AND FIIDCARGA IN (csgCero)
                                             AND FDREGISTRO > ADD_MONTHS(SYSDATE,-vlDosMeses)
                                         ) 
              AND EMP.FDINGRESO <= SYSDATE-vlDiasAntiguedad;
       IF (vlConteo > 0)
        THEN
              OPEN paCurSolicitud  FOR
            SELECT EMP.FIEMPLEADO 
                 , EMP.FCNOMBRE                 
                 , EMP.FCPOSICION
                 , EMP.FCGENERO
                 , TPROD.FCDESCRIPCION  DESCPROD
                 , TALLA.FCCLAVE
                 , TALLA.FITALLA
                 , PROD.FNCOSTO   
                 , PROD.FNDESCUENTO   
                 , EMP.FIFUNCION    
                 , CECO.FCIDCANAL AS FIUNIDADNEGOCIO
                 , PROD.FITIPO    
                 , PROD.FISKU 
                 , TALLA.FCDESCRIPCION
              FROM  UNIFORMES.TAEMPLEADOS EMP
        INNER JOIN UNIFORMES.TACECO CECO
                ON (EMP.FICECO = CECO.FICC)
        INNER JOIN UNIFORMES.TAFUNCIONES FUN
                ON (FUN.FIFUNCIONSAP = EMP.FIFUNCION AND TRIM(CECO.FCIDCANAL)=TRIM(FUN.FCIDCANAL))
        INNER JOIN UNIFORMES.TAKITS KIT
                ON (KIT.FIKIT = FUN.FIKIT)
        INNER JOIN UNIFORMES.TAPRODUCTOSXKIT PXKIT
                ON (KIT.FIKIT = PXKIT.FIKIT)
        INNER JOIN UNIFORMES.TAPRODUCTOS PROD
                ON (PXKIT.FISKU = PROD.FISKU)
        INNER JOIN UNIFORMES.TATIPOSPRODUCTO TPROD
                ON (PROD.FITIPO = TPROD.FITIPO)
        INNER JOIN UNIFORMES.TATALLAS TALLA
                ON (PROD.FITALLA = TALLA.FITALLA)
              WHERE EMP.FICECO IN (TO_NUMBER(vlTienda), TO_NUMBER(vlTienda2), TO_NUMBER(vlTienda3), TO_NUMBER(vlTienda5), TO_NUMBER(vlTienda6) )
               AND EMP.FCSITUACION = vlSituacion    
               AND (PROD.FCGENERO = EMP.FCGENERO OR PROD.FCGENERO = vlGeneroU )  
               AND EMP.FIEMPLEADO NOT IN (SELECT FIEMPLEADO      -- Menos los empleados que ya solicitaron su pedido
                                            FROM UNIFORMES.TAPEDIDOS
                                           WHERE FITIPO IN( vlTipoSemestral  , vlTipoFormador)
                                             AND FIIDCARGA IN (vlIdCarga)
                                           UNION 
                                          SELECT FIEMPLEADO     
                                            FROM UNIFORMES.TAPEDIDOS
                                           WHERE FITIPO IN( vlTipoSemestral, vlTipoFormador)
                                             AND FIIDCARGA IN (csgCero)
                                             AND FDREGISTRO > ADD_MONTHS(SYSDATE,-vlDosMeses)
                                          )
              AND EMP.FDINGRESO <= SYSDATE-vlDiasAntiguedad
          ORDER BY EMP.FIEMPLEADO, DESCPROD, FITALLA;
       ELSE
           Raise_Application_Error ( vlNoDatos, 'No se encontraron datos para esta solicitud o ya cuenta con pedidos solicitados.');
        END IF;
          
   ELSE
       Raise_Application_Error ( vlNoDatos, 'El sistema no esta disponible en este Periodo.');
   END IF;

   
END SPCONSULTAEMPLEADOSOLICITUD;



PROCEDURE SPSOLICITUDFORMADOR(
   paIdEmpleado     IN    UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE
   ,paCurSolicitud  OUT   rcgCursor)
IS
/***********************************************************************************
   Descripcion: Procedimiento que regresa los datos de uniformes para los empleados
                de nuevo ingreso, la solicitud la realiza el FORMADOR o GERENTE
   Parámetros de entrada:  paIdEmpleado
   Parámetros de salida: paCurSolicitud
   Parámetros de entrada-salida: Ninguno
   Valor de retorno: Cursor con resultado.
   Creador:  Laura Garcia Martinez
   Fecha de creación: 9 JULIO 2014
***************************************************************************************/  
 
   vlSituacion         UNIFORMES.TAEMPLEADOS.FCSITUACION%TYPE:= 'A';  -- Activo
   vlGeneroU           UNIFORMES.TAPRODUCTOS.FCGENERO%TYPE:= 'U';  -- Unisex       
   vlTipoSemestral     UNIFORMES.TAPEDIDOS.FITIPO%TYPE := 2;   -- Carga Semestral
   vlTipoFormador      UNIFORMES.TAPEDIDOS.FITIPO%TYPE := 3;   -- Carga Semestral
   vlFuncionEmpleado   UNIFORMES.TAEMPLEADOS.FIFUNCION%TYPE:=0;
   vlSucursal          VARCHAR2(6):='';
   vlFunFormador       UNIFORMES.TAEMPLEADOS.FIFUNCION%TYPE:= 8041; -- Formador
   vlFuNuevaFormador   UNIFORMES.TAEMPLEADOS.FIFUNCION%TYPE:= 8030; -- Formador
   vlFunGerente        UNIFORMES.TAEMPLEADOS.FIFUNCION%TYPE:= 8035; -- Gerente
   vlFunSubGerente     UNIFORMES.TAEMPLEADOS.FIFUNCION%TYPE:= 8034; -- Subgerente
   vlCeCo              UNIFORMES.TAEMPLEADOS.FICECO%TYPE := 0;
   vlNoDatos           NUMBER(5):= -20001;
   vlConFormador       NUMBER(5):= -20002;
   vlIdCarga           UNIFORMES.TACARGAS.FIIDCARGA%TYPE:= 0;
   cslActivo           UNIFORMES.TACARGAS.FIESTATUS%TYPE:= 1;
   vlConteo            NUMBER(10):= 0;
   vlTres              NUMBER(1):= 3;
   vlCuatro            NUMBER(1):= 4;
   vlCero              NUMBER(1):= 0;
   vlDiasAntiguedad    NUMBER(1) := 4;
   vlDosMeses          NUMBER(1) := 2;
   vlDiasLimite        NUMBER(2) := 12;
   
BEGIN

    SELECT FIIDCARGA
     INTO vlIdCarga
     FROM UNIFORMES.TACARGAS
    WHERE FIESTATUS = cslActivo; 

    SELECT FIFUNCION 
          ,SUBSTR(FICECO, vlTres, vlCuatro) AS SUCURSAL 
          ,FICECO 
      INTO vlFuncionEmpleado
          ,vlSucursal 
          ,vlCeCo
     FROM UNIFORMES.TAEMPLEADOS
    WHERE FIEMPLEADO = paIdEmpleado;  
      
    
     IF ((vlFuncionEmpleado = vlFunFormador) OR (vlFuncionEmpleado = vlFuNuevaFormador) ) THEN   -- Opcion Formador
         SELECT COUNT(1)
           INTO vlConteo 
           FROM UNIFORMES.TAEMPLEADOS EMP
          INNER JOIN UNIFORMES.TACECO CECO
                  ON (EMP.FICECO = CECO.FICC)
          INNER JOIN UNIFORMES.TAFUNCIONES FUN
                  ON (FUN.FIFUNCIONSAP = EMP.FIFUNCION AND TRIM(CECO.FCIDCANAL)=TRIM(FUN.FCIDCANAL))
          INNER JOIN UNIFORMES.TAKITS KIT
                  ON (KIT.FIKIT = FUN.FIKIT)
          INNER JOIN UNIFORMES.TAPRODUCTOSXKIT PXKIT
                  ON (KIT.FIKIT = PXKIT.FIKIT)
          INNER JOIN UNIFORMES.TAPRODUCTOS PROD
                  ON (PXKIT.FISKU = PROD.FISKU)
          INNER JOIN UNIFORMES.TATIPOSPRODUCTO TPROD
                  ON (PROD.FITIPO = TPROD.FITIPO)
          INNER JOIN UNIFORMES.TATALLAS TALLA
                  ON (PROD.FITALLA = TALLA.FITALLA)
          INNER JOIN (SELECT TO_NUMBER('52'|| LPAD (TO_CHAR(FISUCURSAL),vlCuatro ,vlCero)) AS SUC  -- Lista de Sucursales x Formador
                     FROM UNIFORMES.TASUCURSALES
                    WHERE FIIDFORMADOR = paIdEmpleado
                    UNION  ALL
                    SELECT TO_NUMBER('80'|| LPAD (TO_CHAR(FISUCURSAL),vlCuatro ,vlCero)) AS SUC  -- Lista de Sucursales x Formador
                     FROM UNIFORMES.TASUCURSALES
                    WHERE FIIDFORMADOR = paIdEmpleado
                    UNION ALL
                    SELECT TO_NUMBER('50'|| LPAD (TO_CHAR(FISUCURSAL),vlCuatro ,vlCero)) AS SUC  -- Lista de Sucursales x Formador
                     FROM UNIFORMES.TASUCURSALES
                    WHERE FIIDFORMADOR = paIdEmpleado
                    UNION ALL
                    SELECT TO_NUMBER('64'|| LPAD (TO_CHAR(FISUCURSAL),vlCuatro ,vlCero)) AS SUC  -- Lista de Sucursales x Formador
                     FROM UNIFORMES.TASUCURSALES
                    WHERE FIIDFORMADOR = paIdEmpleado
                    UNION ALL
                    SELECT TO_NUMBER('79'|| LPAD (TO_CHAR(FISUCURSAL),vlCuatro ,vlCero)) AS SUC  -- Lista de Sucursales x Formador
                     FROM UNIFORMES.TASUCURSALES
                    WHERE FIIDFORMADOR = paIdEmpleado) DATOS
                 ON (EMP.FICECO = DATOS.SUC)
                 WHERE EMP.FCSITUACION =  vlSituacion
                 AND (PROD.FCGENERO = EMP.FCGENERO OR PROD.FCGENERO = vlGeneroU )  
                 AND EMP.FIEMPLEADO NOT IN (SELECT FIEMPLEADO      -- Menos los empleados que ya solicitaron su pedido
                                              FROM UNIFORMES.TAPEDIDOS
                                             WHERE FITIPO IN( vlTipoSemestral  , vlTipoFormador)
                                               AND FIIDCARGA IN (vlIdCarga)
                                             UNION 
                                            SELECT FIEMPLEADO     
                                              FROM UNIFORMES.TAPEDIDOS
                                             WHERE FITIPO IN( vlTipoSemestral, vlTipoFormador)
                                               AND FIIDCARGA IN (csgCero)
                                               AND FDREGISTRO > ADD_MONTHS(SYSDATE,-vlDosMeses)
                                           )
                  AND TRUNC(EMP.FDINGRESO) BETWEEN TRUNC(SYSDATE-vlDiasLimite) AND TRUNC(SYSDATE-vlDiasAntiguedad);
        IF (vlConteo > vlCero)
        THEN
           OPEN paCurSolicitud FOR
              SELECT TO_NUMBER(SUBSTR(EMP.FICECO, vlTres, vlCuatro)) AS SUCURSAL
                   , EMP.FIEMPLEADO 
                   , EMP.FCNOMBRE
                   , EMP.FCPOSICION
                   , EMP.FCGENERO
                   , TPROD.FCDESCRIPCION  DESCPROD
                   , TALLA.FCCLAVE
                   , TALLA.FITALLA
                   , PROD.FNCOSTO   
                   , PROD.FNDESCUENTO   
                   , EMP.FIFUNCION    
                   , CECO.FCIDCANAL AS FIUNIDADNEGOCIO 
                   , PROD.FITIPO    
                   , PROD.FISKU 
                   , TALLA.FCDESCRIPCION
                FROM  UNIFORMES.TAEMPLEADOS EMP
          INNER JOIN UNIFORMES.TACECO CECO
                  ON (EMP.FICECO = CECO.FICC)
          INNER JOIN UNIFORMES.TAFUNCIONES FUN
                  ON (FUN.FIFUNCIONSAP = EMP.FIFUNCION AND TRIM(CECO.FCIDCANAL)=TRIM(FUN.FCIDCANAL))
          INNER JOIN UNIFORMES.TAKITS KIT
                  ON (KIT.FIKIT = FUN.FIKIT)
          INNER JOIN UNIFORMES.TAPRODUCTOSXKIT PXKIT
                  ON (KIT.FIKIT = PXKIT.FIKIT)
          INNER JOIN UNIFORMES.TAPRODUCTOS PROD
                  ON (PXKIT.FISKU = PROD.FISKU)
          INNER JOIN UNIFORMES.TATIPOSPRODUCTO TPROD
                  ON (PROD.FITIPO = TPROD.FITIPO)
          INNER JOIN UNIFORMES.TATALLAS TALLA
                  ON (PROD.FITALLA = TALLA.FITALLA)
          INNER JOIN (SELECT TO_NUMBER('52'|| LPAD (TO_CHAR(FISUCURSAL),vlCuatro , vlCero)) AS SUC  -- Lista de Sucursales x Formador
                     FROM UNIFORMES.TASUCURSALES
                    WHERE FIIDFORMADOR = paIdEmpleado
                    UNION  ALL
                    SELECT TO_NUMBER('80'|| LPAD (TO_CHAR(FISUCURSAL),vlCuatro , vlCero)) AS SUC  -- Lista de Sucursales x Formador
                     FROM UNIFORMES.TASUCURSALES
                    WHERE FIIDFORMADOR = paIdEmpleado
                    UNION ALL
                    SELECT TO_NUMBER('50'|| LPAD (TO_CHAR(FISUCURSAL),vlCuatro , vlCero)) AS SUC  -- Lista de Sucursales x Formador
                     FROM UNIFORMES.TASUCURSALES
                    WHERE FIIDFORMADOR = paIdEmpleado
                    UNION ALL
                    SELECT TO_NUMBER('64'|| LPAD (TO_CHAR(FISUCURSAL),vlCuatro , vlCero)) AS SUC  -- Lista de Sucursales x Formador
                     FROM UNIFORMES.TASUCURSALES
                    WHERE FIIDFORMADOR = paIdEmpleado
                    UNION ALL
                    SELECT TO_NUMBER('79'|| LPAD (TO_CHAR(FISUCURSAL),vlCuatro , vlCero)) AS SUC  -- Lista de Sucursales x Formador
                     FROM UNIFORMES.TASUCURSALES
                    WHERE FIIDFORMADOR = paIdEmpleado) DATOS
                 ON (EMP.FICECO = DATOS.SUC)
                 WHERE EMP.FCSITUACION =  vlSituacion
                 AND (PROD.FCGENERO = EMP.FCGENERO OR PROD.FCGENERO = vlGeneroU )  
                 AND EMP.FIEMPLEADO NOT IN (SELECT FIEMPLEADO      -- Menos los empleados que ya solicitaron su pedido
                                              FROM UNIFORMES.TAPEDIDOS
                                             WHERE FITIPO IN( vlTipoSemestral  , vlTipoFormador)
                                               AND FIIDCARGA IN (vlIdCarga)
                                             UNION 
                                            SELECT FIEMPLEADO     
                                              FROM UNIFORMES.TAPEDIDOS
                                             WHERE FITIPO IN( vlTipoSemestral, vlTipoFormador)
                                               AND FIIDCARGA IN (csgCero)
                                               AND FDREGISTRO > ADD_MONTHS(SYSDATE,-vlDosMeses)
                                           )
                 AND TRUNC(EMP.FDINGRESO) BETWEEN TRUNC(SYSDATE-vlDiasLimite) AND TRUNC(SYSDATE-vlDiasAntiguedad)
            ORDER BY EMP.FIEMPLEADO, DESCPROD, FITALLA;
        ELSE
           Raise_Application_Error ( vlNoDatos, 'No cuenta con Empleados Nuevos asignados.');
        END IF;
          
     ELSIF(vlFuncionEmpleado=vlFunGerente OR vlFuncionEmpleado=vlFunSubGerente) THEN   -- Gerente O Subgerente con Rol de Formador        
           SELECT COUNT(1)
             INTO vlConteo
             FROM UNIFORMES.TAEMPLEADOS EMP
       INNER JOIN UNIFORMES.TACECO CECO
               ON (EMP.FICECO = CECO.FICC)
       INNER JOIN UNIFORMES.TAFUNCIONES FUN
               ON (FUN.FIFUNCIONSAP = EMP.FIFUNCION AND TRIM(CECO.FCIDCANAL)=TRIM(FUN.FCIDCANAL))
       INNER JOIN UNIFORMES.TAKITS KIT
               ON (KIT.FIKIT = FUN.FIKIT)
       INNER JOIN UNIFORMES.TAPRODUCTOSXKIT PXKIT
               ON (KIT.FIKIT = PXKIT.FIKIT)
       INNER JOIN UNIFORMES.TAPRODUCTOS PROD
               ON (PXKIT.FISKU = PROD.FISKU)
       INNER JOIN UNIFORMES.TATIPOSPRODUCTO TPROD
               ON (PROD.FITIPO = TPROD.FITIPO)
       INNER JOIN UNIFORMES.TATALLAS TALLA
               ON (PROD.FITALLA = TALLA.FITALLA)
            WHERE EMP.FICECO IN ( '52'||SUBSTR(TO_CHAR(vlCeCo), vlTres, vlCuatro), '80'||SUBSTR(TO_CHAR(vlCeCo), vlTres, vlCuatro),
             '50'||SUBSTR(TO_CHAR(vlCeCo), vlTres, vlCuatro), '64'||SUBSTR(TO_CHAR(vlCeCo), vlTres, vlCuatro), '79'||SUBSTR(TO_CHAR(vlCeCo), vlTres, vlCuatro) )-- CECO del Gerente de tda
              AND EMP.FCSITUACION = vlSituacion
              AND (PROD.FCGENERO = EMP.FCGENERO OR PROD.FCGENERO = vlGeneroU )  
              AND EMP.FIEMPLEADO NOT IN (SELECT FIEMPLEADO      -- Menos los empleados que ya solicitaron su pedido
                                           FROM UNIFORMES.TAPEDIDOS
                                          WHERE FITIPO IN( vlTipoSemestral  , vlTipoFormador)
                                            AND FIIDCARGA IN (vlIdCarga)
                                          UNION 
                                         SELECT FIEMPLEADO     
                                           FROM UNIFORMES.TAPEDIDOS
                                          WHERE FITIPO IN( vlTipoSemestral, vlTipoFormador)
                                            AND FIIDCARGA IN (csgCero)
                                            AND FDREGISTRO > ADD_MONTHS(SYSDATE,-vlDosMeses)
                                        )
              AND TRUNC(EMP.FDINGRESO) BETWEEN TRUNC(SYSDATE-vlDiasLimite) AND TRUNC(SYSDATE-vlDiasAntiguedad); 
          
          IF(vlConteo > vlCero)
          THEN
              OPEN paCurSolicitud FOR
                 SELECT TO_NUMBER(SUBSTR(EMP.FICECO, vlTres, vlCuatro)) AS SUCURSAL
                      , EMP.FIEMPLEADO 
                      , EMP.FCNOMBRE
                      , EMP.FCPOSICION
                      , EMP.FCGENERO
                      , TPROD.FCDESCRIPCION  DESCPROD
                      , TALLA.FCCLAVE
                      , TALLA.FITALLA
                      , PROD.FNCOSTO   
                      , PROD.FNDESCUENTO   
                      , EMP.FIFUNCION    
                      , CECO.FCIDCANAL AS FIUNIDADNEGOCIO 
                      , PROD.FITIPO    
                      , PROD.FISKU 
                      , TALLA.FCDESCRIPCION
                   FROM UNIFORMES.TAEMPLEADOS EMP
             INNER JOIN UNIFORMES.TACECO CECO
                     ON (EMP.FICECO = CECO.FICC)
             INNER JOIN UNIFORMES.TAFUNCIONES FUN
                     ON (FUN.FIFUNCIONSAP = EMP.FIFUNCION AND TRIM(CECO.FCIDCANAL)=TRIM(FUN.FCIDCANAL))
             INNER JOIN UNIFORMES.TAKITS KIT
                     ON (KIT.FIKIT = FUN.FIKIT)
             INNER JOIN UNIFORMES.TAPRODUCTOSXKIT PXKIT
                     ON (KIT.FIKIT = PXKIT.FIKIT)
             INNER JOIN UNIFORMES.TAPRODUCTOS PROD
                     ON (PXKIT.FISKU = PROD.FISKU)
             INNER JOIN UNIFORMES.TATIPOSPRODUCTO TPROD
                     ON (PROD.FITIPO = TPROD.FITIPO)
             INNER JOIN UNIFORMES.TATALLAS TALLA
                     ON (PROD.FITALLA = TALLA.FITALLA)
                  WHERE EMP.FICECO IN ( '52'||SUBSTR(TO_CHAR(vlCeCo), vlTres, vlCuatro), '80'||SUBSTR(TO_CHAR(vlCeCo), vlTres, vlCuatro),
                   '50'||SUBSTR(TO_CHAR(vlCeCo), vlTres, vlCuatro), '64'||SUBSTR(TO_CHAR(vlCeCo), vlTres, vlCuatro), '79'||SUBSTR(TO_CHAR(vlCeCo), vlTres, vlCuatro) )-- CECO del Gerente de tda
                    AND EMP.FCSITUACION = vlSituacion
                    AND (PROD.FCGENERO = EMP.FCGENERO OR PROD.FCGENERO = vlGeneroU )  
                    AND EMP.FIEMPLEADO NOT IN (SELECT FIEMPLEADO      -- Menos los empleados que ya solicitaron su pedido
                                                 FROM UNIFORMES.TAPEDIDOS
                                                WHERE FITIPO IN( vlTipoSemestral  , vlTipoFormador)
                                                  AND FIIDCARGA IN (vlIdCarga)
                                                UNION 
                                               SELECT FIEMPLEADO     
                                                 FROM UNIFORMES.TAPEDIDOS
                                                WHERE FITIPO IN( vlTipoSemestral, vlTipoFormador)
                                                  AND FIIDCARGA IN (csgCero)
                                                  AND FDREGISTRO > ADD_MONTHS(SYSDATE,-vlDosMeses)
                                              )
                    AND TRUNC(EMP.FDINGRESO) BETWEEN TRUNC(SYSDATE-vlDiasLimite) AND TRUNC(SYSDATE-vlDiasAntiguedad)
               ORDER BY EMP.FIEMPLEADO, DESCPROD, FITALLA;
          ELSE
             Raise_Application_Error ( vlNoDatos, 'No cuenta con Empleados Nuevos asignados.');
          END IF;
     
     ELSE  --  Función del vendedor 8067     
        SELECT COUNT(1)
         INTO vlConteo
         FROM UNIFORMES.TAEMPLEADOS EMP
        INNER JOIN UNIFORMES.TACECO CECO
              ON (EMP.FICECO = CECO.FICC)
        INNER JOIN UNIFORMES.TAFUNCIONES FUN
              ON (FUN.FIFUNCIONSAP = EMP.FIFUNCION AND TRIM(CECO.FCIDCANAL)=TRIM(FUN.FCIDCANAL))
        INNER JOIN UNIFORMES.TAKITS KIT
              ON (KIT.FIKIT = FUN.FIKIT)
        INNER JOIN UNIFORMES.TAPRODUCTOSXKIT PXKIT
              ON (KIT.FIKIT = PXKIT.FIKIT)
        INNER JOIN UNIFORMES.TAPRODUCTOS PROD
              ON (PXKIT.FISKU = PROD.FISKU)
        INNER JOIN UNIFORMES.TATIPOSPRODUCTO TPROD
              ON (PROD.FITIPO = TPROD.FITIPO)
        INNER JOIN UNIFORMES.TATALLAS TALLA
              ON (PROD.FITALLA = TALLA.FITALLA)
            WHERE EMP.FIEMPLEADO = paIdEmpleado   
             AND (PROD.FCGENERO = EMP.FCGENERO OR PROD.FCGENERO = vlGeneroU )  
             AND EMP.FIEMPLEADO NOT IN (SELECT FIEMPLEADO      -- Menos los empleados que ya solicitaron su pedido
                                   FROM UNIFORMES.TAPEDIDOS
                                  WHERE FITIPO IN( vlTipoSemestral  , vlTipoFormador)
                                    AND FIIDCARGA IN (vlIdCarga)
                                  UNION 
                                 SELECT FIEMPLEADO     
                                   FROM UNIFORMES.TAPEDIDOS
                                  WHERE FITIPO IN( vlTipoSemestral, vlTipoFormador)
                                    AND FIIDCARGA IN (csgCero)
                                    AND FDREGISTRO > ADD_MONTHS(SYSDATE,-vlDosMeses)
                                 )
            AND TRUNC(EMP.FDINGRESO) BETWEEN TRUNC(SYSDATE-vlDiasLimite) AND TRUNC(SYSDATE-vlDiasAntiguedad);
            
         IF(vlConteo > vlCero)
         THEN
           OPEN paCurSolicitud FOR
              SELECT TO_NUMBER(SUBSTR(EMP.FICECO, vlTres, vlCuatro)) AS SUCURSAL
                   , EMP.FIEMPLEADO 
                   , EMP.FCNOMBRE
                   , EMP.FCPOSICION
                   , EMP.FCGENERO
                   , TPROD.FCDESCRIPCION  DESCPROD
                   , TALLA.FCCLAVE
                   , TALLA.FITALLA
                   , PROD.FNCOSTO   
                   , PROD.FNDESCUENTO   
                   , EMP.FIFUNCION    
                   , CECO.FCIDCANAL AS FIUNIDADNEGOCIO 
                   , PROD.FITIPO    
                   , PROD.FISKU 
                   , TALLA.FCDESCRIPCION
                FROM UNIFORMES.TAEMPLEADOS EMP
          INNER JOIN UNIFORMES.TACECO CECO
                  ON (EMP.FICECO = CECO.FICC)
          INNER JOIN UNIFORMES.TAFUNCIONES FUN
                  ON (FUN.FIFUNCIONSAP = EMP.FIFUNCION AND TRIM(CECO.FCIDCANAL)=TRIM(FUN.FCIDCANAL))
          INNER JOIN UNIFORMES.TAKITS KIT
                  ON (KIT.FIKIT = FUN.FIKIT)
          INNER JOIN UNIFORMES.TAPRODUCTOSXKIT PXKIT
                  ON (KIT.FIKIT = PXKIT.FIKIT)
          INNER JOIN UNIFORMES.TAPRODUCTOS PROD
                  ON (PXKIT.FISKU = PROD.FISKU)
          INNER JOIN UNIFORMES.TATIPOSPRODUCTO TPROD
                  ON (PROD.FITIPO = TPROD.FITIPO)
          INNER JOIN UNIFORMES.TATALLAS TALLA
                  ON (PROD.FITALLA = TALLA.FITALLA)
               WHERE EMP.FIEMPLEADO = paIdEmpleado   
                 AND (PROD.FCGENERO = EMP.FCGENERO OR PROD.FCGENERO = vlGeneroU )  
                 AND EMP.FIEMPLEADO NOT IN (SELECT FIEMPLEADO      -- Menos los empleados que ya solicitaron su pedido
                                              FROM UNIFORMES.TAPEDIDOS
                                             WHERE FITIPO IN( vlTipoSemestral  , vlTipoFormador)
                                               AND FIIDCARGA IN (vlIdCarga)
                                             UNION 
                                            SELECT FIEMPLEADO     
                                              FROM UNIFORMES.TAPEDIDOS
                                             WHERE FITIPO IN( vlTipoSemestral, vlTipoFormador)
                                               AND FIIDCARGA IN (csgCero)
                                               AND FDREGISTRO > ADD_MONTHS(SYSDATE,-vlDosMeses)
                                           )
                AND TRUNC(EMP.FDINGRESO) BETWEEN TRUNC(SYSDATE-vlDiasLimite) AND TRUNC(SYSDATE-vlDiasAntiguedad)
            ORDER BY EMP.FIEMPLEADO, DESCPROD, FITALLA;
         ELSE
           Raise_Application_Error ( vlNoDatos, 'No cumple con las restricciones de Nuevo Ingreso o ya cuenta con pedidos solicitados.');
         END IF;
          
     END IF;

   EXCEPTION 
   WHEN NO_DATA_FOUND THEN
      Raise_Application_Error ( vlNoDatos, 'El sistema no esta disponible para este Periodo o el empleado no existe o no esta registrado.');
     
END SPSOLICITUDFORMADOR;


FUNCTION FNGRABAREMISION(
    paRemision     IN UNIFORMES.TAREMISIONES.FIREMISION%TYPE
   ,paSucursal     IN UNIFORMES.TAREMISIONES.FISUCURSAL%TYPE
   ,paPedido       IN UNIFORMES.TAREMISIONES.FIPEDIDO%TYPE
   ,paSku          IN UNIFORMES.TAREMISIONES.FISKU%TYPE
   ,paCantidad     IN UNIFORMES.TAREMISIONES.FICANTIDAD%TYPE
   ,paEmpleadoRecibe IN UNIFORMES.TAREMISIONES.FIEMPLEADORECIBE%TYPE)
RETURN PAWSUNIFORMES.rcgCursor
IS
/********************************************************************************
   Descripcion: Función que graba una remision y regresa el registro
   Parámetros de entrada:  paRemision
                           paSucursal 
                           paPedido
                           paSku
                           paCantidad
                           paEmpleadoRecibe
   Parámetros de salida: Cursor
   Parámetros de entrada-salida: Ninguno
   Valor de retorno: Cursor con resultado.
   Creador:Laura Garcia Martinez
   Fecha de creación: 16 JUNIO 2014
**************************************************************************************/

     
      curDatos           UNIFORMES.PAWSUNIFORMES.rcgCursor; 
      
      vlPais             UNIFORMES.TADETALLEPEDIDOS.FIPAIS%TYPE:=0;
      vlCanal            UNIFORMES.TADETALLEPEDIDOS.FICANAL%TYPE:=0;
      vlFolioCentral     UNIFORMES.TADETALLEPEDIDOS.FIFOLIOCENTRAL%TYPE:=0;
      vlEstadoAnt        UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE:=0;
      vlActualizacion    VARCHAR2(20);
      vlEstEnviaAbasto   UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE:= 40;  --Enviado a Abasto
      vlEstAbastoCD      UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE:= 60;  --Abasto Envia a CD
      vlEstAbastoTda     UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE:= 70; -- Abasto Envia a Tienda
      vlEstRemision      UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE:= 80; -- Recibido en tienda (REMISION)
      vlCantidadDet      UNIFORMES.TADETALLEPEDIDOS.FICANTIDAD%TYPE:=0; --Cantidad piezas pedido
      vlCantidadRem      UNIFORMES.TAREMISIONES.FICANTIDAD%TYPE:=0; 
      
BEGIN

   SELECT FIPAIS
          ,FICANAL
          ,FIFOLIOCENTRAL
          ,FIESTATUS
          ,TO_CHAR(FDACTUALIZACION,'DD/MM/YYYY HH24:MI:SS') AS FDACTUALIZACION 
          ,FICANTIDAD
     INTO vlPais
         ,vlCanal
         ,vlFolioCentral
         ,vlEstadoAnt
         ,vlActualizacion   
         ,vlCantidadDet
     FROM UNIFORMES.TADETALLEPEDIDOS
    WHERE FISUCURSAL = paSucursal
      AND FIPEDIDO = paPedido
      AND FISKU = paSku
      AND FIESTATUS IN ( vlEstEnviaAbasto, vlEstAbastoCD, vlEstAbastoTda,  vlEstRemision);  
    
        
   BEGIN
    INSERT INTO UNIFORMES.TAREMISIONES( FIFOLIOCENTRAL,
                                        FIPAIS,
                                        FICANAL,
                                        FISUCURSAL,
                                        FIPEDIDO,
                                        FISKU,
                                        FIREMISION,
                                        FICANTIDAD,
                                        FIEMPLEADORECIBE)
                               VALUES ( vlFolioCentral
                                       ,vlPais
                                       ,vlCanal
                                       ,paSucursal
                                       ,paPedido
                                       ,paSku
                                       ,paRemision
                                       ,paCantidad
                                       ,paEmpleadoRecibe );
           
   EXCEPTION 
       WHEN DUP_VAL_ON_INDEX THEN
            NULL;
   END;
   
    SELECT SUM(FICANTIDAD) 
      INTO vlCantidadRem
      FROM UNIFORMES.TAREMISIONES
     WHERE FIFOLIOCENTRAL = vlFolioCentral
       AND FIPAIS = vlPais
       AND FICANAL = vlCanal
       AND FISUCURSAL = paSucursal  
       AND FIPEDIDO = paPedido
       AND FISKU = paSku;
      
   IF ( vlCantidadDet  =  vlCantidadRem ) THEN
           UNIFORMES.PAWSUNIFORMES.SPACTMOVTOPEDIDOS(vlPais
                                                    ,vlCanal
                                                    ,paSucursal
                                                    ,paPedido
                                                    ,vlFolioCentral
                                                    ,paSKU
                                                    ,vlEstadoAnt
                                                    ,vlActualizacion
                                                    ,vlEstRemision );   
   END IF;
                                                    
   OPEN curDatos FOR
        SELECT FIPAIS,
               FICANAL,
               FISUCURSAL,
               FIPEDIDO,
               FIFOLIOCENTRAL,
               FISKU,
               FIREMISION,
               FICANTIDAD,
               FIEMPLEADORECIBE
          FROM UNIFORMES.TAREMISIONES
         WHERE FIFOLIOCENTRAL = vlFolioCentral
           AND FIPAIS = vlPais
           AND FICANAL = vlCanal
           AND FISUCURSAL = paSucursal
           AND FIPEDIDO = paPedido
           AND FISKU = paSku
           AND FIREMISION = paRemision;
           
   RETURN curDatos;
    
END FNGRABAREMISION;


PROCEDURE SPCONSULTAENTREGA
(  paIdEmpleado    IN    UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE
   ,paTienda       IN    UNIFORMES.TASUCURSALES.FISUCURSAL%TYPE
   ,paCurEntrega   OUT   rcgCursor)
IS
/********************************************************************************
   Descripcion: Procedimiento que regresa los datos 
   Parámetros de entrada:  paIdEmpleado, paTienda
   Parámetros de salida: paCurEntrega
   Parámetros de entrada-salida: Ninguno
   Valor de retorno: Cursor con resultado.
   Creador:  Laura Garcia Martinez
   Fecha de creación: 16 JULIO 2014
**************************************************************************************/  

    vlFormador          UNIFORMES.TASUCURSALES.FIIDFORMADOR%TYPE:=0;
    vlPais              UNIFORMES.TADETALLEPEDIDOS.FIPAIS%TYPE:=0;
    vlCanal             UNIFORMES.TADETALLEPEDIDOS.FICANAL%TYPE:=0; 
    vlEstRemision       UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE:= 80; -- Recibido en tienda (REMISION) 
    vlTipoVoluntaria    UNIFORMES.TAPEDIDOS.FITIPO%TYPE:= 1;
    vlTipoSemestral     UNIFORMES.TAPEDIDOS.FITIPO%TYPE:= 2;
    vlTipoFormador      UNIFORMES.TAPEDIDOS.FITIPO%TYPE:= 3;
    vlNoDatosSuc        NUMBER(5):= -20003;
    vlCero              NUMBER(1):= 0;
    vlUno               NUMBER(1):= 1;
    cslActivo           CONSTANT VARCHAR2(1 CHAR) := 'A'; -- constante para filtrar empleados ACTIVOS
BEGIN
   IF(paIdEmpleado <> vlCero)
   THEN
      SELECT CECO.FIPAIS,
             CECO.FCIDCANAL
        INTO vlPais,
             vlCanal
        FROM UNIFORMES.TAEMPLEADOS EMP
       INNER JOIN UNIFORMES.TACECO CECO
             ON (EMP.FICECO = CECO.FICC)
       INNER JOIN UNIFORMES.TAFUNCIONES FUN
             ON (FUN.FIFUNCIONSAP = EMP.FIFUNCION 
                 AND TRIM(CECO.FCIDCANAL)=TRIM(FUN.FCIDCANAL))
       WHERE EMP.FIEMPLEADO = paIdEmpleado;

        OPEN paCurEntrega FOR
          SELECT DP.FIFOLIOCENTRAL
                ,DP.FIPAIS
                ,DP.FICANAL
                ,DP.FISUCURSAL
                ,P.FIEMPLEADO
                ,P.FITIPO
                ,DP.FIPEDIDO
                ,DP.FISKU
                ,DP.FICANTIDAD
                ,DP.FIESTATUS
                ,DP.FNCOSTO
                ,DP.FNDESCUENTO
                ,TO_CHAR(DP.FDACTUALIZACION,'DD/MM/YYYY HH24:MI:SS') AS FDACTUALIZACION    
                ,EMP.FCNOMBRE 
                ,FUN.FCDESCRIPCION   -- FUNCION DESCRIPCION
                ,EMP.FICECO  -- CENTRO DE COSTOS
                ,RC.FCCOMPANIA 
                ,TIPROD.FCDESCRIPCION 
                ,REMI.FIREMISION
           FROM UNIFORMES.TADETALLEPEDIDOS DP
          INNER JOIN UNIFORMES.TAPEDIDOS P
             ON (P.FIFOLIOCENTRAL = DP.FIFOLIOCENTRAL)
          INNER JOIN UNIFORMES.TAFUNCIONES FUN
             ON (FUN.FIFUNCIONSAP = P.FIFUNCION 
             AND FUN.FCIDCANAL = DP.FICANAL) 
          INNER JOIN UNIFORMES.TARELACIONESCANAL RC
             ON (TO_NUMBER(RC.FCIDCANAL) = DP.FICANAL 
            AND RC.FCIDCANAL = FUN.FCIDCANAL)
          INNER JOIN UNIFORMES.TAEMPLEADOS EMP
             ON (EMP.FIEMPLEADO  = P.FIEMPLEADO
            AND  EMP.FCSITUACION = cslActivo) 
          INNER JOIN UNIFORMES.TAPRODUCTOS PROD
             ON (PROD.FISKU = DP.FISKU )
          INNER JOIN UNIFORMES.TATIPOSPRODUCTO TIPROD
             ON (PROD.FITIPO = TIPROD.FITIPO)  
          INNER JOIN UNIFORMES.TAREMISIONES REMI
             ON (DP.FIFOLIOCENTRAL = REMI.FIFOLIOCENTRAL
            AND DP.FIPAIS     = REMI.FIPAIS
            AND DP.FICANAL    = REMI.FICANAL
            AND DP.FISUCURSAL = REMI.FISUCURSAL 
            AND DP.FIPEDIDO   = REMI.FIPEDIDO
            AND DP.FISKU      = REMI.FISKU)     
          WHERE DP.FIPAIS     = vlPais 
            AND DP.FICANAL    = vlCanal
            AND DP.FISUCURSAL = paTienda
            AND DP.FIESTATUS  = vlEstRemision
            AND RC.FCIDCANAL  = TO_CHAR(vlCanal)
            AND P.FITIPO IN ( vlTipoSemestral, vlTipoFormador, vlTipoVoluntaria)
             AND (DP.FIFOLIOCENTRAL, DP.FIPEDIDO,DP.FISKU,REMI.FIREMISION, DP.FICANTIDAD) IN (
                  SELECT DP.FIFOLIOCENTRAL
                         ,DP.FIPEDIDO
                         ,DP.FISKU
                         ,MAX(REMI.FIREMISION)
                         ,SUM(REMI.FICANTIDAD)
                         FROM UNIFORMES.TADETALLEPEDIDOS DP
                   INNER JOIN UNIFORMES.TAPEDIDOS P
                      ON (P.FIFOLIOCENTRAL = DP.FIFOLIOCENTRAL)
                   INNER JOIN UNIFORMES.TAFUNCIONES FUN
                      ON (FUN.FIFUNCIONSAP = P.FIFUNCION 
                     AND FUN.FCIDCANAL = DP.FICANAL) 
                   INNER JOIN UNIFORMES.TARELACIONESCANAL RC
                      ON (TO_NUMBER(RC.FCIDCANAL) = DP.FICANAL 
                     AND RC.FCIDCANAL = FUN.FCIDCANAL)
                   INNER JOIN UNIFORMES.TAEMPLEADOS EMP
                      ON (EMP.FIEMPLEADO = P.FIEMPLEADO ) 
                   INNER JOIN UNIFORMES.TAPRODUCTOS PROD
                      ON (PROD.FISKU = DP.FISKU )
                   INNER JOIN UNIFORMES.TATIPOSPRODUCTO TIPROD
                      ON (PROD.FITIPO = TIPROD.FITIPO)  
                   INNER JOIN UNIFORMES.TAREMISIONES REMI
                      ON (DP.FIFOLIOCENTRAL = REMI.FIFOLIOCENTRAL
                     AND DP.FIPAIS = REMI.FIPAIS
                     AND DP.FICANAL = REMI.FICANAL
                     AND DP.FISUCURSAL = REMI.FISUCURSAL 
                     AND DP.FIPEDIDO = REMI.FIPEDIDO
                     AND DP.FISKU = REMI.FISKU)     
                   WHERE DP.FIPAIS = vlPais 
                     AND DP.FICANAL  = vlCanal
                     AND DP.FISUCURSAL = paTienda
                     AND DP.FIESTATUS = vlEstRemision
                     AND RC.FCIDCANAL = TO_CHAR(vlCanal)
                     AND P.FITIPO IN ( vlTipoSemestral, vlTipoFormador, vlTipoVoluntaria)
                     GROUP BY DP.FIFOLIOCENTRAL
                         ,DP.FIPEDIDO
                         ,DP.FISUCURSAL
                         ,DP.FISKU)
       ORDER BY P.FIEMPLEADO
                ,DP.FIFOLIOCENTRAL
                ,DP.FIPEDIDO;
   ELSE
        vlPais := vlUno;
        OPEN paCurEntrega FOR
          SELECT DP.FIFOLIOCENTRAL
                ,DP.FIPAIS
                ,DP.FICANAL
                ,DP.FISUCURSAL
                ,P.FIEMPLEADO
                ,P.FITIPO
                ,DP.FIPEDIDO
                ,DP.FISKU
                ,DP.FICANTIDAD
                ,DP.FIESTATUS
                ,DP.FNCOSTO
                ,DP.FNDESCUENTO
                ,TO_CHAR(DP.FDACTUALIZACION,'DD/MM/YYYY HH24:MI:SS') AS FDACTUALIZACION    
                ,EMP.FCNOMBRE 
                ,FUN.FCDESCRIPCION   -- FUNCION DESCRIPCION
                ,EMP.FICECO  -- CENTRO DE COSTOS
                ,RC.FCCOMPANIA 
                ,TIPROD.FCDESCRIPCION 
                ,REMI.FIREMISION
           FROM UNIFORMES.TADETALLEPEDIDOS DP
          INNER JOIN UNIFORMES.TAPEDIDOS P
             ON (P.FIFOLIOCENTRAL = DP.FIFOLIOCENTRAL)
          INNER JOIN UNIFORMES.TAFUNCIONES FUN
             ON (FUN.FIFUNCIONSAP = P.FIFUNCION 
             AND FUN.FCIDCANAL = DP.FICANAL) 
          INNER JOIN UNIFORMES.TARELACIONESCANAL RC
             ON (TO_NUMBER(RC.FCIDCANAL) = DP.FICANAL 
            AND RC.FCIDCANAL = FUN.FCIDCANAL)
          INNER JOIN UNIFORMES.TAEMPLEADOS EMP
             ON (EMP.FIEMPLEADO  = P.FIEMPLEADO
            AND  EMP.FCSITUACION = cslActivo)  
          INNER JOIN UNIFORMES.TAPRODUCTOS PROD
             ON (PROD.FISKU = DP.FISKU )
          INNER JOIN UNIFORMES.TATIPOSPRODUCTO TIPROD
             ON (PROD.FITIPO = TIPROD.FITIPO)  
          INNER JOIN UNIFORMES.TAREMISIONES REMI
             ON (DP.FIFOLIOCENTRAL = REMI.FIFOLIOCENTRAL
            AND DP.FIPAIS     = REMI.FIPAIS
            AND DP.FICANAL    = REMI.FICANAL
            AND DP.FISUCURSAL = REMI.FISUCURSAL 
            AND DP.FIPEDIDO   = REMI.FIPEDIDO
            AND DP.FISKU      = REMI.FISKU)     
          WHERE DP.FIPAIS     = vlPais
            AND DP.FISUCURSAL = paTienda
            AND DP.FIESTATUS  = vlEstRemision
            AND P.FITIPO IN ( vlTipoSemestral, vlTipoFormador, vlTipoVoluntaria)
            AND TRANSLATE(RC.FCIDCANAL, 'T 0123456789', 'T') IS NULL
            AND (DP.FIFOLIOCENTRAL, DP.FIPEDIDO,DP.FISKU,REMI.FIREMISION,DP.FICANTIDAD) IN (
                  SELECT DP.FIFOLIOCENTRAL
                        ,DP.FIPEDIDO
                        ,DP.FISKU
                        ,MAX(REMI.FIREMISION)
                        ,SUM(REMI.FICANTIDAD)
                    FROM UNIFORMES.TADETALLEPEDIDOS DP
                   INNER JOIN UNIFORMES.TAPEDIDOS P
                      ON (P.FIFOLIOCENTRAL = DP.FIFOLIOCENTRAL)
                   INNER JOIN UNIFORMES.TAFUNCIONES FUN
                      ON (FUN.FIFUNCIONSAP = P.FIFUNCION 
                     AND FUN.FCIDCANAL = DP.FICANAL) 
                   INNER JOIN UNIFORMES.TARELACIONESCANAL RC
                      ON (TO_NUMBER(RC.FCIDCANAL) = DP.FICANAL 
                     AND RC.FCIDCANAL = FUN.FCIDCANAL)
                   INNER JOIN UNIFORMES.TAEMPLEADOS EMP
                      ON (EMP.FIEMPLEADO = P.FIEMPLEADO ) 
                   INNER JOIN UNIFORMES.TAPRODUCTOS PROD
                      ON (PROD.FISKU = DP.FISKU )
                   INNER JOIN UNIFORMES.TATIPOSPRODUCTO TIPROD
                      ON (PROD.FITIPO = TIPROD.FITIPO)  
                   INNER JOIN UNIFORMES.TAREMISIONES REMI
                      ON (DP.FIFOLIOCENTRAL = REMI.FIFOLIOCENTRAL
                     AND DP.FIPAIS     = REMI.FIPAIS
                     AND DP.FICANAL    = REMI.FICANAL
                     AND DP.FISUCURSAL = REMI.FISUCURSAL 
                     AND DP.FIPEDIDO   = REMI.FIPEDIDO
                     AND DP.FISKU      = REMI.FISKU)     
                   WHERE DP.FIPAIS     = vlPais
                     AND DP.FISUCURSAL = paTienda
                     AND DP.FIESTATUS  = vlEstRemision
                     AND P.FITIPO IN ( vlTipoSemestral, vlTipoFormador, vlTipoVoluntaria)
                     AND TRANSLATE(RC.FCIDCANAL, 'T 0123456789', 'T') IS NULL
                   GROUP BY DP.FIFOLIOCENTRAL
                        ,DP.FIPEDIDO
                        ,DP.FISUCURSAL
                        ,DP.FISKU
            )
       ORDER BY P.FIEMPLEADO
                ,DP.FIFOLIOCENTRAL
                ,DP.FIPEDIDO;
   END IF;
   

EXCEPTION 
 WHEN NO_DATA_FOUND THEN
    Raise_Application_Error ( vlNoDatosSuc, 'La Tienda no existe o no esta Registrada.');
   

END SPCONSULTAENTREGA;


PROCEDURE SPGRABAENTREGA
(   paFolioCentral  IN    UNIFORMES.TADETALLEPEDIDOS.FIFOLIOCENTRAL%TYPE
   ,paPais          IN    UNIFORMES.TADETALLEPEDIDOS.FIPAIS%TYPE
   ,paCanal         IN    UNIFORMES.TADETALLEPEDIDOS.FICANAL%TYPE
   ,paSucursal      IN    UNIFORMES.TADETALLEPEDIDOS.FISUCURSAL%TYPE
   ,paPedido        IN    UNIFORMES.TADETALLEPEDIDOS.FIPEDIDO%TYPE
   ,paSKU           IN    UNIFORMES.TADETALLEPEDIDOS.FISKU%TYPE
   ,paEstAnterior   IN    UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE
   ,paFecAnterior   IN    VARCHAR2
   ,paGerente       IN    UNIFORMES.TADETALLEPEDIDOS.FIGERENTEENTREGA%TYPE)
IS
/********************************************************************************
   Descripcion: Procedimiento que regresa los datos 
   Parámetros de entrada: paFolioCentral, paPais,paCanal,paSucursal,paPedido,paSKU,
                           paEstAnterior,paFecAnterior,paGerente
   Parámetros de salida: 
   Parámetros de entrada-salida: Ninguno
   Valor de retorno: Cursor con resultado.
   Creador:  Laura Garcia Martinez
   Fecha de creación: 16 JULIO 2014
**************************************************************************************/ 
   
    
   vlEstEntregado       UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE:= 90;
   vlFechaActual        UNIFORMES.TADETALLEPEDIDOS.FDACTUALIZACION%TYPE:= SYSDATE;
   vlParcialEntrega     UNIFORMES.TAPEDIDOS.FIESTADOGENERAL%TYPE := 1;
   vlEntregado          UNIFORMES.TAPEDIDOS.FIESTADOGENERAL%TYPE := 2;
   vlTotalPedido        UNIFORMES.TADETALLEPEDIDOS.FICANTIDAD%TYPE:=0;
   vlTotalEntregado     UNIFORMES.TADETALLEPEDIDOS.FICANTIDAD%TYPE:=0;
     
BEGIN
    
   MERGE INTO UNIFORMES.TAMOVTODETALLEPEDIDOS DATOS
         USING (SELECT paFolioCentral FOLIOCENTRAL,
                       paPais PAIS,
                       paCanal CANAL,
                       paSucursal SUCURSAL,
                       paPedido PEDIDO,
                       paSKU SKU,
                       paEstAnterior ESTATUS
                  FROM DUAL) VALORES
            ON (DATOS.FIFOLIOCENTRAL=VALORES.FOLIOCENTRAL AND 
                DATOS.FIPAIS=VALORES.PAIS AND 
                DATOS.FICANAL=VALORES.CANAL AND 
                DATOS.FISUCURSAL=VALORES.SUCURSAL AND 
                DATOS.FIPEDIDO=VALORES.PEDIDO AND 
                DATOS.FISKU=VALORES.SKU AND 
                DATOS.FIESTADO=VALORES.ESTATUS)
      WHEN NOT MATCHED THEN
          INSERT ( FIFOLIOCENTRAL
                 , FIPAIS
                 , FICANAL
                 , FISUCURSAL
                 , FIPEDIDO
                 , FISKU
                 , FIESTADO
                 , FDMOVIMIENTO )
          VALUES ( paFolioCentral 
                 , paPais
                 , paCanal
                 , paSucursal
                 , paPedido
                 , paSKU
                 , paEstAnterior
                 , TO_DATE(paFecAnterior, 'DD/MM/YYYY HH24:MI:SS')
                  );


   UPDATE UNIFORMES.TADETALLEPEDIDOS
      SET FIESTATUS = vlEstEntregado
         ,FIGERENTEENTREGA = paGerente
         ,FDACTUALIZACION = vlFechaActual
    WHERE FIFOLIOCENTRAL = paFolioCentral 
      AND FIPAIS = paPais
      AND FICANAL = paCanal
      AND FISUCURSAL = paSucursal
      AND FIPEDIDO = paPedido
      AND FISKU = paSKU;
   
   
       SELECT COUNT(B.ROWID)
             ,A.SUBTOTAL
         INTO vlTotalPedido
             ,vlTotalEntregado      
         FROM UNIFORMES.TADETALLEPEDIDOS B
   INNER JOIN (SELECT FIFOLIOCENTRAL, COUNT(ROWID) SUBTOTAL
                 FROM UNIFORMES.TADETALLEPEDIDOS 
                WHERE FIFOLIOCENTRAL = paFolioCentral
                  AND FIESTATUS =  vlEstEntregado
             GROUP BY FIFOLIOCENTRAL ) A
          ON ( A.FIFOLIOCENTRAL = B.FIFOLIOCENTRAL)
       WHERE B.FIFOLIOCENTRAL = paFolioCentral
    GROUP BY A.SUBTOTAL;                                                    


    IF (vlTotalPedido = vlTotalEntregado) THEN
         
       UPDATE UNIFORMES.TAPEDIDOS
          SET FIESTADOGENERAL = vlEntregado
        WHERE FIFOLIOCENTRAL = paFolioCentral;
    ELSE 
       UPDATE UNIFORMES.TAPEDIDOS
          SET FIESTADOGENERAL = vlParcialEntrega
        WHERE FIFOLIOCENTRAL = paFolioCentral;
              
    END IF;
    
    
END SPGRABAENTREGA;


PROCEDURE SPACTMOVTOPEDIDOS(
   paIdPais         IN  UNIFORMES.TADETALLEPEDIDOS.FIPAIS%TYPE
  ,paIdCanal        IN  UNIFORMES.TADETALLEPEDIDOS.FICANAL%TYPE
  ,paSucursal       IN  UNIFORMES.TADETALLEPEDIDOS.FISUCURSAL%TYPE
  ,paPedido         IN  UNIFORMES.TADETALLEPEDIDOS.FIPEDIDO%TYPE
  ,paFolioCentral   IN  UNIFORMES.TADETALLEPEDIDOS.FIFOLIOCENTRAL%TYPE
  ,paSKU            IN  UNIFORMES.TADETALLEPEDIDOS.FISKU%TYPE
  ,paEstatusAnterior IN  UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE
  ,paActualizacion  IN  VARCHAR2
  ,paEstatusNuevo   IN  UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE)
IS
/********************************************************************************
   Descripcion: Procedimiento que regresa los datos 
   Parámetros de entrada: 
   Parámetros de salida: 
   Parámetros de entrada-salida: Ninguno
   Valor de retorno: Cursor con resultado.
   Creador: Laura Garcia Martinez
   Fecha de creación: 9 JULIO 2014
**************************************************************************************/  

   vlFechaActual    UNIFORMES.TADETALLEPEDIDOS.FDACTUALIZACION%TYPE := SYSDATE;
 
BEGIN

   BEGIN
      INSERT INTO UNIFORMES.TAMOVTODETALLEPEDIDOS ( FIFOLIOCENTRAL
                                                  , FIPAIS
                                                  , FICANAL
                                                  , FISUCURSAL
                                                  , FIPEDIDO
                                                  , FISKU
                                                  , FIESTADO
                                                  , FDMOVIMIENTO )
                                           VALUES ( paFolioCentral
                                                  , paIdPais
                                                  , paIdCanal
                                                  , paSucursal
                                                  , paPedido
                                                  , paSKU
                                                  , paEstatusAnterior
                                                  , TO_DATE(paActualizacion, 'DD/MM/YYYY HH24:MI:SS')  
                                                   ); 
   EXCEPTION 
      WHEN DUP_VAL_ON_INDEX THEN
           NULL;
   END;                                           
                                               
   UPDATE UNIFORMES.TADETALLEPEDIDOS  
      SET FIESTATUS = paEstatusNuevo
         ,FDACTUALIZACION = vlFechaActual 
    WHERE FIFOLIOCENTRAL = paFolioCentral
      AND FIPAIS = paIdPais
      AND FICANAL = paIdCanal
      AND FISUCURSAL = paSucursal
      AND FIPEDIDO = paPedido
      AND FISKU = paSKU;                                             

END SPACTMOVTOPEDIDOS;

PROCEDURE SPCONSULTAKIT(
   paIdEmpleado    IN    UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE
  ,paIdBandera     IN    NUMBER 
  ,paCurSolicitud  OUT   rcgCursor)
IS
/********************************************************************************
   Descripcion: Procedimiento que regresa los datos de los uniformes a solicitar
               por el EMPLEADO
   Parámetros de entrada:  paIdEmpleado
   Parámetros de salida: paCurSolicitud
   Parámetros de entrada-salida: Ninguno
   Valor de retorno: Cursor con resultado.
   Creador:  Laura Garcia Martinez
   Fecha de creación: 9 JULIO 2014
************************************************************************************/  
 
   vlGeneroU         UNIFORMES.TAPRODUCTOS.FCGENERO%TYPE:= 'U';  -- Unisex       
   vlIdCarga         UNIFORMES.TACARGAS.FIIDCARGA%TYPE:= 0;
   cslActivo         UNIFORMES.TACARGAS.FIESTATUS%TYPE:= 1;
   vlTipoSemestral   UNIFORMES.TAPEDIDOS.FITIPO%TYPE := 2;   -- Carga Semestral
   vlTipoFormador    UNIFORMES.TAPEDIDOS.FITIPO%TYPE := 3;   -- Carga Semestral
   vlFecIni          UNIFORMES.TACARGAS.FDFECHAFINAL%TYPE;
   vlFecFin          UNIFORMES.TACARGAS.FDFECHAFINAL%TYPE;
   vlFechaActual     UNIFORMES.TACARGAS.FDFECHAFINAL%TYPE; 
   vlNoDatos         NUMBER(5):= -20001;
   vlConteo          NUMBER(10):= 0;
   vlDiasAntiguedad  NUMBER(1):= 4;
   vlTres            NUMBER(1):= 3;
   vlCuatro          NUMBER(1):= 4;
   vlCero            NUMBER(1):= 0;
   vlDosMeses        NUMBER(1):= 2;
   
BEGIN

   SELECT FIIDCARGA
         ,TRUNC(FDFECHAINICIAL)
         ,TRUNC(FDFECHAFINAL)
         ,TRUNC(SYSDATE)
     INTO vlIdCarga
         ,vlFecIni
         ,vlFecFin
         ,vlFechaActual
     FROM UNIFORMES.TACARGAS
    WHERE FIESTATUS = cslActivo; 

   
   IF (paIdBandera = vlTipoFormador ) THEN   -- Opcion Nuevo Ingreso
        SELECT COUNT(1)
          INTO vlConteo 
          FROM UNIFORMES.TAEMPLEADOS EMP
    INNER JOIN UNIFORMES.TACECO CECO
            ON (EMP.FICECO = CECO.FICC)
    INNER JOIN UNIFORMES.TAFUNCIONES FUN
            ON (FUN.FIFUNCIONSAP = EMP.FIFUNCION AND TRIM(CECO.FCIDCANAL)=TRIM(FUN.FCIDCANAL))
    INNER JOIN UNIFORMES.TAKITS KIT
            ON (KIT.FIKIT = FUN.FIKIT)
    INNER JOIN UNIFORMES.TAPRODUCTOSXKIT PXKIT
            ON (KIT.FIKIT = PXKIT.FIKIT)
    INNER JOIN UNIFORMES.TAPRODUCTOS PROD
            ON (PXKIT.FISKU = PROD.FISKU)
    INNER JOIN UNIFORMES.TATIPOSPRODUCTO TPROD
            ON (PROD.FITIPO = TPROD.FITIPO)
    INNER JOIN UNIFORMES.TATALLAS TALLA
            ON (PROD.FITALLA = TALLA.FITALLA)
          WHERE EMP.FIEMPLEADO = paIdEmpleado    
           AND (PROD.FCGENERO = EMP.FCGENERO OR PROD.FCGENERO = vlGeneroU )  
           AND EMP.FIEMPLEADO NOT IN (SELECT FIEMPLEADO      -- Menos los empleados que ya solicitaron su pedido
                                        FROM UNIFORMES.TAPEDIDOS
                                       WHERE FITIPO IN( vlTipoSemestral  , vlTipoFormador)
                                         AND FIIDCARGA IN (vlIdCarga)
                                       UNION 
                                      SELECT FIEMPLEADO     
                                        FROM UNIFORMES.TAPEDIDOS
                                       WHERE FITIPO IN( vlTipoSemestral, vlTipoFormador)
                                         AND FIIDCARGA IN (csgCero)
                                         AND FDREGISTRO > ADD_MONTHS(SYSDATE,-vlDosMeses)
                                     )
           AND TRUNC(SYSDATE)-(TRUNC(EMP.FDINGRESO)+vlDiasAntiguedad) >= vlCero; 
                       
      IF (vlConteo > vlCero)
      THEN
       OPEN paCurSolicitud FOR
           SELECT TO_NUMBER(SUBSTR(EMP.FICECO, vlTres, vlCuatro)) AS SUCURSAL
                , EMP.FIEMPLEADO 
                , EMP.FCNOMBRE
                , EMP.FCPOSICION
                , EMP.FCGENERO
                , TPROD.FCDESCRIPCION  DESCPROD
                , TALLA.FCCLAVE
                , TALLA.FITALLA
                , PROD.FNCOSTO   
                , PROD.FNDESCUENTO   
                , EMP.FIFUNCION    
                , CECO.FCIDCANAL AS FIUNIDADNEGOCIO 
                , PROD.FITIPO    
                , PROD.FISKU 
                , TALLA.FCDESCRIPCION
             FROM  UNIFORMES.TAEMPLEADOS EMP
       INNER JOIN UNIFORMES.TACECO CECO
               ON (EMP.FICECO = CECO.FICC)
       INNER JOIN UNIFORMES.TAFUNCIONES FUN
               ON (FUN.FIFUNCIONSAP = EMP.FIFUNCION AND TRIM(CECO.FCIDCANAL)=TRIM(FUN.FCIDCANAL))
       INNER JOIN UNIFORMES.TAKITS KIT
               ON (KIT.FIKIT = FUN.FIKIT)
       INNER JOIN UNIFORMES.TAPRODUCTOSXKIT PXKIT
               ON (KIT.FIKIT = PXKIT.FIKIT)
       INNER JOIN UNIFORMES.TAPRODUCTOS PROD
               ON (PXKIT.FISKU = PROD.FISKU)
       INNER JOIN UNIFORMES.TATIPOSPRODUCTO TPROD
               ON (PROD.FITIPO = TPROD.FITIPO)
       INNER JOIN UNIFORMES.TATALLAS TALLA
               ON (PROD.FITALLA = TALLA.FITALLA)
             WHERE EMP.FIEMPLEADO = paIdEmpleado    
              AND (PROD.FCGENERO = EMP.FCGENERO OR PROD.FCGENERO = vlGeneroU )  
              AND EMP.FIEMPLEADO NOT IN (SELECT FIEMPLEADO      -- Menos los empleados que ya solicitaron su pedido
                                           FROM UNIFORMES.TAPEDIDOS
                                          WHERE FITIPO IN( vlTipoSemestral  , vlTipoFormador)
                                            AND FIIDCARGA IN (vlIdCarga)
                                          UNION 
                                         SELECT FIEMPLEADO     
                                           FROM UNIFORMES.TAPEDIDOS
                                          WHERE FITIPO IN( vlTipoSemestral, vlTipoFormador)
                                            AND FIIDCARGA IN (csgCero)
                                            AND FDREGISTRO > ADD_MONTHS(SYSDATE,-vlDosMeses)
                                        )
              AND TRUNC(SYSDATE)-(TRUNC(EMP.FDINGRESO)+vlDiasAntiguedad) >= vlCero  -- Empleados con MENOS de 4 dias de antiguedad
         ORDER BY EMP.FIEMPLEADO, DESCPROD, FITALLA;
      ELSE
        Raise_Application_Error ( vlNoDatos, 'No se han cumplido los dias para la solicitud.');
      END IF;
                 
   ELSE 
       
      IF (vlFechaActual BETWEEN vlFecIni AND vlFecFin) THEN
         SELECT COUNT(1)
           INTO vlConteo
           FROM UNIFORMES.TAEMPLEADOS EMP
          INNER JOIN UNIFORMES.TACECO CECO
                  ON (EMP.FICECO = CECO.FICC)
          INNER JOIN UNIFORMES.TAFUNCIONES FUN
                  ON (FUN.FIFUNCIONSAP = EMP.FIFUNCION AND TRIM(CECO.FCIDCANAL)=TRIM(FUN.FCIDCANAL))
          INNER JOIN UNIFORMES.TAKITS KIT
                  ON (KIT.FIKIT = FUN.FIKIT)
          INNER JOIN UNIFORMES.TAPRODUCTOSXKIT PXKIT
                  ON (KIT.FIKIT = PXKIT.FIKIT)
          INNER JOIN UNIFORMES.TAPRODUCTOS PROD
                  ON (PXKIT.FISKU = PROD.FISKU)
          INNER JOIN UNIFORMES.TATIPOSPRODUCTO TPROD
                  ON (PROD.FITIPO = TPROD.FITIPO)
          INNER JOIN UNIFORMES.TATALLAS TALLA
                  ON (PROD.FITALLA = TALLA.FITALLA)
               WHERE EMP.FIEMPLEADO = paIdEmpleado   
                 AND (PROD.FCGENERO = EMP.FCGENERO OR PROD.FCGENERO = vlGeneroU )  
                 AND EMP.FIEMPLEADO NOT IN (SELECT FIEMPLEADO      -- Menos los empleados que ya solicitaron su pedido
                                              FROM UNIFORMES.TAPEDIDOS
                                             WHERE FITIPO IN( vlTipoSemestral  , vlTipoFormador)
                                               AND FIIDCARGA IN (vlIdCarga)
                                             UNION 
                                            SELECT FIEMPLEADO     
                                              FROM UNIFORMES.TAPEDIDOS
                                             WHERE FITIPO IN( vlTipoSemestral, vlTipoFormador)
                                               AND FIIDCARGA IN (csgCero)
                                               AND FDREGISTRO > ADD_MONTHS(SYSDATE,-vlDosMeses)
                                           )
                AND EMP.FDINGRESO <= SYSDATE-vlDiasAntiguedad;
                         
         IF(vlConteo > vlCero)
         THEN
           OPEN paCurSolicitud FOR
              SELECT TO_NUMBER(SUBSTR(EMP.FICECO, vlTres, vlCuatro)) AS SUCURSAL
                   , EMP.FIEMPLEADO 
                   , EMP.FCNOMBRE
                   , EMP.FCPOSICION
                   , EMP.FCGENERO
                   , TPROD.FCDESCRIPCION  DESCPROD
                   , TALLA.FCCLAVE
                   , TALLA.FITALLA
                   , PROD.FNCOSTO   
                   , PROD.FNDESCUENTO   
                   , EMP.FIFUNCION    
                   , CECO.FCIDCANAL AS FIUNIDADNEGOCIO 
                   , PROD.FITIPO    
                   , PROD.FISKU 
                   , TALLA.FCDESCRIPCION
                FROM UNIFORMES.TAEMPLEADOS EMP
          INNER JOIN UNIFORMES.TACECO CECO
                  ON (EMP.FICECO = CECO.FICC)
          INNER JOIN UNIFORMES.TAFUNCIONES FUN
                  ON (FUN.FIFUNCIONSAP = EMP.FIFUNCION AND TRIM(CECO.FCIDCANAL)=TRIM(FUN.FCIDCANAL))
          INNER JOIN UNIFORMES.TAKITS KIT
                  ON (KIT.FIKIT = FUN.FIKIT)
          INNER JOIN UNIFORMES.TAPRODUCTOSXKIT PXKIT
                  ON (KIT.FIKIT = PXKIT.FIKIT)
          INNER JOIN UNIFORMES.TAPRODUCTOS PROD
                  ON (PXKIT.FISKU = PROD.FISKU)
          INNER JOIN UNIFORMES.TATIPOSPRODUCTO TPROD
                  ON (PROD.FITIPO = TPROD.FITIPO)
          INNER JOIN UNIFORMES.TATALLAS TALLA
                  ON (PROD.FITALLA = TALLA.FITALLA)
               WHERE EMP.FIEMPLEADO = paIdEmpleado   
                 AND (PROD.FCGENERO = EMP.FCGENERO OR PROD.FCGENERO = vlGeneroU )  
                 AND EMP.FIEMPLEADO NOT IN (SELECT FIEMPLEADO      -- Menos los empleados que ya solicitaron su pedido
                                              FROM UNIFORMES.TAPEDIDOS
                                             WHERE FITIPO IN( vlTipoSemestral  , vlTipoFormador)
                                               AND FIIDCARGA IN (vlIdCarga)
                                             UNION 
                                            SELECT FIEMPLEADO     
                                              FROM UNIFORMES.TAPEDIDOS
                                             WHERE FITIPO IN( vlTipoSemestral, vlTipoFormador)
                                               AND FIIDCARGA IN (csgCero)
                                               AND FDREGISTRO > ADD_MONTHS(SYSDATE,-vlDosMeses)
                                           )
                AND EMP.FDINGRESO <= SYSDATE-vlDiasAntiguedad  -- Empleados con MENOS de 4 días de antiguedad
            ORDER BY EMP.FIEMPLEADO, DESCPROD, FITALLA;
         ELSE
           Raise_Application_Error ( vlNoDatos, 'No se encontraron datos para esta solicitud o ya cuenta con pedidos solicitados.');
         END IF;
      
      ELSE
          Raise_Application_Error ( vlNoDatos, 'El sistema no esta disponible en este Periodo.');
      END IF;
                   
   END IF;

          
END SPCONSULTAKIT;


PROCEDURE SPSOLICITUDINDIVIDUAL( 
        paIdEmpleado         IN UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE,
        paFuncionEmpleado    IN UNIFORMES.TAEMPLEADOS.FIFUNCION%TYPE,
        paGeneroEmpleado     IN UNIFORMES.TAEMPLEADOS.FCGENERO%TYPE,
        paCurSolicitud      OUT rcgCursor
)
IS
/********************************************************************************
   Descripcion: Procedimiento que regresa los datos de uniformes para que el 
               empleado lo solicite de forma voluntaria.
   Parámetros de entrada:  paIdEmpleado
   Parámetros de entrada:  paFuncionEmpleado
   Parámetros de entrada:  paGeneroEmpleado   
   Parámetros de salida: paCurSolicitud
   Parámetros de entrada-salida: Ninguno
   Valor de retorno: Cursor con resultado.
   Creador:  exception
   Fecha de creación: 12 AGOSTO 2014
**************************************************************************************/  
    vlSituacionEmpleado UNIFORMES.TAEMPLEADOS.FCSITUACION%TYPE := 'A';
    vlGeneroU           UNIFORMES.TAPRODUCTOS.FCGENERO%TYPE:= 'U';  -- Unisex       
    vlFechaCompara      UNIFORMES.TAPEDIDOS.FDREGISTRO%TYPE;
    vlFechaUltimaReg    UNIFORMES.TAPEDIDOS.FDREGISTRO%TYPE;
    vlNoDatos           NUMBER(5):= -20001;
    vlTres              NUMBER(1):= 3;
    vlCuatro            NUMBER(1):= 4;
    vlDias              NUMBER(2):= 56;
    
BEGIN
   SELECT TRUNC(SYSDATE - vlDias)
     INTO vlFechaCompara
     FROM DUAL;
     
   SELECT NVL(TRUNC(MAX(FDREGISTRO)), TRUNC(TO_DATE('01/01/1900','DD/MM/YYYY')))
     INTO vlFechaUltimaReg
     FROM UNIFORMES.TAEMPLEADOS EMP
    INNER JOIN UNIFORMES.TAPEDIDOS PD
       ON (EMP.FIEMPLEADO = PD.FIEMPLEADO)
    WHERE EMP.FCSITUACION =  vlSituacionEmpleado
      AND EMP.FIEMPLEADO = paIdEmpleado
      AND EMP.FIFUNCION = paFuncionEmpleado;
      
   IF(vlFechaUltimaReg <= vlFechaCompara )
   THEN
        OPEN paCurSolicitud FOR
             SELECT TO_NUMBER(SUBSTR(EMP.FICECO, vlTres, vlCuatro)) AS SUCURSAL 
                        , EMP.FIEMPLEADO 
                        , EMP.FCNOMBRE
                        , EMP.FCPOSICION
                        , EMP.FCGENERO
                        , TPROD.FCDESCRIPCION  DESCPROD
                        , TALLA.FCCLAVE
                        , TALLA.FITALLA
                        , PROD.FNCOSTO   
                        , PROD.FNCOSTO FNDESCUENTO   
                        , EMP.FIFUNCION    
                        , CECO.FCIDCANAL AS FIUNIDADNEGOCIO 
                        , PROD.FITIPO    
                        , PROD.FISKU 
                        , TALLA.FCDESCRIPCION
              FROM  UNIFORMES.TAEMPLEADOS EMP
      INNER JOIN UNIFORMES.TACECO CECO
                  ON (EMP.FICECO = CECO.FICC)
      INNER JOIN UNIFORMES.TAFUNCIONES FUN
                  ON (FUN.FIFUNCIONSAP = EMP.FIFUNCION AND TRIM(CECO.FCIDCANAL)=TRIM(FUN.FCIDCANAL))
      INNER JOIN UNIFORMES.TAKITS KIT
                  ON (KIT.FIKIT = FUN.FIKIT)
      INNER JOIN UNIFORMES.TAPRODUCTOSXKIT PXKIT
                  ON (KIT.FIKIT = PXKIT.FIKIT)
      INNER JOIN UNIFORMES.TAPRODUCTOS PROD
                  ON (PXKIT.FISKU = PROD.FISKU)
      INNER JOIN UNIFORMES.TATIPOSPRODUCTO TPROD
                  ON (PROD.FITIPO = TPROD.FITIPO)
      INNER JOIN UNIFORMES.TATALLAS TALLA
                  ON (PROD.FITALLA = TALLA.FITALLA)
            WHERE EMP.FCSITUACION =  vlSituacionEmpleado
                AND EMP.FIEMPLEADO = paIdEmpleado
                AND EMP.FIFUNCION = paFuncionEmpleado
                AND PROD.FCGENERO IN (vlGeneroU,paGeneroEmpleado )
       ORDER BY EMP.FIEMPLEADO, DESCPROD, FITALLA;
       
   ELSE
      Raise_Application_Error ( vlNoDatos, 'No puedes solicitar Pedidos hasta que se cumplan 8 semanas de tu ultima solicitud.');
   END IF;
                     
END SPSOLICITUDINDIVIDUAL;

PROCEDURE SPCONSULTASUCURSALPEDIDO(
   paTienda        IN    UNIFORMES.TASUCURSALES.FISUCURSAL%TYPE,
   paFolioCentral       IN  UNIFORMES.TAPEDIDOS.FIFOLIOCENTRAL%TYPE, 
   paCurSucursal  OUT   rcgCursor,
   parCurSucursalPedido OUT   rcgCursor)
  IS
/********************************************************************************
   Descripcion: Función que regresa los datos de la sucursal
   Parámetros de entrada: paTienda
   Parámetros de salida: paCurSolicitud
   Parámetros de entrada-salida: Ninguno
   Valor de retorno: Cursor con resultado.
   Creador: Rogelio Esteban Arvea Perez
   Fecha de creación: 24 Septiembre 2014
**************************************************************************************/  
   cslEstatusPed UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE := 80;
   
BEGIN
   OPEN paCurSucursal FOR 
      SELECT  SUC.FISUCURSAL
                 , SUC.FCDESCRIPCION
                 , SUC.FCDIRIP
                 , SUC.FIIDCDISTRIBUCION
                 , SUC.FIIDFORMADOR
        FROM  UNIFORMES.TASUCURSALES SUC  
       WHERE SUC.FISUCURSAL = paTienda;

   OPEN parCurSucursalPedido FOR
        SELECT P.FIEMPLEADO
               ,RM.FISKU
               ,DEP.FICANTIDAD
               ,RM.FIPEDIDO
          FROM UNIFORMES.TAPEDIDOS P
         INNER JOIN UNIFORMES.TADETALLEPEDIDOS DEP
            ON (P.FIFOLIOCENTRAL = DEP.FIFOLIOCENTRAL)
         INNER JOIN UNIFORMES.TAREMISIONES  RM 
            ON (P.FIFOLIOCENTRAL = RM.FIFOLIOCENTRAL  AND DEP.FIPEDIDO=RM.FIPEDIDO)  
         WHERE P.FIFOLIOCENTRAL = paFolioCentral
           AND RM.FISUCURSAL = paTienda
           AND DEP.FIESTATUS = cslEstatusPed
           AND (RM.FIPEDIDO, RM.FISUCURSAL, RM.FIREMISION, DEP.FICANTIDAD) IN (
                SELECT RM.FIPEDIDO,
                       RM.FISUCURSAL,
                       MAX(RM.FIREMISION),
                       SUM(RM.FICANTIDAD)
                  FROM UNIFORMES.TAPEDIDOS P
                 INNER JOIN UNIFORMES.TADETALLEPEDIDOS DEP
                    ON (P.FIFOLIOCENTRAL = DEP.FIFOLIOCENTRAL)
                 INNER JOIN UNIFORMES.TAREMISIONES  RM 
                    ON (P.FIFOLIOCENTRAL = RM.FIFOLIOCENTRAL  AND DEP.FIPEDIDO=RM.FIPEDIDO)  
                 WHERE P.FIFOLIOCENTRAL = paFolioCentral
                   AND RM.FISUCURSAL = paTienda
                   AND DEP.FIESTATUS = cslEstatusPed
                 GROUP BY RM.FIPEDIDO,
                       RM.FISUCURSAL);

      
END SPCONSULTASUCURSALPEDIDO;

END PAWSUNIFORMES;
/

SHOW ERRORS;


CREATE OR REPLACE PACKAGE BODY PAWEBUNIFORMESCOMERCIO2
AS
  /*************************************************************
   Proyecto:                           Uniformes Comercio V2
   Descripcion:                        Paquete para sistema de uniformes Div. Comercial
   Parametros de entrada:              No aplica
   Parametros de salida:               No aplica
   Parametros de entrada-salida        No aplica
   Precondiciones:                     Tener creado el esquema
   Creador:                            
   Fecha de creacion:                  
   *************************************************************/
  	vgErrCode               NUMBER(6):= 0;          -- Variable para el manejo de errores codigo
    vgErrMsg                VARCHAR2(500 CHAR):= '';-- Variable para el manejo de errores mensaje
    csgCero                 CONSTANT NUMBER(1):=0;
    csgUno                  CONSTANT NUMBER(1):=1;
    csgDos                  CONSTANT NUMBER(1):=2;
    csgTres                 CONSTANT NUMBER(1):=3;    
    csgCuatro               CONSTANT NUMBER(1):=4; 
    csgDieceNueve           CONSTANT NUMBER(2):=19;
    csgCien                 CONSTANT NUMBER(3):=100;
    csgFalso                CONSTANT NUMBER(1):=0;    
    csgCierto               CONSTANT NUMBER(1):=1;
    csgCancelado            CONSTANT NUMBER(1):=0;  -- Cancelado
    csgPendiente            CONSTANT NUMBER(1):=1;  -- Pendiente de solicitar a CD
    csgSolicitado           CONSTANT NUMBER(1):=2;  -- Solicitado a CD
    csgAtendido             CONSTANT NUMBER(1):=3;  -- Atendido en CD
    csgEnCamino             CONSTANT NUMBER(1):=4;  -- En camino a tienda
    csgRecibido             CONSTANT NUMBER(1):=5;  -- Recibido en tienda
    csgEntregado            CONSTANT NUMBER(1):=6;  -- Entregado    
    csgCadenaCancelado      CONSTANT VARCHAR2(50 CHAR):='CANCELADO';                     -- Cancelado
    csgCadenaPendiente      CONSTANT VARCHAR2(50 CHAR):='PENDIENTE DE SOLICITAR A CD';   -- Pendiente de solicitar a CD
    csgCadenaSolicitado     CONSTANT VARCHAR2(50 CHAR):='SOLICITADO A CD';               -- Solicitado a CD
    csgCadenaAtendido       CONSTANT VARCHAR2(50 CHAR):='ATENDIDO EN CD';                -- Atendido en CD
    csgCadenaEnCamino       CONSTANT VARCHAR2(50 CHAR):='EN CAMINO A TIENDA';            -- En camino a tienda
    csgCadenaRecibido       CONSTANT VARCHAR2(50 CHAR):='RECIBIDO EN TIENDA';            -- Recibido en tienda
    csgCadenaEntregado      CONSTANT VARCHAR2(50 CHAR):='ENTREGADO';                     -- Entregado

 FUNCTION FNCONSULTASOLICITUDES(
    paNumeroEmpleado UNIFORMES.TASOLICITUDES.FIIDEMPLEADO%TYPE, 
    paNumeroSolicitudes NUMBER)
 RETURN rcgCursor
 IS
 curDatos rcgCursor;
 /*************************************************************
   Proyecto:                         Uniformes Comercio V2
   Descripcion:                      Consulta de solicitudes del empleado
   Parametros de entrada:            Numero del empleado, Numero de solicitudes
   Parametros de salida:             Retorna las solicitudes del empleado
   Parametros de entrada-salida      No aplica
   Precondiciones:                   Tener creado el esquema
   Creador:                          Luis Daniel Rodriguez Garcia
   Fecha de creacion:                16 de Septiembre del 2017
  *************************************************************/
 BEGIN  
 OPEN curDatos FOR
    SELECT  S.FIFOLIOSOLICITUD, 
            TO_CHAR(S.FDFECHACAPTURA,'dd/mm/yyyy') AS FCFECHACAPTURA,
            T.FISUCURSAL,
            T.FCNOMBRE                
    FROM UNIFORMES.TASOLICITUDES S
    INNER JOIN UNIFORMES.TAEMPLEADOS E
        ON S.FIIDEMPLEADO = E.FIEMPLEADO
    INNER JOIN (SELECT FIFOLIOSOLICITUD, FIPAIS, FICANAL, FISUCURSAL FROM UNIFORMES.TASOLICITUDESDETALLE GROUP BY FIFOLIOSOLICITUD, FIPAIS, FICANAL, FISUCURSAL) SD
        ON SD.FIFOLIOSOLICITUD = S.FIFOLIOSOLICITUD
    INNER JOIN UNIFORMES.TATIENDAS T
        ON T.FIPAIS = SD.FIPAIS
        AND T.FICANAL = SD.FICANAL
        AND T.FISUCURSAL = SD.FISUCURSAL
    WHERE S.FIIDEMPLEADO = paNumeroEmpleado AND ROWNUM <= paNumeroSolicitudes
    ORDER BY S.FDFECHACAPTURA DESC;   

       
 RETURN curDatos;
 EXCEPTION
    WHEN OTHERS THEN
        vgErrCode := SQLCODE;
        vgErrMsg := SQLERRM;
        RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PAWEBUNIFORMESCOMERCIO2.FNCONSULTASOLICITUDES": ' || vgErrMsg);
        
 END FNCONSULTASOLICITUDES;

 FUNCTION FNCONSULTASOLICITUD(
    paNoFolioSolicitud UNIFORMES.TASOLICITUDES.FIFOLIOSOLICITUD%TYPE)  
 RETURN rcgCursor
 IS
 curDatos rcgCursor;
    /*************************************************************
    Proyecto:                         Uniformes Comercio V2
    Descripcion:                      Consulta la solicitud
    Parametros de entrada:            Folio de solicitud
    Parametros de salida:             Datos de la tienda (Cursor)
    Parametros de entrada-salida      No aplica
    Precondiciones:                   Tener creado el esquema
    Creador:                          Luis Rodriguez
    Fecha de creacion:                16 de Septiembre del 2017
    *************************************************************/
 BEGIN  
 OPEN curDatos FOR
/*     SELECT TBS.FINUMPEDIDO,
            TO_CHAR(TBS.FISKU) AS FCSKU, 
            FNDEFINEDESCRIPCIONPRENDA(TBS.FISKU,TSD.FIIDTIPOPRENDA) AS FCDESCRIPCION,
            FNNOREMISION(TBS.FINUMPEDIDO,TBS.FISKU) AS FIREMISION,
            TSD.FICANTIDAD,
            FNCADENAESTADOESTATUS(TBS.FIIDESTATUSNVO) AS FCIDESTATUSNVO,
            TBS.FIIDDETALLE,
            TO_CHAR(TBS.FDFECHAEVENTO, 'dd/mm/yyyy HH24:MI:SS') AS FCFECHAEVENTO
     FROM   (SELECT TBSAUX.FIFOLIOSOLICITUD, 
                    TBSAUX.FINUMPEDIDO, 
                    TBSAUX.FISKU,
                    TBSAUX.FIIDESTATUSNVO,
                    TBSAUX.FIIDDETALLE,
                    TBSAUX.FDFECHAEVENTO
            FROM    (SELECT FIIDDETALLE, 
                            MAX(FDFECHAEVENTO) AS FDFECHAEVENTO
                        FROM UNIFORMES.TABITACORASOLICITUD 
                    WHERE FIFOLIOSOLICITUD = paNoFolioSolicitud 
                    GROUP BY FIIDDETALLE) TBSORDEN
            INNER JOIN UNIFORMES.TABITACORASOLICITUD TBSAUX
                ON TBSAUX.FIIDDETALLE = TBSORDEN.FIIDDETALLE
                AND TBSAUX.FDFECHAEVENTO = TBSORDEN.FDFECHAEVENTO) TBS
     INNER JOIN UNIFORMES.TASOLICITUDESDETALLE TSD
        ON TSD.FIFOLIOSOLICITUD = TBS.FIFOLIOSOLICITUD 
        AND TSD.FIIDDETALLE = TBS.FIIDDETALLE; */
        
--   USO RANK OVER    
    SELECT  TBS.FINUMPEDIDO,
            TO_CHAR(TBS.FISKU) AS FCSKU, 
            FNDEFINEDESCRIPCIONPRENDA(TBS.FISKU,TSD.FIIDTIPOPRENDA) AS FCDESCRIPCION,
            FNNOREMISION(TBS.FINUMPEDIDO,TBS.FISKU) AS FIREMISION,
            TSD.FICANTIDAD,
            FNCADENAESTADOESTATUS(TBS.FIIDESTATUSNVO) AS FCIDESTATUSNVO,
            TBS.FIIDDETALLE,
            TO_CHAR(TBS.FDFECHAEVENTO, 'dd/mm/yyyy HH24:MI:SS') AS FCFECHAEVENTO
     FROM   (SELECT FIFOLIOSOLICITUD, 
                    FINUMPEDIDO, 
                    FISKU,
                    FIIDESTATUSNVO,
                    FIIDDETALLE,
                    FDFECHAEVENTO                
                FROM (SELECT    FIFOLIOSOLICITUD, 
                                FINUMPEDIDO, 
                                FISKU,
                                FIIDESTATUSNVO,
                                FIIDDETALLE,
                                FDFECHAEVENTO,
                                RANK() OVER (PARTITION BY FIIDDETALLE ORDER BY FDFECHAEVENTO DESC) ESCIERTO
                        FROM UNIFORMES.TABITACORASOLICITUD) 
                WHERE ESCIERTO = csgCierto AND FIFOLIOSOLICITUD = paNoFolioSolicitud) TBS
     INNER JOIN UNIFORMES.TASOLICITUDESDETALLE TSD
        ON TSD.FIFOLIOSOLICITUD = TBS.FIFOLIOSOLICITUD 
        AND TSD.FIIDDETALLE = TBS.FIIDDETALLE;        
 RETURN curDatos;
 
 EXCEPTION
    WHEN OTHERS THEN
        vgErrCode := SQLCODE;
        vgErrMsg := SQLERRM;
        RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PAWEBUNIFORMESCOMERCIO2.FNCONSULTASOLICITUD": ' || vgErrMsg);
      
 END FNCONSULTASOLICITUD;

 FUNCTION FNNOREMISION(
    paNoPedido UNIFORMES.TABITACORASOLICITUD.FINUMPEDIDO%TYPE,
    paNoSKU UNIFORMES.TABITACORASOLICITUD.FISKU%TYPE)
 RETURN NUMBER
 IS
 vlNoRemision UNIFORMES.TAREMISIONESXPEDIDO.FIREMISION%TYPE;
    /*************************************************************
    Proyecto:                         Uniformes Comercio V2
    Descripcion:                      Retorna la numero de remision
    Parametros de entrada:            Numero del pedido, Numero del SKU
    Parametros de salida:             Retorna la numero de remision
    Parametros de entrada-salida      No aplica
    Precondiciones:                   Tener creado el esquema
    Creador:                          Luis Daniel Rodriguez Garcia
    Fecha de creacion:                1 de Enero del 2017
    *************************************************************/
 BEGIN
    SELECT FIREMISION 
        INTO vlNoRemision 
    FROM UNIFORMES.TAREMISIONESXPEDIDO
        WHERE FIPEDIDO = paNoPedido
        AND FISKU = paNoSKU;
 RETURN vlNoRemision;
 
 END FNNOREMISION;
 
 FUNCTION FNCADENAESTADOESTATUS(
    paNoEstadoNuevo UNIFORMES.TABITACORASOLICITUD.FIIDESTATUSNVO%TYPE)
 RETURN VARCHAR2
 IS
 vlCadenaDescripcionEstatus UNIFORMES.TAESTATUSPEDIDOS.FCDESCRIPCION%TYPE;
    /*************************************************************
    Proyecto:                         Uniformes Comercio V2
    Descripcion:                      Retorna la numero de remision
    Parametros de entrada:            Numero del pedido, Numero del SKU
    Parametros de salida:             Retorna la numero de remision
    Parametros de entrada-salida      No aplica
    Precondiciones:                   Tener creado el esquema
    Creador:                          Luis Daniel Rodriguez Garcia
    Fecha de creacion:                1 de Enero del 2017
    *************************************************************/
 BEGIN

    vlCadenaDescripcionEstatus :=   (CASE paNoEstadoNuevo
                                        WHEN csgCancelado   THEN csgCadenaCancelado
                                        WHEN csgPendiente   THEN csgCadenaPendiente
                                        WHEN csgSolicitado  THEN csgCadenaSolicitado
                                        WHEN csgAtendido    THEN csgCadenaAtendido
                                        WHEN csgEnCamino    THEN csgCadenaEnCamino
                                        WHEN csgRecibido    THEN csgCadenaRecibido
                                        WHEN csgEntregado   THEN csgCadenaEntregado
                                     END);
 RETURN vlCadenaDescripcionEstatus;
 
 END FNCADENAESTADOESTATUS;

 

 FUNCTION FNDEFINEDESCRIPCIONPRENDA(
    paSKU UNIFORMES.TABITACORASOLICITUD.FISKU%TYPE,
    paIDTipoPrenda UNIFORMES.TASOLICITUDESDETALLE.FIIDTIPOPRENDA%TYPE)
 RETURN VARCHAR2
 IS
 vlCadenaDescripcion VARCHAR2(50);
 /*************************************************************
    Proyecto:                         Uniformes Comercio V2
    Descripcion:                      Retorna la descripcion de la prenda
    Parametros de entrada:            SKU de la tienda, Tipo de prenda
    Parametros de salida:             Retorna la descripcion en una cadena
    Parametros de entrada-salida      No aplica
    Precondiciones:                   Tener creado el esquema
    Creador:                          Luis Daniel Rodriguez Garcia
    Fecha de creacion:                16 de Septiembre del 2017
 *************************************************************/    
 BEGIN
        IF paSKU is NULL THEN
            SELECT  FCDESCRIPCION 
                    INTO vlCadenaDescripcion
            FROM UNIFORMES.TATIPOSPRENDA
                WHERE FIIDTIPOPRENDA = paIDTipoPrenda;
        ELSE
            SELECT  FCDESCRIPCION 
                    INTO vlCadenaDescripcion
            FROM UNIFORMES.TAPRENDAS 
                WHERE TAPRENDAS.FISKU = paSKU;
        END IF;
        
 RETURN vlCadenaDescripcion;   
    
 EXCEPTION
    WHEN OTHERS THEN
        vgErrCode := SQLCODE;
        vgErrMsg := SQLERRM;
        RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PAWEBUNIFORMESCOMERCIO2.FNDEFINEDESCRIPCIONPRENDA": ' || vgErrMsg); 

 END FNDEFINEDESCRIPCIONPRENDA;

 FUNCTION FNCONSULTASOLICITUDAVANCE(
    paNoFolioSolicitud UNIFORMES.TASOLICITUDES.FIFOLIOSOLICITUD%TYPE)
 RETURN rcgCursor
 IS
 /*************************************************************
    Proyecto:                         Uniformes Comercio V2
    Descripcion:                      Muestra el estatus de la solicitud
    Parametros de entrada:            Folio de la solicitud
    Parametros de salida:             Retorna los datos de la solicitud del avance
    Parametros de entrada-salida      No aplica
    Precondiciones:                   Tener creado el esquema
    Creador:                          Luis Rodriguez
    Fecha de creacion:                16 de Septiembre del 2017
 *************************************************************/   
 curDatos rcgCursor;
 vlCalculoPorcentaje NUMBER(5,2); 
 BEGIN
 vlCalculoPorcentaje := FNCALCULOPORCENTAJE(paNoFolioSolicitud);
 OPEN curDatos FOR
    SELECT    
            FNCADENAPORCENTAJE(CANCELADO * vlCalculoPorcentaje)   AS FCPORCCANCELADO,
            FNCADENAPORCENTAJE(
                    (CASE PENDIENTE
                        WHEN csgFalso THEN csgCero
                        ELSE PENDIENTE/csgDos
                    END) * vlCalculoPorcentaje)                   AS FCPORCPENDIENTE,
            FNCADENAPORCENTAJE(
                    (CASE (PENDIENTE + SOLICITADO)
                        WHEN csgFalso THEN csgCero
                        ELSE (PENDIENTE + SOLICITADO)/csgTres
                    END) * vlCalculoPorcentaje)                   AS FCPORCSOLICITADO,
            FNCADENAPORCENTAJE(ATENDIDO * vlCalculoPorcentaje)    AS FCPORCATENDIDO,
            FNCADENAPORCENTAJE(CAMINO * vlCalculoPorcentaje)      AS FCPORCCAMINO,
            FNCADENAPORCENTAJE(RECIBIDO * vlCalculoPorcentaje)    AS FCPORCRECIBIDO,        
            FNCADENAPORCENTAJE(ENTREGADO * vlCalculoPorcentaje)   AS FCPORCENTREGADO
    FROM (SELECT FIIDESTATUSNVO FROM UNIFORMES.TABITACORASOLICITUD WHERE FIFOLIOSOLICITUD = paNoFolioSolicitud) 
    PIVOT (count(FIIDESTATUSNVO) for FIIDESTATUSNVO in  
            (
                0 AS CANCELADO,
                1 AS PENDIENTE,
                2 AS SOLICITADO,
                3 AS ATENDIDO,
                4 AS CAMINO,    
                5 AS RECIBIDO,
                6 AS ENTREGADO
            )
    );
    
 RETURN curDatos;
    
 EXCEPTION
    WHEN OTHERS THEN
        vgErrCode := SQLCODE;
        vgErrMsg := SQLERRM;
        RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PAWEBUNIFORMESCOMERCIO2.FNCONSULTASOLICITUDAVANCE": ' || vgErrMsg);     

 END FNCONSULTASOLICITUDAVANCE;

 FUNCTION FNCADENAPORCENTAJE(
    paNoPorcentaje NUMBER) 
 RETURN VARCHAR2
 IS
 vlCadenaPorcentaje VARCHAR2(10 CHAR); 
 /*************************************************************
    Proyecto:                         Uniformes Comercio V2
    Descripcion:                      Transforma la cantidad numerica a cadena con porciento.
    Parametros de entrada:            Numero Porcentaje
    Parametros de salida:             Retorna una cadena por el valor del porcentaje.
    Parametros de entrada-salida      No aplica
    Precondiciones:                   Tener creado el esquema
    Creador:                          Luis Rodriguez
    Fecha de creacion:                16 de Septiembre del 2017
 *************************************************************/          
 BEGIN
 vlCadenaPorcentaje := TO_CHAR(paNoPorcentaje,'990') || '%';
 vlCadenaPorcentaje := TRIM(vlCadenaPorcentaje);   
    
 RETURN vlCadenaPorcentaje;
 EXCEPTION
    WHEN OTHERS THEN
        vgErrCode := SQLCODE;
        vgErrMsg := SQLERRM;
        RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PAWEBUNIFORMESCOMERCIO2.FNCADENAPORCENTAJE": ' || vgErrMsg);    
            
END FNCADENAPORCENTAJE;


 FUNCTION FNCALCULOPORCENTAJE(
    paNoFolioSolicitud UNIFORMES.TASOLICITUDESDETALLE.FIFOLIOSOLICITUD%TYPE)
 RETURN NUMBER
 IS
 /*************************************************************
    Proyecto:                         Uniformes Comercio V2
    Descripcion:                      Realiza la operacion del calculo del porcentaje
    Parametros de entrada:            Folio de la solicitud
    Parametros de salida:             Retorna los datos de la solicitud del avance
    Parametros de entrada-salida      No aplica
    Precondiciones:                   Tener creado el esquema
    Creador:                          Luis Rodriguez
    Fecha de creacion:                16 de Septiembre del 2017
 *************************************************************/   
 vlContador NUMBER(3);
 vlDivision NUMBER(5,2); 
 BEGIN  
 
    SELECT  COUNT(FIFOLIOSOLICITUD) 
            INTO vlContador 
    FROM UNIFORMES.TASOLICITUDESDETALLE 
    WHERE FIFOLIOSOLICITUD = paNoFolioSolicitud;
    
    vlDivision :=   (CASE vlContador
                        WHEN csgCero THEN csgCero
                        ELSE csgCien/vlContador
                    END);
 RETURN vlDivision;
 EXCEPTION
    WHEN OTHERS THEN
        vgErrCode := SQLCODE;
        vgErrMsg := SQLERRM;
        RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PAWEBUNIFORMESCOMERCIO2.FNCALCULOPORCENTAJE": ' || vgErrMsg);       

END FNCALCULOPORCENTAJE;

 FUNCTION FNCONSULTASOLICITUDESV(
    paNumeroEmpleado UNIFORMES.TASOLICITUDES.FIIDEMPLEADO%TYPE,
    paNumeroSolicitudes NUMBER)
 RETURN rcgCursor
 IS
 curDatos rcgCursor;
 /*************************************************************
    Proyecto:                         Uniformes Comercio V2
    Descripcion:                      Consulta las solicitudes voluntarias
    Parametros de entrada:            Numero de empleado, Folio de la solicitud
    Parametros de salida:             Retorna los datos de la solicitud voluntaria
    Parametros de entrada-salida      No aplica
    Precondiciones:                   Tener creado el esquema
    Creador:                          Luis Rodriguez
    Fecha de creacion:                16 de Septiembre del 2017
 *************************************************************/   
 BEGIN
 OPEN curDatos FOR
    SELECT  S.FIFOLIOSOLICITUD, 
            TO_CHAR(S.FDFECHACAPTURA,'dd/mm/yyyy') AS FCFECHACAPTURA,
            T.FISUCURSAL,
            T.FCNOMBRE                
    FROM UNIFORMES.TASOLICITUDES S
    INNER JOIN UNIFORMES.TAEMPLEADOS E
        ON S.FIIDEMPLEADO = E.FIEMPLEADO
        AND S.FIIDTIPOSOLICITUD = 2
    INNER JOIN (SELECT FIFOLIOSOLICITUD, FIPAIS, FICANAL, FISUCURSAL FROM UNIFORMES.TASOLICITUDESDETALLE GROUP BY FIFOLIOSOLICITUD, FIPAIS, FICANAL, FISUCURSAL) SD
        ON SD.FIFOLIOSOLICITUD = S.FIFOLIOSOLICITUD
    INNER JOIN UNIFORMES.TATIENDAS T
        ON T.FIPAIS = SD.FIPAIS
        AND T.FICANAL = SD.FICANAL
        AND T.FISUCURSAL = SD.FISUCURSAL
    WHERE S.FIIDEMPLEADO = paNumeroEmpleado AND ROWNUM <= paNumeroSolicitudes
    ORDER BY S.FDFECHACAPTURA DESC; 

 RETURN curDatos;
 EXCEPTION
    WHEN OTHERS THEN
        vgErrCode := SQLCODE;
        vgErrMsg := SQLERRM;
        RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PAWEBUNIFORMESCOMERCIO2.FNCONSULTASOLICITUDESV": ' || vgErrMsg);        

 END FNCONSULTASOLICITUDESV;

 FUNCTION FNPEDIDOSPORPRECIO(
    paFolioSolicitud UNIFORMES.TAPEDIDOSCD.FIFOLIOSOLICITUD%TYPE)
 RETURN rcgCursor
 IS
 curDatos rcgCursor;
 anoActual Number(4);
 /*************************************************************
    Proyecto:                         Uniformes Comercio V2
    Descripcion:                      Muestra los pedidos con su precio
    Parametros de entrada:            Folio de la solicitud
    Parametros de salida:             Retorna todos los pedidos
    Parametros de entrada-salida      No aplica
    Precondiciones:                   Tener creado el esquema
    Creador:                          Luis Rodriguez
    Fecha de creacion:                16 de Septiembre del 2017
 *************************************************************/
 BEGIN
 
 anoActual := (TO_NUMBER(TO_CHAR(SYSDATE, 'YYYY')));
 
 OPEN curDatos FOR
    SELECT  TPCD.FIPEDIDO,
            TPCD.FIFOLIOSOLICITUD,
            TO_CHAR(TPCD.FISKU) AS FCSKU,
            TP.FCDESCRIPCION,
            TO_CHAR((FNTOTDESCUENTO - FNSALDO),'FM$99990.00') AS FCPAGADO,
            TPCD.FICANTIDAD,
            TO_CHAR(TDS.FNTOTDESCUENTO,'FM$99990.00') AS FCCOSTOPRENDA,
            TDS.FISEMADESCUENTO AS FISEMANA,
            TO_CHAR((TDS.FNSALDO),'FM$99990.00') AS FCSALDOPORPAGAR,
            TO_CHAR(TDS.FNPAGO) AS FCPAGOSEMANAL,
            TO_CHAR(TDS.FDPAGO) AS FCFECHAPAGO,
            TTP.FCIMAGEN AS FCNOMBREIMAGEN
    FROM UNIFORMES.TADESCUENTOSSAP TDS
    INNER JOIN
                (SELECT FIFOLIOCENTRAL,
                        FIPEDIDO, 
                        MAX(FDPAGO) AS FDPAGO 
                    FROM UNIFORMES.TADESCUENTOSSAP 
                    WHERE FIFOLIOCENTRAL = paFolioSolicitud 
                            AND (
                            CASE 
                                WHEN (TO_NUMBER(TO_CHAR(FDPAGO, 'YYYY'))) < anoActual THEN 1   
                                WHEN (TO_NUMBER(TO_CHAR(FDPAGO, 'YYYY'))) = anoActual THEN   
                                    CASE 
                                        WHEN ((FISEMADESCUENTO) <= (SELECT (TO_NUMBER(TO_CHAR(SYSDATE, 'WW'))) FROM DUAL)) THEN 1
                                        ELSE 0
                                    END
                                ELSE 0
                            END
                            ) = 1
                    GROUP BY FIFOLIOCENTRAL,FIPEDIDO) TDSGROUPBY
        ON TDS.FIFOLIOCENTRAL = TDSGROUPBY.FIFOLIOCENTRAL 
        AND TDS.FIPEDIDO = TDSGROUPBY.FIPEDIDO 
        AND TDS.FDPAGO = TDSGROUPBY.FDPAGO
    INNER JOIN (SELECT  FIPEDIDO,
                        FIFOLIOSOLICITUD,
                        FISKU,
                        FICANTIDAD 
                FROM UNIFORMES.TAPEDIDOSCD 
                WHERE FIFOLIOSOLICITUD = paFolioSolicitud) TPCD
        ON TDSGROUPBY.FIFOLIOCENTRAL = TPCD.FIFOLIOSOLICITUD 
        AND TDSGROUPBY.FIPEDIDO = TPCD.FIPEDIDO
    INNER JOIN (SELECT  FISKU,
                        FCDESCRIPCION,
                        FIIDTIPOPRENDA 
                    FROM UNIFORMES.TAPRENDAS) TP
        ON TP.FISKU = TPCD.FISKU
    INNER JOIN (SELECT  FIIDTIPOPRENDA,
                        FCIMAGEN 
                    FROM UNIFORMES.TATIPOSPRENDA) TTP
        ON TTP.FIIDTIPOPRENDA = TP.FIIDTIPOPRENDA
    ORDER BY TPCD.FIPEDIDO;
 RETURN curDatos;   
 
 EXCEPTION
    WHEN OTHERS THEN
        vgErrCode := SQLCODE;
        vgErrMsg := SQLERRM;
        RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PAWEBUNIFORMESCOMERCIO2.FNPEDIDOSPORPRECIO": ' || vgErrMsg);     

 END FNPEDIDOSPORPRECIO;

 FUNCTION FNINFORMACIONDESCUENTO(
    paFolioSolicitud UNIFORMES.TAPEDIDOSCD.FIFOLIOSOLICITUD%TYPE,
    paNumeroPedido UNIFORMES.TAPEDIDOSCD.FIPEDIDO%TYPE)
 RETURN rcgCursor
 IS
 curDatos rcgCursor;
  /*************************************************************
    Proyecto:                         Uniformes Comercio V2
    Descripcion:                      Muestra a mayor detalle el descuento
    Parametros de entrada:            Folio de la solicitud
    Parametros de salida:             Retorna todos los pedidos
    Parametros de entrada-salida      No aplica
    Precondiciones:                   Tener creado el esquema
    Creador:                          Luis Rodriguez
    Fecha de creacion:                16 de Septiembre del 2017
  *************************************************************/   
 BEGIN
 OPEN curDatos FOR

    SELECT  TO_CHAR(TDSAP.FDPAGO, 'YYYY') AS FCANO,
            TDSAP.FISEMADESCUENTO,
            TO_CHAR(TDSAP.FDPAGO) AS FCFECHAPAGO,
            TO_CHAR(TDSAP.FNTOTDESCUENTO,'FM$99990.00') AS FCCOSTOPRENDA,
            TO_CHAR(TDSAP.FNSALDO,'FM$99990.00') AS FCSALDOPORPAGAR,
            TO_CHAR(TDSAP.FNPAGO,'FM$99990.00') AS FCPAGOSEMANAL
    FROM UNIFORMES.TAPEDIDOSCD TPCD
    INNER JOIN UNIFORMES.TADESCUENTOSSAP TDSAP
        ON TDSAP.FIFOLIOCENTRAL = TPCD.FIFOLIOSOLICITUD
        AND TDSAP.FIPEDIDO = TPCD.FIPEDIDO
    WHERE TPCD.FIFOLIOSOLICITUD = paFolioSolicitud AND TPCD.FIPEDIDO = paNumeroPedido
    ORDER BY TDSAP.FDPAGO;
    
 RETURN curDatos;        
        
 EXCEPTION
    WHEN OTHERS THEN
        vgErrCode := SQLCODE;
        vgErrMsg := SQLERRM;
        RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PAWEBUNIFORMESCOMERCIO2.FNINFORMACIONDESCUENTO": ' || vgErrMsg);          

 END FNINFORMACIONDESCUENTO;
 
 PROCEDURE SPGUARDACONFIRMACIONENTREGA(
    paConfirmacionesEntrega IN UNIFORMES.TYPEARRCONFIRMACIONENTREGA,
    paNoConfirmaciones OUT NUMBER )
 IS
 vlIdBitacora 	 UNIFORMES.TABITACORASOLICITUD.FIIDBITACORA%TYPE;
   
  /************************************************************************************************************
    Proyecto:              Uniformes Comercio V2
    Descripcion:           Agrega a la tabla TABITACORASOLICITUD y actualiza TAPEDIDOSCD
    Parametros de entrada: TYPARRAY
    Parametros de salida:  Respuesta del Stored Procedure
    Parametros de ent-sal: No aplica
    Valor de retorno:      No aplica 
    Creador:               Luis Daniel Rodriguez Garcia
    Fecha de creacion:     11 Enero de 2017
 *************************************************************************************************************/   
 BEGIN
    FOR indice IN 1..paConfirmacionesEntrega.count
        LOOP
            BEGIN
		    	SELECT NVL(MAX(FIIDBITACORA), csgCero) + 1 
		    	  INTO vlIdBitacora
		    	  FROM UNIFORMES.TABITACORASOLICITUD;
            END;
            INSERT INTO UNIFORMES.TABITACORASOLICITUD(
                FIIDBITACORA,
                FIFOLIOSOLICITUD,
                FIIDDETALLE,
                FIPAIS,
                FICANAL,
                FIIDSUCURSAL,
                FINUMPEDIDO,
                FISKU,
                FIIDTIPOEVENTO,
                FXDATOS,
                FIIDESTATUSANT,
                FIIDESTATUSNVO,
                FDFECHAEVENTO,
                FIIDERROR,
                FCCOMENTARIOS
            ) VALUES (
                    vlIdBitacora,
                    paConfirmacionesEntrega(indice).FIFOLIOSOLICITUD,
                    paConfirmacionesEntrega(indice).FIIDDETALLE,
                    paConfirmacionesEntrega(indice).FIPAIS,
                    paConfirmacionesEntrega(indice).FICANAL,
                    paConfirmacionesEntrega(indice).FIIDSUCURSAL,
                    paConfirmacionesEntrega(indice).FINUMPEDIDO,
                    paConfirmacionesEntrega(indice).FISKU,
                    paConfirmacionesEntrega(indice).FIIDTIPOEVENTO,
                    CONCAT(CONCAT('<?xml version="1.0"?><INFORMACION>',paConfirmacionesEntrega(indice).FCDATOS),'</INFORMACION>'),
                    paConfirmacionesEntrega(indice).FIIDESTATUSANT,
                    paConfirmacionesEntrega(indice).FIIDESTATUSNVO,
                    SYSDATE,
                    paConfirmacionesEntrega(indice).FIERROR,   
                    paConfirmacionesEntrega(indice).FCCOMENTARIOS                 
                );
                
            UPDATE UNIFORMES.TAPEDIDOSCD 
                SET FIIDESTATUSPEDIDO = paConfirmacionesEntrega(indice).FIIDESTATUSNVO 
            WHERE FIPAIS = paConfirmacionesEntrega(indice).FIPAIS
                AND FICANAL = paConfirmacionesEntrega(indice).FICANAL
                AND FIIDSUCURSAL = paConfirmacionesEntrega(indice).FIIDSUCURSAL
                AND FIPEDIDO = paConfirmacionesEntrega(indice).FINUMPEDIDO
                AND FISKU = paConfirmacionesEntrega(indice).FISKU;
    END LOOP;
    
    COMMIT;
    
    paNoConfirmaciones := paConfirmacionesEntrega.count;
    
    EXCEPTION
        WHEN OTHERS THEN
              ROLLBACK;
              vgErrCode := SQLCODE;
              vgErrMsg := SQLERRM;
              RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' "PAWEBUNIFORMESCOMERCIO2.SPCONFIRMAENTREGA": ' || vgErrMsg );
    
 
 END SPGUARDACONFIRMACIONENTREGA;

END PAWEBUNIFORMESCOMERCIO2;
/

SHOW ERRORS;


CREATE OR REPLACE PACKAGE BODY            PAWEBUNIFORMESCOMERCIO
AS
  /*************************************************************
   Proyecto:                           Uniformes
   Descripcion:                        Paquete para sistema de uniformes Div. Comercial
   Parametros de entrada:              No aplica
   Parametros de salida:               No aplica
   Parametros de entrada-salida        No aplica
   Precondiciones:                     Tener creado el esquema
   Creador:                            
   Fecha de creacion:                  
   *************************************************************/
  	vgErrCode   NUMBER(6)           := 0;                   -- Variable para el manejo de errores codigo
    vgErrMsg    VARCHAR2(500 CHAR)  := '';                  -- Variable para el manejo de errores mensaje
    csgCero     NUMBER(1)           :=0;
    csgUno      NUMBER(1)           :=1;
    
  FUNCTION FNCONSULTAINFOEMPLEADO(
      paNumEmpleado  IN UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE)
  RETURN rcgCursor
  IS 
  /*************************************************************
   Proyecto:                         Sistema de Uniformes
   Descripcion:                      Consulta datos de empleado
   Parametros de entrada:            paNumEmpleado    Numero de empleado
   Parametros de salida:             curDatos         Cursor de referencia
   Parametros de entrada-salida      No aplica
   Precondiciones:                   Tener creado el esquema
   Creador:                          
   Fecha de creacion:                
  *************************************************************/
  curCursorSalida rcgCursor;
  
  BEGIN
    OPEN curCursorSalida FOR
      SELECT E.FIEMPLEADO
            ,E.FCNOMBRE
            ,FCGENERO
            ,FIPOSICION
            ,FCPOSICION
            ,FCSITUACION
            ,FIFUNCION
            ,F.FIIDNEGOCIO
            ,F.FISOLICITUDPLANTILLA
            ,N.FISOLICITAENTIENDA
            ,T.FIPAIS
            ,T.FICANAL
            ,T.FISUCURSAL FICECO
            ,T.FCNOMBRE FCCECO
            ,FCPAIS
            ,TO_CHAR(FDINGRESO,'DD/MM/YYYY') FDINGRESO
        FROM UNIFORMES.TAEMPLEADOS E
   LEFT JOIN UNIFORMES.TATIENDAS T
          ON SUBSTR(TRIM(TO_CHAR(E.FICECO)),3,4) = T.FISUCURSAL
   LEFT JOIN UNIFORMES.TAFUNCIONESXNEGOCIO F
          ON F.FIFUNCIONSAP = E.FIFUNCION
         AND T.FICANAL = F.FICANAL
   LEFT JOIN UNIFORMES.TANEGOCIOS N
          ON F.FIIDNEGOCIO = N.FIIDNEGOCIO   
       WHERE FIEMPLEADO = paNumEmpleado
         AND E.FCSITUACION = 'A';
       RETURN curCursorSalida;
       	EXCEPTION
          WHEN OTHERS THEN
              vgErrCode := SQLCODE;
              vgErrMsg := SQLERRM;
              RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PAWEBUNIFORMESCOMERCIO.FNCONSULTAINFOEMPLEADO": ' || vgErrMsg);
              
  END FNCONSULTAINFOEMPLEADO;
  
  FUNCTION FNCONSULTAMENUFUNCIONXNEGOCIO(
    paNoNegocio IN UNIFORMES.TACARGASXNEGOCIO.FIIDNEGOCIO%TYPE,
    paNoFuncionSap IN UNIFORMES.TAMENUSFUNCIONESXNEGOCIO.FIIDNEGOCIO%TYPE
  )
  RETURN rcgCursor
  IS
  /*************************************************************
   Proyecto:                         Sistema de Uniformes
   Descripcion:                      Consulta el tipo de menu que necesita el empleado
   Parametros de entrada:            paNoNegocio    paNoFuncionSap
   Parametros de salida:             curDatos       Cursor de referencia
   Parametros de entrada-salida      No aplica
   Precondiciones:                   Tener creado el esquema
   Creador:                          
   Fecha de creacion:                
  *************************************************************/
  curCursorSalida rcgCursor;
  vlNoCargasSemestrales NUMBER(3);
  
  BEGIN
    SELECT COUNT(*) INTO vlNoCargasSemestrales FROM TACARGASXNEGOCIO CXN
    INNER JOIN TACARGAS C ON C.FIIDCARGA = CXN.FIIDCARGA 
    WHERE
            CXN.FIIDNEGOCIO = paNoNegocio
            AND C.FIESTATUS = csgUno
            AND SYSDATE BETWEEN C.FDFECHAINICIAL AND C.FDFECHAFINAL;
            
    OPEN curCursorSalida FOR
    SELECT  M.FIIDMENU,
            M.FCTITULO,
            M.FCDESCMENU,
            M.FCRUTAENLACE
    FROM TAMENUSFUNCIONESXNEGOCIO MFXN
    INNER JOIN TAMENUS M ON M.FIIDMENU = MFXN.FIIDMENU 
    WHERE 
            MFXN.FIFUNCIONSAP = paNoFuncionSap
            AND((   vlNoCargasSemestrales > csgCero AND M.FIAPLICACARGA = csgUno)
            OR (    vlNoCargasSemestrales > csgCero AND M.FIBLOQUEADOCARGA = csgCero)
            OR (    vlNoCargasSemestrales = csgCero AND M.FIBLOQUEADOCARGA = csgUno)
            OR (    M.FIAPLICACARGA = csgCero AND M.FIBLOQUEADOCARGA = csgCero)
             );
    RETURN curCursorSalida;
    
  END FNCONSULTAMENUFUNCIONXNEGOCIO;
  
  FUNCTION FNCONSULTAMENUEMPLEADO(
  	paNumEmpleado  IN UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE)
  RETURN rcgCursor
  IS
  /*************************************************************
   Proyecto:                         Sistema de Uniformes
   Descripcion:                      Consulta datos de empleado
   Parametros de entrada:            paNumEmpleado    Numero de empleado
   Parametros de salida:             curDatos         Cursor de referencia
   Parametros de entrada-salida      No aplica
   Precondiciones:                   Tener creado el esquema
   Creador:                          
   Fecha de creacion:                
  *************************************************************/
  curCursorSalida rcgCursor;
  vlCargaActiva NUMBER(3);
  BEGIN
  	
  	BEGIN 
  	 SELECT FIIDCARGA
  	   INTO vlCargaActiva
  	   FROM UNIFORMES.TACARGAS
  	  WHERE SYSDATE BETWEEN FDFECHAINICIAL AND FDFECHAFINAL
  	    AND FIESTATUS = csgUno;
  	  
  	 EXCEPTION
     WHEN NO_DATA_FOUND THEN
     vlCargaActiva := csgCero;
     END;	  
  	
    OPEN curCursorSalida FOR
      SELECT M.FIIDMENU
      		,M.FCTITULO
      		,M.FCDESCMENU
      		,M.FCRUTAENLACE
        FROM UNIFORMES.TAEMPLEADOS E
  INNER JOIN UNIFORMES.TAMENUSFUNCIONESXNEGOCIO MFN
          ON MFN.FIFUNCIONSAP = E.FIFUNCION
  INNER JOIN UNIFORMES.TAMENUS M
          ON MFN.FIIDMENU = M.FIIDMENU

       WHERE FIEMPLEADO = paNumEmpleado
         AND ( ( vlCargaActiva > csgCero AND M.FIAPLICACARGA = csgUno)
            OR ( vlCargaActiva > csgCero AND M.FIBLOQUEADOCARGA = csgCero)
            OR ( vlCargaActiva = csgCero AND M.FIBLOQUEADOCARGA = csgUno)
            OR ( M.FIAPLICACARGA = csgCero AND M.FIBLOQUEADOCARGA = csgCero)
             );
          
       RETURN curCursorSalida;
       	EXCEPTION
          WHEN OTHERS THEN
              vgErrCode := SQLCODE;
              vgErrMsg := SQLERRM;
              RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PAWEBUNIFORMESCOMERCIO.FNCONSULTAMENUEMPLEADO": ' || vgErrMsg);
              
  END FNCONSULTAMENUEMPLEADO;
    
  FUNCTION FNCONSINFOTIENDA(
      paPais UNIFORMES.TATIENDAS.FIPAIS%TYPE,
      paCanal UNIFORMES.TATIENDAS.FICANAL%TYPE,
      paTienda UNIFORMES.TATIENDAS.FISUCURSAL%TYPE)
  RETURN rcgCursor
   IS 
  /*************************************************************
   Proyecto:                         Sistema de Uniformes
   Descripcion:                      Consulta datos de empleado
   Parametros de entrada:            paNumEmpleado    Numero de empleado
   Parametros de salida:             curDatos         Cursor de referencia
   Parametros de entrada-salida      No aplica
   Precondiciones:                   Tener creado el esquema
   Creador:                          
   Fecha de creacion:                
  *************************************************************/
  curCursorSalida rcgCursor;
  
  BEGIN
    OPEN curCursorSalida FOR
    SELECT DISTINCT T.FIPAIS
            ,T.FICANAL
            ,T.FISUCURSAL
            ,T.FCNOMBRE
            ,N.FISOLICITAENTIENDA
        FROM UNIFORMES.TATIENDAS T
  INNER JOIN UNIFORMES.TAFUNCIONESXNEGOCIO F
          ON T.FICANAL = F.FICANAL
  INNER JOIN UNIFORMES.TANEGOCIOS N
          ON F.FIIDNEGOCIO = N.FIIDNEGOCIO
       WHERE T.FIPAIS = paPais
         AND T.FICANAL = paCanal
         AND T.FISUCURSAL = paTienda;
         
       RETURN curCursorSalida;
       	EXCEPTION
          WHEN OTHERS THEN
              vgErrCode := SQLCODE;
              vgErrMsg := SQLERRM;
              RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PAWEBUNIFORMESCOMERCIO.FNCONSINFOTIENDA": ' || vgErrMsg);
              
  END FNCONSINFOTIENDA;
  
  FUNCTION FNCONSEMPLEDOSNUEVOINGRESO(
      paCeco UNIFORMES.TAEMPLEADOS.FICECO%TYPE)
  RETURN rcgCursor
  IS 
  /*************************************************************
   Proyecto:                         Sistema de Uniformes
   Descripcion:                      Consulta datos de empleado
   Parametros de entrada:            paNumEmpleado    Numero de empleado
   Parametros de salida:             curDatos         Cursor de referencia
   Parametros de entrada-salida      No aplica
   Precondiciones:                   Tener creado el esquema
   Creador:                          
   Fecha de creacion:                
  *************************************************************/
  curCursorSalida rcgCursor;
  
  BEGIN
    OPEN curCursorSalida FOR
      SELECT FIEMPLEADO
            ,FCNOMBRE
        FROM UNIFORMES.TAEMPLEADOS   
       WHERE FICECO = paCeco
         AND FCSITUACION = 'A'
         AND FDINGRESO BETWEEN SYSDATE - 12 AND SYSDATE-4;
         
       RETURN curCursorSalida;
       	EXCEPTION
          WHEN OTHERS THEN
              vgErrCode := SQLCODE;
              vgErrMsg := SQLERRM;
              RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PAWEBUNIFORMESCOMERCIO.FNCONSULTAINFOEMPLEADO": ' || vgErrMsg);
              
  END FNCONSEMPLEDOSNUEVOINGRESO;
  
  FUNCTION FNCONSTIENDASCERCANAS(
      paPais UNIFORMES.TACECO.FIPAIS%TYPE,
      paCanal UNIFORMES.TACECO.FCIDCANAL%TYPE,
      paTienda UNIFORMES.TACECO.FICC%TYPE)
  RETURN rcgCursor
  IS 
  /*********************************FI***************************
   Proyecto:                         Sistema de Uniformes
   Descripcion:                      Consulta datos de empleado
   Parametros de entrada:            paNumEmpleado    Numero de empleado
   Parametros de salida:             curDatos         Cursor de referencia
   Parametros de entrada-salida      No aplica
   Precondiciones:                   Tener creado el esquema
   Creador:                          
   Fecha de creacion:                
  *************************************************************/
  curCursorSalida rcgCursor;
  
  BEGIN
    OPEN curCursorSalida FOR
      SELECT C2.FIPAIS
      		,TRIM(C2.FCIDCANAL) FCCANAL
      		,C2.FICC FISUCURSAL
            ,C2.FCNOMBRE
        FROM UNIFORMES.TACECO C1
  INNER JOIN UNIFORMES.TACECO C2
          ON C1.FCIDCCPADRE = C2.FCIDCCPADRE
         AND C2.FIPAIS = C1.FIPAIS
         AND C2.FIESTATUS = csgUno
         AND TRIM(C2.FCIDCANAL) NOT IN (SELECT DISTINCT TRIM(FICANAL) 
         								  FROM UNIFORMES.TANEGOCIOS N
         							INNER JOIN UNIFORMES.TAFUNCIONESXNEGOCIO F
         							        ON F.FIIDNEGOCIO = N.FIIDNEGOCIO
         							     WHERE N.FISOLICITAENTIENDA = 0)
       WHERE C1.FIPAIS = paPais
         AND TRIM(C1.FCIDCANAL) = paCanal
         AND C1.FICC = paTienda
         AND C1.FIESTATUS = csgUno;
         
       RETURN curCursorSalida;
       	EXCEPTION
          WHEN OTHERS THEN
              vgErrCode := SQLCODE;
              vgErrMsg := SQLERRM;
              RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PAWEBUNIFORMESCOMERCIO.FNCONSTIENDASCERCANAS": ' || vgErrMsg);
              
  END FNCONSTIENDASCERCANAS;
  
  FUNCTION FNCONSKITEMPLEADO(
  	paNumEmp UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE,
  	paTipoSol UNIFORMES.TAPRECIOS.FIIDTIPOSOLICITUD%TYPE)
  RETURN rcgCursor
  IS
  /*************************************************************
   Proyecto:                         Sistema de Uniformes
   Descripcion:                      Consulta datos de empleado
   Parametros de entrada:            paNumEmpleado    Numero de empleado
   Parametros de salida:             curDatos         Cursor de referencia
   Parametros de entrada-salida      No aplica
   Precondiciones:                   Tener creado el esquema
   Creador:                          
   Fecha de creacion:                
  *************************************************************/
  curCursorSalida rcgCursor;
  vlGenUnisex NUMBER(1):=3;
  BEGIN
  
    OPEN curCursorSalida FOR
      SELECT E.FIEMPLEADO,
			 E.FCNOMBRE,
			 E.FIFUNCION,
			 E.FCGENERO,
      		 F.FIKIT ,
			 K.FCDESCRIPCION FCKIT,
			 TP.FIIDTIPOPRENDA,
			 TP.FCDESCRIPCION FCTIPOPRENDA,
			 TP.FCIMAGEN,
			 PRP.FNVALOR,
			 TPT.FITALLA,
			 T.FCDESCRIPCION FCTALLA,
			 C.FIMINIMO,
			 C.FIMAXIMO,
			 TPT.FIIDGENERO
	    FROM UNIFORMES.TATIENDAS T
    INNER JOIN UNIFORMES.TAEMPLEADOS E
          ON T.FISUCURSAL = TO_NUMBER(SUBSTR(TRIM(TO_CHAR(E.FICECO)),3,4))
    INNER JOIN UNIFORMES.TAFUNCIONESXNEGOCIO F
    	  ON E.FIFUNCION = F.FIFUNCIONSAP
    	 AND F.FICANAL = T.FICANAL
    INNER JOIN UNIFORMES.TAKITS K
          ON F.FIKIT = K.FIKIT
    INNER JOIN UNIFORMES.TATIPOSPRENDAXKIT TPK
          ON TPK.FIKIT = K.FIKIT
    INNER JOIN UNIFORMES.TATIPOSPRENDA TP
          ON TPK.FIIDTIPOPRENDA = TP.FIIDTIPOPRENDA
    INNER JOIN UNIFORMES.TATALLASXTIPOPRENDA TPT
          ON TPT.FIIDTIPOPRENDA = TP.FIIDTIPOPRENDA
         AND TPT.FIIDGENERO IN ( ( CASE WHEN E.FCGENERO = 'H' THEN 1 ELSE 2 END ), vlGenUnisex) 
    INNER JOIN UNIFORMES.TATALLAS T
          ON TPT.FITALLA = T.FITALLA
    INNER JOIN UNIFORMES.TAPRECIOS PRP
          ON PRP.FIIDTIPOPRENDA = TP.FIIDTIPOPRENDA
         AND PRP.FIIDTIPOSOLICITUD = paTipoSol
    INNER JOIN UNIFORMES.TACANTIDADES C
          ON C.FIIDTIPOSOLICITUD = paTipoSol
         AND C.FIIDTIPOPRENDA = TP.FIIDTIPOPRENDA
       WHERE E.FIEMPLEADO = paNumEmp
         AND E.FCSITUACION = 'A'
   ORDER BY E.FIEMPLEADO, F.FIKIT, TP.FIIDTIPOPRENDA, T.FIORDEN;
          
       RETURN curCursorSalida;
       	EXCEPTION
          WHEN OTHERS THEN
              vgErrCode := SQLCODE;
              vgErrMsg := SQLERRM;
              RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PAWEBUNIFORMESCOMERCIO.FNCONSKITEMPLEADO": ' || vgErrMsg);
              
  END FNCONSKITEMPLEADO;
  
  FUNCTION FNCONSKITEMPLEADOSTIENDA(
  	paPais UNIFORMES.TATIENDAS.FIPAIS%TYPE,
  	paCanal UNIFORMES.TATIENDAS.FICANAL%TYPE,
  	paTienda UNIFORMES.TATIENDAS.FISUCURSAL%TYPE,
  	paTipoSol UNIFORMES.TAPRECIOS.FIIDTIPOSOLICITUD%TYPE)
  RETURN rcgCursor
  IS
  /*************************************************************
   Proyecto:                         Sistema de Uniformes
   Descripcion:                      Consulta datos de empleado
   Parametros de entrada:            paNumEmpleado    Numero de empleado
   Parametros de salida:             curDatos         Cursor de referencia
   Parametros de entrada-salida      No aplica
   Precondiciones:                   Tener creado el esquema
   Creador:                          
   Fecha de creacion:                
  *************************************************************/
  curCursorSalida rcgCursor;
  vlGenUnisex NUMBER(1):=3;
  BEGIN
  
    OPEN curCursorSalida FOR
      SELECT E.FIEMPLEADO,
			 E.FCNOMBRE,
			 E.FIFUNCION,
			 E.FCGENERO,
			 F.FIKIT,
			 K.FCDESCRIPCION FCKIT,
			 TP.FIIDTIPOPRENDA,
			 TP.FCDESCRIPCION FCTIPOPRENDA,
			 TP.FCIMAGEN,
			 PRP.FNVALOR,
			 TPT.FITALLA,
			 T.FCDESCRIPCION FCTALLA,
			 C.FIMINIMO,
			 C.FIMAXIMO,
			 TPT.FIIDGENERO
	    FROM UNIFORMES.TATIENDAS T
    INNER JOIN UNIFORMES.TAEMPLEADOS E
          ON T.FISUCURSAL = E.FICECO
    INNER JOIN UNIFORMES.TAFUNCIONESXNEGOCIO F
    	  ON E.FIFUNCION = F.FIFUNCIONSAP
    	 AND F.FICANAL = T.FICANAL
    INNER JOIN UNIFORMES.TAKITS K
          ON F.FIKIT = K.FIKIT
    INNER JOIN UNIFORMES.TATIPOSPRENDAXKIT TPK
          ON TPK.FIKIT = K.FIKIT
    INNER JOIN UNIFORMES.TATIPOSPRENDA TP
          ON TPK.FIIDTIPOPRENDA = TP.FIIDTIPOPRENDA
    INNER JOIN UNIFORMES.TATALLASXTIPOPRENDA TPT
          ON TPT.FIIDTIPOPRENDA = TP.FIIDTIPOPRENDA
         AND TPT.FIIDGENERO IN ( ( CASE WHEN E.FCGENERO = 'H' THEN 1 ELSE 2 END ), vlGenUnisex) 
    INNER JOIN UNIFORMES.TATALLAS T
          ON TPT.FITALLA = T.FITALLA
    INNER JOIN UNIFORMES.TAPRECIOS PRP
          ON PRP.FIIDTIPOPRENDA = TP.FIIDTIPOPRENDA
         AND PRP.FIIDTIPOSOLICITUD = paTipoSol
    INNER JOIN UNIFORMES.TACANTIDADES C
          ON C.FIIDTIPOSOLICITUD = paTipoSol
         AND C.FIIDTIPOPRENDA = TP.FIIDTIPOPRENDA
       WHERE T.FIPAIS = paPais
       AND T.FICANAL = paCanal
       AND T.FISUCURSAL = paTienda
       AND E.FCSITUACION = 'A'
  ORDER BY E.FIEMPLEADO, F.FIKIT, TP.FIIDTIPOPRENDA, T.FIORDEN;
          
       RETURN curCursorSalida;
       	EXCEPTION
          WHEN OTHERS THEN
              vgErrCode := SQLCODE;
              vgErrMsg := SQLERRM;
              RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PAWEBUNIFORMESCOMERCIO.FNCONSKITEMPLEADOSTIENDA": ' || vgErrMsg);
              
  END FNCONSKITEMPLEADOSTIENDA;
  
  PROCEDURE SPGUARDASOLICITUD(
    paSolicitudes IN UNIFORMES.TYPEARRSOLICITUDPRENDA
   ,curResultado OUT rcgCursor )
  IS
  /*************************************************************
   Proyecto:                         Sistema de Uniformes
   Descripcion:                      Consulta datos de empleado
   Parametros de entrada:            paNumEmpleado    Numero de empleado
   Parametros de salida:             curDatos         Cursor de referencia
   Parametros de entrada-salida      No aplica
   Precondiciones:                   Tener creado el esquema
   Creador:                          
   Fecha de creacion:                
  *************************************************************/
  vlIdSolicitud  NUMBER(18);
  vlIdDetalleSol NUMBER(18);
  vlIdBitacora 	 NUMBER(18);
  vlSolicitudSem NUMBER(1):=1;
  vlCargaActiva NUMBER(8);
  vlEvTallasCap NUMBER(2):=10;
  vlEstPendCD   NUMBER(1):=1;
  vlSolicitudes VARCHAR2(1000 CHAR);
  
  BEGIN
  
  	FOR indSol IN 1..paSolicitudes.count
    LOOP
    	BEGIN
    	
    	SELECT NVL(MAX(FIFOLIOSOLICITUD), csgCero) + 1 
    	  INTO vlIdSolicitud
    	  FROM UNIFORMES.TASOLICITUDES;
    	
    	END;	
    		INSERT INTO UNIFORMES.TASOLICITUDES(FIFOLIOSOLICITUD, 
    											FIIDEMPLEADO, 
    											FIIDTIPOSOLICITUD, 
    											FIIDNEGOCIO, 
    											FIFUNCIONSAP, 
    											FIIDEMPCAPTURA, 
    											FDFECHACAPTURA)
    									VALUES (vlIdSolicitud,
    											paSolicitudes(indSol).FIEMPLEADO,
    											paSolicitudes(indSol).FIIDTIPOSOLICITUD,
    											paSolicitudes(indSol).FIIDNEGOCIO,
    											paSolicitudes(indSol).FIFUNCIONSAP,
    											paSolicitudes(indSol).FIEMPLEADOCAPTURA,
    											SYSDATE);
    											
    		IF paSolicitudes(indSol).FIIDTIPOSOLICITUD = vlSolicitudSem THEN
    		   
    			BEGIN 
			  	 SELECT FIIDCARGA
			  	   INTO vlCargaActiva
			  	   FROM UNIFORMES.TACARGAS
			  	  WHERE SYSDATE BETWEEN FDFECHAINICIAL AND FDFECHAFINAL
			  	    AND FIESTATUS = csgUno;
			  	  
			  	 EXCEPTION
			     WHEN NO_DATA_FOUND THEN
			     ROLLBACK;
			     RAISE_APPLICATION_ERROR (-20001,'NO HAY CARGA SEMESTRAL ACTIVA');
			     END;
			     
			     INSERT INTO UNIFORMES.TASOLICITUDESXCARGA(FIFOLIOSOLICITUD, FIIDCARGA)
			                                        VALUES(vlIdSolicitud, vlCargaActiva);
    			
    		END IF;
    		
    		vlSolicitudes := vlSolicitudes || TO_CHAR(vlIdSolicitud)||',';
    		
        	FOR indDet IN 1..paSolicitudes(indSol).PRENDAS.count
	    	LOOP
	    		
		     BEGIN
	    	
		    	SELECT NVL(MAX(FIIDDETALLE), csgCero) + 1 
		    	  INTO vlIdDetalleSol
		    	  FROM UNIFORMES.TASOLICITUDESDETALLE;
		    	
		     END;
	    	
			 INSERT INTO UNIFORMES.TASOLICITUDESDETALLE (FIFOLIOSOLICITUD, 
			 											 FIIDDETALLE, 
			 											 FIPAIS, 
			 											 FICANAL, 
			 											 FISUCURSAL, 
			 											 FIIDTIPOPRENDA, 
			 											 FITALLA, 
			 											 FICANTIDAD, 
			 											 FNPRECIOUNITARIO, 
			 											 FNPRECIOTOTAL, 
			 											 FIBANDERAACTIVA)
			        							VALUES  (vlIdSolicitud,
			        							         vlIdDetalleSol, 
			 											 paSolicitudes(indSol).PRENDAS(indDet).FIPAIS, 
			 											 paSolicitudes(indSol).PRENDAS(indDet).FICANAL, 
			 											 paSolicitudes(indSol).PRENDAS(indDet).FISUCURSAL, 
			 											 paSolicitudes(indSol).PRENDAS(indDet).FIIDTIPOPRENDA, 
			 											 paSolicitudes(indSol).PRENDAS(indDet).FITALLA, 
			 											 paSolicitudes(indSol).PRENDAS(indDet).FICANTIDAD, 
			 											 paSolicitudes(indSol).PRENDAS(indDet).FIPRECIOUNITARIO, 
			 											 paSolicitudes(indSol).PRENDAS(indDet).FIPRECIOUNITARIO * paSolicitudes(indSol).PRENDAS(indDet).FICANTIDAD, 
			 											 csgUno);
			 											 
			 											 
			BEGIN
	    	
		    	SELECT NVL(MAX(FIIDBITACORA), csgCero) + 1 
		    	  INTO vlIdBitacora
		    	  FROM UNIFORMES.TABITACORASOLICITUD;
		    	
		     END;
	    	
			 INSERT INTO UNIFORMES.TABITACORASOLICITUD (FIIDBITACORA, 
			 											FIFOLIOSOLICITUD, 
			 											FIIDDETALLE, 
			 											FIPAIS, 
			 											FICANAL, 
			 											FIIDSUCURSAL, 
			 											FINUMPEDIDO, 
			 											FISKU, 
			 											FIIDTIPOEVENTO, 
			 											FXDATOS, 
			 											FIIDESTATUSANT, 
			 											FIIDESTATUSNVO, 
			 											FDFECHAEVENTO, 
			 											FIIDERROR, 
			 											FCCOMENTARIOS)
			        							VALUES  (vlIdBitacora,
			        									 vlIdSolicitud,
			        							         vlIdDetalleSol, 
			 											 paSolicitudes(indSol).PRENDAS(indDet).FIPAIS, 
			 											 paSolicitudes(indSol).PRENDAS(indDet).FICANAL, 
			 											 paSolicitudes(indSol).PRENDAS(indDet).FISUCURSAL,
			 											 NULL,
			 											 NULL,
			 											 vlEvTallasCap,
			 											 '<?xml version="1.0"?><DATOS></DATOS>',
			 											 vlEstPendCD,
			 											 vlEstPendCD,
			 											 SYSDATE,
			 											 csgCero,
			 											 ' ');
			
	    	END LOOP;
    	END LOOP;
       
       COMMIT;
       
       OPEN curResultado 
        FOR SELECT S.FIFOLIOSOLICITUD, E.FIEMPLEADO, E.FCNOMBRE
              FROM UNIFORMES.TASOLICITUDES S
        INNER JOIN UNIFORMES.TAEMPLEADOS E
                ON E.FIEMPLEADO = S.FIIDEMPLEADO
             WHERE FIFOLIOSOLICITUD IN ( SELECT TO_NUMBER(column_value) FROM XMLTABLE(SUBSTR(vlSolicitudes,0,LENGTH(vlSolicitudes)-1)));
       
       	EXCEPTION
          WHEN OTHERS THEN
          	  ROLLBACK;
              vgErrCode := SQLCODE;
              vgErrMsg := SQLERRM;
              RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PAWEBUNIFORMESCOMERCIO.SPGUARDASOLICITUD": ' || vgErrMsg);
              
  END SPGUARDASOLICITUD;
  
  FUNCTION FNCONSPEDIDOSXENTREGAR(
   paNumEmp UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE
  )
  RETURN rcgCursor
  IS
  /*************************************************************
   Proyecto:                         Sistema de Uniformes
   Descripcion:                      Consulta datos de empleado
   Parametros de entrada:            paNumEmpleado    Numero de empleado
   Parametros de salida:             curDatos         Cursor de referencia
   Parametros de entrada-salida      No aplica
   Precondiciones:                   Tener creado el esquema
   Creador:                          
   Fecha de creacion:                
  *************************************************************/
  curCursorSalida rcgCursor;
  vlEstEnTienda NUMBER(1):=5;
  vlEstActivo   VARCHAR2(1 CHAR) := 'A';
  BEGIN
  
    OPEN curCursorSalida FOR
	    SELECT  D.FIIDDETALLE
                ,P.FIPAIS
                ,P.FICANAL
                ,P.FIIDSUCURSAL
                ,E2.FIEMPLEADO
                ,E2.FCNOMBRE
                ,E2.FCPOSICION
                ,E2.FICECO
                ,E2.FCCECO
                ,N.FCDESCRIPCION NEGOCIO
                ,S.FIFOLIOSOLICITUD
                ,P.FIPEDIDO
                ,P.FISKU
                ,R.FCDESCRIPCION PRENDA
                ,P.FICANTIDAD
                ,RM.FIREMISION
		  FROM UNIFORMES.TAEMPLEADOS E
	INNER JOIN UNIFORMES.TACECO C
			ON E.FICECO = C.FICC
	INNER JOIN UNIFORMES.TAPEDIDOSCD P
			ON P.FIPAIS = C.FIPAIS
		   AND P.FICANAL = C.FCIDCANAL
		   AND P.FIIDSUCURSAL = C.FINUMECO
		   AND P.FIIDESTATUSPEDIDO = vlEstEnTienda
	INNER JOIN UNIFORMES.TAPRENDAS R
			ON R.FISKU = P.FISKU
	INNER JOIN UNIFORMES.TAREMISIONESXPEDIDO RM
			ON RM.FIPAIS = P.FIPAIS
		   AND RM.FICANAL = P.FICANAL
		   AND RM.FISUCURSAL = P.FIIDSUCURSAL
		   AND RM.FIPEDIDO = P.FIPEDIDO
		   AND RM.FISKU = P.FISKU
	INNER JOIN UNIFORMES.TASOLICITUDESDETALLE D
	   		ON P.FIFOLIOSOLICITUD = D.FIFOLIOSOLICITUD
		   AND P.FIIDDETALLE = D.FIIDDETALLE
	INNER JOIN UNIFORMES.TASOLICITUDES S
		    ON D.FIFOLIOSOLICITUD = S.FIFOLIOSOLICITUD
	INNER JOIN UNIFORMES.TAEMPLEADOS E2
			ON E2.FIEMPLEADO = S.FIIDEMPLEADO
	INNER JOIN UNIFORMES.TANEGOCIOS N
			ON S.FIIDNEGOCIO = N.FIIDNEGOCIO
		 WHERE E.FIEMPLEADO =  paNumEmp
		   AND E.FCSITUACION = vlEstActivo
		   AND E2.FCSITUACION = vlEstActivo
	  ORDER BY E2.FIEMPLEADO
	          ,S.FIFOLIOSOLICITUD
	          ,P.FIPEDIDO;
          
       RETURN curCursorSalida;
       	EXCEPTION
          WHEN OTHERS THEN
              vgErrCode := SQLCODE;
              vgErrMsg := SQLERRM;
              RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PAWEBUNIFORMESCOMERCIO.FNCONSPENDIENTESENTREGA": ' || vgErrMsg);
              
  END FNCONSPEDIDOSXENTREGAR;
  
END PAWEBUNIFORMESCOMERCIO;
/

SHOW ERRORS;


CREATE OR REPLACE PACKAGE BODY           PAWEBUNIFORMES
AS
/*************************************************************
   Proyecto:                       Uniformes 
   Descripcion:                    Paquete para Paginas WEB de Uniformes
   Parametros de entrada:          No aplica
   Parametros de salida:           No aplica
   Parametros de entrada-salida    No aplica
   Precondiciones:                 Tener creado el esquema
   Creador:                        Carolina Pérez Vite
   Fecha de creacion:              31 de Agosto del 2016
********************************************************************/


FUNCTION FNCONSULTAPEDIDOS
   (paSucursal UNIFORMES.TADETALLEPEDIDOS.FISUCURSAL%TYPE,
    paNoEmpelado UNIFORMES.TAPEDIDOS.FIEMPLEADO%TYPE,
    paNoPedido UNIFORMES.TADETALLEPEDIDOS.FIPEDIDO%TYPE)
RETURN PAWEBUNIFORMES.rcgCursor
IS
   /********************************************************************************
   Descripcion: Función que regresa la información de los pedidos, de acuerdo a la
                información recibida.
   Parámetros de entrada: paSucursal - Número de Sucursal
                          paNoEmpelado - Numero de Empleado
                          paNoPedido - Número de Pedido
   Parámetros de salida: No aplica 
   Parámetros de entrada-salida: Ninguno 
   Valor de retorno: Cursor con resultado. 
   Creador: Carolina Pérez Vite
   Fecha de creacion: 31 de Agosto del 2016
   ********************************************************************************/

      -- Declaración de variables locales.
      curDatos  UNIFORMES.PAWEBUNIFORMES.rcgCursor; --Cursor que va a contener los datos de la consulta
      vlCero    NUMBER(1) := 0;
      
BEGIN
      OPEN curDatos FOR 
         SELECT
               TP.FIEMPLEADO,
               TDP.FISUCURSAL, 
               TDP.FIPEDIDO, 
               TP.FDREGISTRO,
               CASE TP.FITIPO
                    WHEN 1 THEN 'Solicitud Voluntaria' 
                    WHEN 2 THEN 'Solicitud Semestral'
                    WHEN 3 THEN 'Solicitud nuevo ingreso'
                    ELSE 'NO IDENTIFICADO'
                    END  FITIPOSOLICITUD,
               TP.FIEMPLEADOSOLICITA,
               TDP.FISKU, 
               TDP.FICANTIDAD, 
               TA.FCDESCRIPCION,
               CASE TDP.FIESTATUS
                     WHEN 0  THEN 'Registrado'
                     WHEN 10 THEN 'Autorizado por RH'
                     WHEN 15 THEN 'Pre AutoRización por CD'
                     WHEN 20 THEN 'Autorizado por CD'
                     WHEN 30 THEN 'Enviado a Tienda'
                     WHEN 40 THEN 'Enviado a Abasto'
                     WHEN 50 THEN 'Cancelado por Abasto'
                     WHEN 60 THEN 'Abasto Envia a CD'
                     WHEN 70 THEN 'Abasto Envia a Tienda'
                     WHEN 80 THEN 'Recibido en Tienda (remision)'
                     WHEN 90 THEN 'Descargado (entregado)'
                     WHEN 100 THEN 'Descuento SAP'
                     WHEN 110 THEN 'Descuento SAP'
                     WHEN 120 THEN 'Descuento SAP'
                     WHEN 500 THEN 'Cancelado por Baja Empleado'
                     WHEN 510 THEN 'Descuento SAP'
                     WHEN 520 THEN 'Descuento SAP'
                     ELSE 'NO IDENTIFICADO'
                    END FCESTATUS,
                  TDP.FNCOSTO,
                  TDP.FNDESCUENTO
               FROM UNIFORMES.TAPEDIDOS TP
               INNER JOIN  UNIFORMES.TADETALLEPEDIDOS TDP  
               ON (TP.FIFOLIOCENTRAL=TDP.FIFOLIOCENTRAL)
               INNER JOIN UNIFORMES.TAPRODUCTOS P
               ON(P.FISKU = TDP.FISKU)
               INNER JOIN UNIFORMES.TATIPOSPRODUCTO TP
               ON(TP.FITIPO=P.FITIPO)
               INNER JOIN UNIFORMES.TATALLAS TA
               ON(TA.FITALLA = P.FITALLA)
               WHERE TDP.FIESTATUS NOT IN (550,600, 601, 602, 603, 19, 39, 79)
               AND TDP.FISUCURSAL = 
                   CASE 
                     WHEN paSucursal = vlCero THEN TDP.FISUCURSAL
                     ELSE paSucursal
                   END
               AND TP.FIEMPLEADO = 
                   CASE 
                     WHEN paNoEmpelado = vlCero THEN TP.FIEMPLEADO
                     ELSE paNoEmpelado
                   END
               AND TDP.FIPEDIDO = 
                   CASE 
                     WHEN paNoPedido = vlCero THEN TDP.FIPEDIDO
                     ELSE paNoPedido
                   END
             ORDER BY TDP.FISUCURSAL,TP.FIEMPLEADO;
                          
       RETURN curDatos;
       
END FNCONSULTAPEDIDOS;

END PAWEBUNIFORMES;
/

SHOW ERRORS;


CREATE OR REPLACE PACKAGE BODY  PASRVUNIFORMESCOMERCIO
AS
  /*************************************************************
   Proyecto:                           Uniformes
   Descripcion:                        Paquete para sistema de uniformes Div. Comercial
   Parametros de entrada:              No aplica
   Parametros de salida:               No aplica
   Parametros de entrada-salida        No aplica
   Precondiciones:                     Tener creado el esquema
   Creador:                            
   Fecha de creacion:                  
   *************************************************************/
  	vgErrCode       NUMBER(6):= 0;          -- Variable para el manejo de errores codigo
    vgErrMsg        VARCHAR2(500 CHAR):=''; -- Variable para el manejo de errores mensaje
    csgCero 	    NUMBER(1):=0;
    csgUno 		    NUMBER(1):=1;
    csgTres         NUMBER(1):=3;
    csgCuatro       NUMBER(1):=4;
    csgDieceNueve   NUMBER(2):=19;

 FUNCTION FNESTATUSPEDIDOSCD(
    paNoPais        UNIFORMES.TAPEDIDOSCD.FIPAIS%TYPE,
    paNoCanal       UNIFORMES.TAPEDIDOSCD.FICANAL%TYPE,
    paNoSucursal    UNIFORMES.TAPEDIDOSCD.FIIDSUCURSAL%TYPE,
    paNoPedido      UNIFORMES.TAPEDIDOSCD.FIPEDIDO%TYPE,
    paNoSKU         UNIFORMES.TAPEDIDOSCD.FISKU%TYPE
 )
 RETURN NUMBER
  
 IS
 vlEstatus UNIFORMES.TAPEDIDOSCD.FIIDESTATUSPEDIDO%TYPE;
 BEGIN
    SELECT FIIDESTATUSPEDIDO INTO vlEstatus FROM UNIFORMES.TAPEDIDOSCD 
        WHERE   FIPAIS = paNoPais
            AND FICANAL = paNoCanal
            AND FIIDSUCURSAL = paNoSucursal
            AND FIPEDIDO = paNoPedido
            AND FISKU = paNoSKU;
 END FNESTATUSPEDIDOSCD;

   FUNCTION FNCONSSOLPENDGRABARTIENDA
   RETURN rcgCursor
   IS 
  /*************************************************************
   Proyecto:                         Sistema de Uniformes
   Descripcion:                      Consulta datos de empleado
   Parametros de entrada:            paNumEmpleado    Numero de empleado
   Parametros de salida:             curDatos         Cursor de referencia
   Parametros de entrada-salida      No aplica
   Precondiciones:                   Tener creado el esquema
   Creador:                          
   Fecha de creacion:                
  *************************************************************/
  curCursorSalida rcgCursor;
  vlSolSemestral  NUMBER(1):= 1;
  vlSolNuevoIng   NUMBER(1):= 2;
  vlSolVoluntaria NUMBER(1):= 3;
  vlGeneroH		  NUMBER(1):= 1; 
  vlGeneroM		  NUMBER(2):= 2;
  vlGeneroUni	  NUMBER(2):= 3;
  vlSolenTienda   NUMBER(1):= 1;
  BEGIN
          OPEN curCursorSalida FOR
        SELECT S.FIFOLIOSOLICITUD,
			   D.FIIDDETALLE,
			   E.FIEMPLEADO,
			   D.FIPAIS,
			   TO_NUMBER(TRIM(D.FICANAL)) FICANAL,
               D.FISUCURSAL,
			   T.FCDIRIP,
			   P.FISKU,
			   P.FCDESCRIPCION,
			   P.FITALLA,
			   D.FICANTIDAD
               --D.FISUCURSAL
		  FROM UNIFORMES.TASOLICITUDES S
	INNER JOIN UNIFORMES.TASOLICITUDESDETALLE D
			ON S.FIFOLIOSOLICITUD = D.FIFOLIOSOLICITUD
	INNER JOIN UNIFORMES.TAEMPLEADOS E
			ON E.FIEMPLEADO = S.FIIDEMPLEADO
    INNER JOIN UNIFORMES.TATIENDAS T
            ON T.FIPAIS = D.FIPAIS
           AND T.FICANAL = D.FICANAL
           AND T.FISUCURSAL = D.FISUCURSAL
	INNER JOIN UNIFORMES.TAFUNCIONESXNEGOCIO F
			ON F.FIFUNCIONSAP = S.FIFUNCIONSAP
		   AND F.FIIDNEGOCIO = S.FIIDNEGOCIO
	INNER JOIN UNIFORMES.TASKUSXKIT SK
			ON SK.FIKIT = F.FIKIT
	INNER JOIN UNIFORMES.TAPRENDAS P
			ON P.FISKU = SK.FISKU
		   AND P.FIIDTIPOPRENDA = D.FIIDTIPOPRENDA
		   AND P.FITALLA = D.FITALLA
		   AND P.FIIDGENERO IN ( ( CASE WHEN E.FCGENERO = 'H' THEN vlGeneroH ELSE vlGeneroM END ) , vlGeneroUni)
    INNER JOIN UNIFORMES.TABITACORASOLICITUD B
           ON  B.FIFOLIOSOLICITUD = D.FIFOLIOSOLICITUD
	       AND B.FIIDDETALLE = D.FIIDDETALLE
	       AND B.FIIDESTATUSNVO = vlSolenTienda 
		   AND B.FIIDESTATUSANT = vlSolenTienda 
		   AND B.FINUMPEDIDO IS NULL
		   AND B.FIIDERROR = csgCero
	INNER JOIN ( SELECT MAX(FDFECHAEVENTO) FECHABITACORA,FIFOLIOSOLICITUD,FIIDDETALLE
				    FROM UNIFORMES.TABITACORASOLICITUD
					  GROUP BY FIFOLIOSOLICITUD,FIIDDETALLE )BACT
			ON B.FIFOLIOSOLICITUD = BACT.FIFOLIOSOLICITUD
	       AND B.FIIDDETALLE = BACT.FIIDDETALLE
	       AND B.FDFECHAEVENTO = BACT.FECHABITACORA
	     WHERE S.FIIDTIPOSOLICITUD IN (vlSolNuevoIng,vlSolVoluntaria)
	        OR (   S.FIIDTIPOSOLICITUD = vlSolSemestral
	           AND S.FIFOLIOSOLICITUD IN ( SELECT SO.FIFOLIOSOLICITUD 
	           							  FROM UNIFORMES.TASOLICITUDES SO
									INNER JOIN UNIFORMES.TASOLICITUDESXCARGA SC
											ON SO.FIFOLIOSOLICITUD = SC.FIFOLIOSOLICITUD
									INNER JOIN UNIFORMES.TACARGAS C
										  	ON C.FIIDCARGA = SC.FIIDCARGA
										 WHERE C.FIGENERARPEDIDO = csgUno )
				)	  
	  ORDER BY S.FIFOLIOSOLICITUD,
			   D.FIIDDETALLE,
			   E.FIEMPLEADO;
       RETURN curCursorSalida;
       	EXCEPTION
          WHEN OTHERS THEN
              vgErrCode := SQLCODE;
              vgErrMsg := SQLERRM;
              RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PASRVUNIFORMESCOMERCIO.FNCONSSOLPENDGRABARTIENDA": ' || vgErrMsg);
              
  END FNCONSSOLPENDGRABARTIENDA;
  
  PROCEDURE SPACTUALIZARPEDIDOSCD
  			(paWSPedidosCD IN UNIFORMES.TYPEARRWSPEDIDOSCD,
  			 paResultado OUT NUMBER)
  /*************************************************************
   Proyecto:                         Sistema de Uniformes
   Descripcion:                      Consulta datos de empleado
   Parametros de entrada:            paNumEmpleado    Numero de empleado
   Parametros de salida:             curDatos         Cursor de referencia
   Parametros de entrada-salida      No aplica
   Precondiciones:                   Tener creado el esquema
   Creador:                          
   Fecha de creacion:                
  *************************************************************/             
  IS
  --CONSTANSTES
  cslReinyeccionActiva          CONSTANT NUMBER(1) := 1;
  cslEstatusSolicitado          CONSTANT NUMBER(1) := 0;
  cslEstatusCancelado           CONSTANT NUMBER(1) := 3;
  cslEstatusCDReasignado        CONSTANT NUMBER(1) := 4;
  cslEsCancelado                CONSTANT NUMBER(1) := 1;
  --VARIABLES
  vlCancelacionCD               NUMBER(1) := 0;
  vlPais 	                    UNIFORMES.TABITACORASOLICITUD.FIPAIS%TYPE;
  vlCanal 	                    UNIFORMES.TABITACORASOLICITUD.FICANAL%TYPE;
  vlSucursal                    UNIFORMES.TABITACORASOLICITUD.FIIDSUCURSAL%TYPE;
  vlIdBitacora                  UNIFORMES.TABITACORASOLICITUD.FIIDBITACORA%TYPE;
  vlIdTipoEvento                UNIFORMES.TABITACORASOLICITUD.FIIDTIPOEVENTO%TYPE;
  vlIdEstatusNvo                UNIFORMES.TABITACORASOLICITUD.FIIDESTATUSNVO%TYPE;
  
  vlDescripcionCD               UNIFORMES.TAPEDIDOSCD.FCDESCRIPCIONCD%TYPE;
  
  vlEstatusCD                   UNIFORMES.TAPEDIDOSCD.FIESTATUSCD%TYPE;
  
  vlMsgCancelado                UNIFORMES.TAPEDIDOSCD.FCDESCRIPCIONCD%TYPE := 'CANCELED';
  vlMsgFailed                   UNIFORMES.TAPEDIDOSCD.FCDESCRIPCIONCD%TYPE := '%Failed%';
  vlMsgPedidoCreado             UNIFORMES.TAPEDIDOSCD.FCDESCRIPCIONCD%TYPE := 'PEDIDO CREADO (CD)';
  vlMsgAsignadoAlmacen          UNIFORMES.TAPEDIDOSCD.FCDESCRIPCIONCD%TYPE := 'ASIGNADO EN ALMACEN (CD)';
  vlMsgAtendiendo               UNIFORMES.TAPEDIDOSCD.FCDESCRIPCIONCD%TYPE := 'ATENDIENDO SOLICITUD';
  vlMsgEnviadoATienda           UNIFORMES.TAPEDIDOSCD.FCDESCRIPCIONCD%TYPE := 'ENVIADO A TIENDA';
  vlMsgRemisionado              UNIFORMES.TAPEDIDOSCD.FCDESCRIPCIONCD%TYPE := 'REMISIONADO SIN RUTA (CD)';
  vlMsgPedidoCanceladoAbasto    UNIFORMES.TAPEDIDOSCD.FCDESCRIPCIONCD%TYPE := 'PEDIDO CANCELADO ABASTO';
  vlMsgPedidoCanceladoNE        UNIFORMES.TAPEDIDOSCD.FCDESCRIPCIONCD%TYPE := 'NOTA DE ENTRADA: ';  

  BEGIN	
        
        FOR i IN paWSPedidosCD.FIRST..paWSPedidosCD.LAST LOOP
            
    --TRANSFORMACION DE TABITACORASOLICITUD.FIIDTIPOEVENTO, TAPEDIDOSCD.FIESTATUSCD, TAPEDIDOSCD.FCOBSERVACIONES
            vlEstatusCD := 0; --INICIALIZACION
            
            IF paWSPedidosCD(i).FIESTATUSCD = 0 THEN --PEDIDO CREADO (CD) 
                vlEstatusCD := 1;            
                vlDescripcionCD := vlMsgPedidoCreado;
                vlIdTipoEvento := 1;
                vlIdEstatusNvo := 1;
            ELSIF paWSPedidosCD(i).FIESTATUSCD IN (20,200) THEN --PEDIDO CREADO (CD)
                vlEstatusCD := 1; 
                vlDescripcionCD := vlMsgPedidoCreado;                
                vlIdTipoEvento := 1;
                vlIdEstatusNvo := 1;                
            ELSIF paWSPedidosCD(i).FIESTATUSCD IN (400,450,492,496,500,600,650) AND paWSPedidosCD(i).FCDESCRIPCIONCD NOT LIKE vlMsgFailed THEN --ASIGNADO EN ALMACEN (CD)
                vlEstatusCD := 2; 
                vlDescripcionCD := vlMsgAsignadoAlmacen;
                vlIdTipoEvento := 1;
                vlIdEstatusNvo := 1;                
            ELSIF paWSPedidosCD(i).FIESTATUSCD IN (400,450,492,496,500,600,650) AND paWSPedidosCD(i).FCDESCRIPCIONCD LIKE vlMsgFailed THEN --ASIGNADO EN ALMACEN (CD)
                vlEstatusCD := 2; 
                vlDescripcionCD := vlMsgAsignadoAlmacen;                
                vlIdTipoEvento := 1;
                vlIdEstatusNvo := 1;                
            ELSIF paWSPedidosCD(i).FIESTATUSCD = 490 THEN --ATENDIENDO SOLICITUD  
                vlEstatusCD := 3; 
                vlDescripcionCD := vlMsgAtendiendo;
                vlIdTipoEvento := 1;
                vlIdEstatusNvo := 1;                
            ELSIF paWSPedidosCD(i).FIESTATUSCD = 850 AND paWSPedidosCD(i).FIRUTA > 0 THEN --ENVIADO A TIENDA
                vlEstatusCD := 4; 
                vlDescripcionCD := vlMsgEnviadoATienda;
                vlIdTipoEvento := 1;
                vlIdEstatusNvo := 1;                
            ELSIF paWSPedidosCD(i).FIESTATUSCD = 850 AND paWSPedidosCD(i).FIRUTA = 0 THEN --REMISIONADO SIN RUTA (CD)
                vlEstatusCD := 5; 
                vlDescripcionCD := vlMsgRemisionado;
                vlIdTipoEvento := 1;
                vlIdEstatusNvo := 1;                
            ELSIF paWSPedidosCD(i).FIESTATUSCD = 940 OR UPPER(trim(paWSPedidosCD(i).FCDESCRIPCIONCD))= vlMsgCancelado THEN --CANCELADO
                vlCancelacionCD := 1; 
                vlIdTipoEvento := 1;
                vlIdEstatusNvo := 1;                
            END IF;
            
    --**************************************************************************             
    --PROCESO DE LLENADO DE BITACORA********************************************
            
            --IDENTIFICA IDBITACORA
            SELECT NVL(MAX(FIIDBITACORA), csgCero) + csgUno
                INTO vlIdBitacora
            FROM UNIFORMES.TABITACORASOLICITUD;            
            
            --INSERCION DE TABITACORASOLICITUD
            INSERT INTO UNIFORMES.
                TABITACORASOLICITUD (     
                    FIIDBITACORA, 
                    FIFOLIOSOLICITUD, 
                    FIIDDETALLE, 
                    FIPAIS, 
                    FICANAL, 
                    FIIDSUCURSAL, 
                    FINUMPEDIDO, 
                    FISKU, 
                    FIIDTIPOEVENTO, 
                    FXDATOS, 
                    FIIDESTATUSANT, 
                    FIIDESTATUSNVO, 
                    FDFECHAEVENTO, 
                    FIIDERROR, 
                    FCCOMENTARIOS)
                VALUES  (   vlIdBitacora,
                            paWSPedidosCD(i).FIFOLIOSOLICITUD,
                            paWSPedidosCD(i).FIIDDETALLE, 
                            paWSPedidosCD(i).FIPAIS,
                            paWSPedidosCD(i).FICANAL,
                            paWSPedidosCD(i).FIIDSUCURSAL,
                            paWSPedidosCD(i).FIPEDIDO,
                            paWSPedidosCD(i).FISKU,
                            vlIdTipoEvento,
                            XMLTYPE(paWSPedidosCD(i).FCXMLRESPONSE),
                            FNESTATUSPEDIDOSCD( paWSPedidosCD(i).FIPAIS,
                                                paWSPedidosCD(i).FICANAL,
                                                paWSPedidosCD(i).FIIDSUCURSAL,
                                                paWSPedidosCD(i).FIPEDIDO,
                                                paWSPedidosCD(i).FISKU ),
                                                vlIdEstatusNvo,
                                                SYSDATE,
                                                0,
                                                vlDescripcionCD);
                                                
    --************************************************************************** 
    
            IF vlCancelacionCD <> 1 THEN
                          
                IF paWSPedidosCD(i).FIESTATUSCD = cslEstatusCDReasignado THEN -- INSERCION DE LOS PEDIDOSCD QUE SE TIENEN QUE REINYECTAR

                    -- SI ENCUENTRA UNA IGUAL LA ACTUALIZA
                    MERGE INTO UNIFORMES.TAREINYECCIONPEDIDOSCD RPCD
                    USING (SELECT 	paWSPedidosCD(i).FIPAIS AS FIPAIS,
                                    paWSPedidosCD(i).FICANAL AS FICANAL,
                                    paWSPedidosCD(i).FIIDSUCURSAL AS FIIDSUCURSAL,
                                    paWSPedidosCD(i).FIPEDIDO AS FIPEDIDO,
                                    paWSPedidosCD(i).FISKU AS FISKU         
                            FROM SYS.DUAL) TYPEARRAYPEDIDOSCD
                        ON  ( 
                                RPCD.FIPAIS = TYPEARRAYPEDIDOSCD.FIPAIS AND
                                RPCD.FICANAL = TYPEARRAYPEDIDOSCD.FICANAL AND
                                RPCD.FIIDSUCURSAL = TYPEARRAYPEDIDOSCD.FIIDSUCURSAL AND
                                RPCD.FIPEDIDO = TYPEARRAYPEDIDOSCD.FIPEDIDO AND
                                RPCD.FISKU = TYPEARRAYPEDIDOSCD.FISKU
                            )
                     WHEN NOT MATCHED THEN
                        INSERT (
                                RPCD.FIPAIS,
                                RPCD.FICANAL,
                                RPCD.FIIDSUCURSAL,
                                RPCD.FIPEDIDO,
                                RPCD.FISKU,
                                RPCD.FIACTIVA,
                                RPCD.FCDESCRIPCIONCD,
                                RPCD.FDFECHA
                        ) 
                        VALUES(
                                TYPEARRAYPEDIDOSCD.FIPAIS,
                                TYPEARRAYPEDIDOSCD.FICANAL,
                                TYPEARRAYPEDIDOSCD.FIIDSUCURSAL,
                                TYPEARRAYPEDIDOSCD.FIPEDIDO,
                                TYPEARRAYPEDIDOSCD.FISKU,
                                cslReinyeccionActiva,
                                vlDescripcionCD,
                                SYSDATE
                        );
                    
                    INSERT INTO UNIFORMES.
                        TAREINYECCIONPEDIDOSCD(
                            FIPAIS,
                            FICANAL, 
                            FIIDSUCURSAL, 
                            FIPEDIDO, 
                            FISKU,
                            FIACTIVA,
                            FCDESCRIPCIONCD) 
                    VALUES(
                            paWSPedidosCD(i).FIPAIS,
                            paWSPedidosCD(i).FICANAL,
                            paWSPedidosCD(i).FIIDSUCURSAL,
                            paWSPedidosCD(i).FIPEDIDO,
                            paWSPedidosCD(i).FISKU,
                            cslReinyeccionActiva,
                            vlDescripcionCD
                    );
                    
                END IF;
                
            ELSE
                -- PEDIDOSCD QUE NO SE YA SE NO SE VAN UTILIZAR (CANCELADAS DEFINITIVAS)
                UPDATE  UNIFORMES.TAPEDIDOSCD
                    SET FICANCELADO = cslEsCancelado,
                        FCDESCRIPCIONCD = vlDescripcionCD,
                        FIESTATUSCD = cslEstatusCancelado
                    WHERE   FIPAIS = paWSPedidosCD(i).FIPAIS
                        AND FICANAL = paWSPedidosCD(i).FICANAL
                        AND FIIDSUCURSAL = paWSPedidosCD(i).FIIDSUCURSAL
                        AND FIPEDIDO = paWSPedidosCD(i).FIPEDIDO
                        AND FISKU = paWSPedidosCD(i).FISKU;       
                
            END IF;
            

        END LOOP;
        
        COMMIT;
  
       	EXCEPTION
          WHEN OTHERS THEN
              ROLLBACK;
              vgErrCode := SQLCODE;
              vgErrMsg := SQLERRM;
              RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PASRVUNIFORMESCOMERCIO.SPACTPEDIDOSOLBITACORA": ' || vgErrMsg);
              
  END SPACTUALIZARPEDIDOSCD;
   
   FUNCTION FNCONSSOLPENDGRABARCD
   RETURN rcgCursor
   IS 
  /*************************************************************
   Proyecto:                         Sistema de Uniformes
   Descripcion:                      Consulta datos de empleado
   Parametros de entrada:            paNumEmpleado    Numero de empleado
   Parametros de salida:             curDatos         Cursor de referencia
   Parametros de entrada-salida      No aplica
   Precondiciones:                   Tener creado el esquema
   Creador:                          
   Fecha de creacion:                
  *************************************************************/
  curCursorSalida rcgCursor;
  vlSolenTienda  NUMBER(1):= 1;
  BEGIN
          OPEN curCursorSalida FOR
        SELECT S.FIFOLIOSOLICITUD,
			   D.FIIDDETALLE,
			   E.FIEMPLEADO,
			   D.FIPAIS,
			   D.FICANAL,
			   TO_NUMBER( SUBSTR(TO_CHAR(D.FISUCURSAL),3,4) ) FISUCURSAL,
			   T.FCDIRIP,
			   B.FISKU,
			   B.FINUMPEDIDO,
			   D.FICANTIDAD,
               D.FITALLA
		  FROM UNIFORMES.TASOLICITUDES S
	INNER JOIN UNIFORMES.TASOLICITUDESDETALLE D
			ON S.FIFOLIOSOLICITUD = D.FIFOLIOSOLICITUD
	INNER JOIN UNIFORMES.TAEMPLEADOS E
			ON E.FIEMPLEADO = S.FIIDEMPLEADO
    INNER JOIN UNIFORMES.TATIENDAS T
            ON T.FIPAIS = D.FIPAIS
           AND T.FICANAL = D.FICANAL
           AND T.FISUCURSAL = D.FISUCURSAL
	INNER JOIN UNIFORMES.TABITACORASOLICITUD B
	        ON B.FIFOLIOSOLICITUD = D.FIFOLIOSOLICITUD
	       AND B.FIIDDETALLE = D.FIIDDETALLE
	INNER JOIN (  SELECT MAX(FDFECHAEVENTO) FECHABITACORA,FIFOLIOSOLICITUD,FIIDDETALLE
				    FROM UNIFORMES.TABITACORASOLICITUD
					  GROUP BY FIFOLIOSOLICITUD,FIIDDETALLE ) BACT
	        ON B.FIFOLIOSOLICITUD = BACT.FIFOLIOSOLICITUD
	       AND B.FIIDDETALLE = BACT.FIIDDETALLE
	       AND B.FDFECHAEVENTO = BACT.FECHABITACORA
	     WHERE B.FIIDESTATUSNVO = vlSolenTienda 
		   AND B.FIIDESTATUSANT = vlSolenTienda 
		   AND B.FINUMPEDIDO IS NOT NULL
		   AND B.FIIDERROR = csgCero
	  ORDER BY S.FIFOLIOSOLICITUD,
			   D.FIIDDETALLE,
			   E.FIEMPLEADO;
       RETURN curCursorSalida;
       	EXCEPTION
          WHEN OTHERS THEN
              vgErrCode := SQLCODE;
              vgErrMsg := SQLERRM;
              RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PASRVUNIFORMESCOMERCIO.FNCONSSOLPENDGRABARCD": ' || vgErrMsg);
              
  END FNCONSSOLPENDGRABARCD;
  
  FUNCTION FNCONSULTAPEDIDOSENCD
  RETURN rcgCursor
  IS 
  /*************************************************************
   Proyecto:                         Sistema de Uniformes
   Descripcion:                      Consulta datos de empleado
   Parametros de entrada:            paNumEmpleado    Numero de empleado
   Parametros de salida:             curDatos         Cursor de referencia
   Parametros de entrada-salida      No aplica
   Precondiciones:                   Tener creado el esquema
   Creador:                          
   Fecha de creacion:                
  *************************************************************/
  curCursorSalida rcgCursor;
  vlSolenTienda  NUMBER(1):= 1;
  vlSolenCD  NUMBER(1):= 2;
  
  BEGIN
          OPEN curCursorSalida FOR
        SELECT S.FIFOLIOSOLICITUD,
			   D.FIIDDETALLE,
			   E.FIEMPLEADO,
			   D.FIPAIS,
			   FICANAL,
			   TO_NUMBER( SUBSTR(TO_CHAR(D.FISUCURSAL),3,4) ) FISUCURSAL,
			   T.FCDIRIP,
			   B.FISKU,
			   B.FINUMPEDIDO,
			   D.FICANTIDAD
		  FROM UNIFORMES.TASOLICITUDES S
	INNER JOIN UNIFORMES.TASOLICITUDESDETALLE D
			ON S.FIFOLIOSOLICITUD = D.FIFOLIOSOLICITUD
	INNER JOIN UNIFORMES.TAEMPLEADOS E
			ON E.FIEMPLEADO = S.FIIDEMPLEADO
    INNER JOIN UNIFORMES.TATIENDAS T
            ON T.FIPAIS = D.FIPAIS
           AND T.FICANAL = D.FICANAL
           AND T.FISUCURSAL = D.FISUCURSAL
	INNER JOIN UNIFORMES.TABITACORASOLICITUD B
	        ON B.FIFOLIOSOLICITUD = D.FIFOLIOSOLICITUD
	       AND B.FIIDDETALLE = D.FIIDDETALLE
	INNER JOIN (  SELECT MAX(FDFECHAEVENTO) FECHABITACORA,FIFOLIOSOLICITUD,FIIDDETALLE
				    FROM UNIFORMES.TABITACORASOLICITUD
					  GROUP BY FIFOLIOSOLICITUD,FIIDDETALLE ) BACT
	        ON B.FIFOLIOSOLICITUD = BACT.FIFOLIOSOLICITUD
	       AND B.FIIDDETALLE = BACT.FIIDDETALLE
	       AND B.FDFECHAEVENTO = BACT.FECHABITACORA
	     WHERE B.FIIDESTATUSNVO = vlSolenCD 
		   AND B.FIIDESTATUSANT = vlSolenTienda 
		   AND B.FINUMPEDIDO IS NOT NULL
		   AND B.FIIDERROR = csgCero
	  ORDER BY S.FIFOLIOSOLICITUD,
			   D.FIIDDETALLE,
			   E.FIEMPLEADO;
       RETURN curCursorSalida;
       	EXCEPTION
          WHEN OTHERS THEN
              vgErrCode := SQLCODE;
              vgErrMsg := SQLERRM;
              RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' EN "PASRVUNIFORMESCOMERCIO.FNCONSULTAPEDIDOSENCD": ' || vgErrMsg);
              
  END FNCONSULTAPEDIDOSENCD;
  
 PROCEDURE SPCONSULTAPEDIDOSDESCUENTOSSAP(
    curResultado OUT rcgCursor)
 IS   
 cslEmpleadoActivo      CONSTANT VARCHAR2(1) := 'A';
 cslEstatusEntregado    CONSTANT NUMBER(1) := 6;
 cslNoQuincenas         CONSTANT NUMBER(1) := 8;
 cslCero                CONSTANT NUMBER(1) := 0;   
 cslDos                 CONSTANT NUMBER(1) := 2;    
 cslOcho                CONSTANT NUMBER(1) := 8;
 vlIdBitacora           UNIFORMES.TABITACORASOLICITUD.FIIDBITACORA%TYPE;
 cslTipoEvento          UNIFORMES.TABITACORASOLICITUD.FIIDTIPOEVENTO%TYPE := 110; -- EVENTO DESCUENTO SAP
  /************************************************************************************************************
    Proyecto:              Cron Uniformes Comercio V2
    Descripcion:           Consulta la informacion de los pedidos de los empleados para el descuento SAP (Armado para envio por SOAP)
    Parametros de entrada: TYPE
    Parametros de salida:  Respuesta del Stored Procedure
    Parametros de ent-sal: No aplica
    Valor de retorno:      No aplica 
    Creador:               Luis Daniel Rodriguez Garcia
    Fecha de creacion:     21 Febrero de 2017
 *************************************************************************************************************/           
 BEGIN
 OPEN curResultado
    FOR
        SELECT  LPAD(S.FIIDEMPLEADO, cslOcho, cslCero) AS FCIDEMPLEADOSAP,
                TO_CHAR(NEXT_DAY(SYSDATE, TO_CHAR(TO_DATE('05-06-2006', 'dd-mm-yyyy'), 'Day')), 'yyyymmdd') AS FCFECHADESCUENTO, -- DIA DEL DESCUENTO
                PCD.FIPEDIDO, -- NO. PEDIDO
                TO_CHAR(SD.FNPRECIOTOTAL) AS FCPRECIOTOTAL, -- TOTAL A PAGAR
                TO_CHAR(ROUND(SD.FNPRECIOTOTAL/cslNoQuincenas, cslDos)) AS FCDESCUENTOSEMANAL, -- TOTAL A PAGAR X QUINCENA
                PCD.FIFOLIOSOLICITUD, -- FOLIO SOLICITUD  
                SD.FIIDDETALLE, --IDDETALLE
                SD.FIPAIS, -- PAIS
                SD.FICANAL, -- CANAL
                SD.FISUCURSAL, -- SUCURSAL
                PCD.FISKU, -- SKU
                PCD.FIIDESTATUSPEDIDO, -- ESTATUS DEL PEDIDO
                (PCD.FIFOLIOSOLICITUD || '-' || PCD.FIPEDIDO || '-' || PCD.FIPAIS) AS FCREFENCIASAP -- REFERENCIA SAP
        FROM UNIFORMES.TAPEDIDOSCD PCD
        INNER JOIN UNIFORMES.TASOLICITUDESDETALLE SD
            ON (SD.FIFOLIOSOLICITUD = PCD.FIFOLIOSOLICITUD AND SD.FIIDDETALLE = PCD.FIIDDETALLE)
        INNER JOIN UNIFORMES.TASOLICITUDES S
            ON (S.FIFOLIOSOLICITUD = SD.FIFOLIOSOLICITUD)
        INNER JOIN UNIFORMES.TAEMPLEADOSCOMERCIO E -- CAMBIAR TABLA 
        --INNER JOIN UNIFORMES.TAEMPLEADOS E
            ON (E.FIEMPLEADO = S.FIIDEMPLEADO)
        WHERE PCD.FIIDESTATUSPEDIDO = cslEstatusEntregado
            AND SD.FNPRECIOTOTAL <> cslCero -- SI ES DIFERENTE DE CERO PERTENECE A CARGA SEMESTRAL
            AND S.FIIDTIPOSOLICITUD = 2 -- TIPO SOLICITUD VOLUNTARIA
            AND E.FCSITUACION = cslEmpleadoActivo; -- SI EL EMPLEADO ESTA ACTIVO
 EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
            vgErrCode := SQLCODE;
            vgErrMsg := SQLERRM;
            RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' "PASRVUNIFORMESCOMERCIO.SPCONSULTAPEDIDOSDESCUENTOSSAP": ' || vgErrMsg );
            
 END SPCONSULTAPEDIDOSDESCUENTOSSAP;


 PROCEDURE SPSEGUIMIENTOPEDDESCSAP( 
    paSeguimientoPedidosDescuentos IN UNIFORMES.TYPEARRSEGUIMIENTOPEDDESCSAP
 )
 IS
 cslRespuestaOKSap              CONSTANT NUMBER(1) := 1;
 cslEstatusEntrega              UNIFORMES.TAESTATUSPEDIDOS.FIIDESTATUSPEDIDO%TYPE := 6;     -- ESTATUS DE ENTREGA
 cslEstatusDescuentosSAP        UNIFORMES.TAESTATUSPEDIDOS.FIIDESTATUSPEDIDO%TYPE := 7;     -- ESTATUS DESCUENTO SAP
 cslTipoEvento 	                UNIFORMES.TABITACORASOLICITUD.FIIDTIPOEVENTO%TYPE := 110;   -- EVENTO PEDIDO DESCUENTO SAP
 vlSecuenciaDescuentosXPedidos  UNIFORMES.TADESCUENTOSXPEDIDOS.FICONSECUTIVO%TYPE;          -- SECUENCIA DE TADESCUENTOSXPEDIDOS
 vlIdBitacora 	                UNIFORMES.TABITACORASOLICITUD.FIIDBITACORA%TYPE;            -- SECUENCIA DE TABITACORASOLICITUD
 BEGIN
      FOR i IN 1..paSeguimientoPedidosDescuentos.count
        LOOP
            SELECT  NVL(MAX(FIIDBITACORA), csgCero) + 1 
                INTO vlIdBitacora
            FROM UNIFORMES.TABITACORASOLICITUD;
                         
            SELECT COUNT(FICONSECUTIVO) + 1
                INTO vlSecuenciaDescuentosXPedidos
            FROM UNIFORMES.TADESCUENTOSXPEDIDOS
            WHERE FIFOLIOCENTRAL = paSeguimientoPedidosDescuentos(i).FIFOLIOSOLICITUD
              AND FIPAIS = paSeguimientoPedidosDescuentos(i).FIPAIS
              AND FICANAL = paSeguimientoPedidosDescuentos(i).FICANAL
              AND FISUCURSAL = paSeguimientoPedidosDescuentos(i).FIIDSUCURSAL
              AND FIPEDIDO = paSeguimientoPedidosDescuentos(i).FIPEDIDO
              AND FISKU = paSeguimientoPedidosDescuentos(i).FISKU
              AND FCREFERENCIA = paSeguimientoPedidosDescuentos(i).FCREFERENCIASAP;    
              
            INSERT INTO UNIFORMES.TABITACORASOLICITUD(  
                                                        FIIDBITACORA,
                                                        FIFOLIOSOLICITUD,
                                                        FIIDDETALLE,
                                                        FIPAIS,
                                                        FICANAL,
                                                        FIIDSUCURSAL,
                                                        FINUMPEDIDO,
                                                        FISKU,
                                                        FIIDTIPOEVENTO,
                                                        FXDATOS,
                                                        FIIDESTATUSANT,
                                                        FIIDESTATUSNVO,
                                                        FDFECHAEVENTO,
                                                        FIIDERROR,
                                                        FCCOMENTARIOS)   
                                                VALUES(
                                                        vlIdBitacora,                                                   
                                                        paSeguimientoPedidosDescuentos(i).FIFOLIOSOLICITUD,
                                                        paSeguimientoPedidosDescuentos(i).FIIDDETALLE,
                                                        paSeguimientoPedidosDescuentos(i).FIPAIS,
                                                        paSeguimientoPedidosDescuentos(i).FICANAL,
                                                        paSeguimientoPedidosDescuentos(i).FIIDSUCURSAL,
                                                        paSeguimientoPedidosDescuentos(i).FIPEDIDO,
                                                        paSeguimientoPedidosDescuentos(i).FISKU,
                                                        cslTipoEvento,
                                                        XMLTYPE(paSeguimientoPedidosDescuentos(i).FCXMLRESPONSE),
                                                        cslEstatusEntrega,
                                                        cslEstatusDescuentosSAP,
                                                        SYSDATE,
                                                        paSeguimientoPedidosDescuentos(i).FIIDERROR,
                                                        paSeguimientoPedidosDescuentos(i).FCTEXTXMLRESPONSE);
                                                        
            IF( paSeguimientoPedidosDescuentos(i).FIESTATUSSAP = cslRespuestaOKSap ) THEN -- SI EL ESTATUS SAP ES 1 ENTONCES SE INSERTA EN TADESCUENTOSXPEDIDOS                                                                                            
                INSERT INTO UNIFORMES.TADESCUENTOSXPEDIDOS(
                                                            FICONSECUTIVO,        
                                                            FIFOLIOCENTRAL,
                                                            FIPAIS,
                                                            FICANAL,
                                                            FISUCURSAL,
                                                            FIPEDIDO,
                                                            FISKU,
                                                            FCREFERENCIA,
                                                            FIESTATUS,
                                                            FCPETICION,
                                                            FCRESPUESTA)   
                                                    VALUES(
                                                            vlSecuenciaDescuentosXPedidos,                                            
                                                            paSeguimientoPedidosDescuentos(i).FIFOLIOSOLICITUD,
                                                            paSeguimientoPedidosDescuentos(i).FIPAIS,
                                                            paSeguimientoPedidosDescuentos(i).FICANAL,
                                                            paSeguimientoPedidosDescuentos(i).FIIDSUCURSAL,
                                                            paSeguimientoPedidosDescuentos(i).FIPEDIDO,
                                                            paSeguimientoPedidosDescuentos(i).FISKU,
                                                            paSeguimientoPedidosDescuentos(i).FCREFERENCIASAP,
                                                            paSeguimientoPedidosDescuentos(i).FIESTATUSSAP,
                                                            paSeguimientoPedidosDescuentos(i).FCXMLREQUEST,
                                                            paSeguimientoPedidosDescuentos(i).FCXMLRESPONSE
                                                    );
                UPDATE UNIFORMES.TAPEDIDOSCD 
                    SET FIIDESTATUSPEDIDO = cslEstatusDescuentosSAP 
                WHERE FIPAIS = paSeguimientoPedidosDescuentos(i).FIPAIS
                    AND FICANAL = paSeguimientoPedidosDescuentos(i).FICANAL
                    AND FIIDSUCURSAL = paSeguimientoPedidosDescuentos(i).FIIDSUCURSAL
                    AND FIPEDIDO = paSeguimientoPedidosDescuentos(i).FIPEDIDO
                    AND FISKU = paSeguimientoPedidosDescuentos(i).FISKU;               
            END IF;
        
        END LOOP;
 EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
            vgErrCode := SQLCODE;
            vgErrMsg := SQLERRM;
            RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' "PASRVUNIFORMESCOMERCIO.SPSEGUIMIENTOPEDDESCSAP": ' || vgErrMsg );        

 END SPSEGUIMIENTOPEDDESCSAP;
 
 PROCEDURE SPACTUALIZATIENDAS(
    noTiendas out NUMBER) 
 IS   
 vlNumeroRegistros NUMBER;
 /************************************************************************************************************
    Proyecto:              SRVUniformes Comercio
    Descripcion:           Actualiza e inserta inserciones a la tabla UNIFORMES.TATIENDAS, es utilizado por un Cron
    Parametros de entrada: No aplica
    Parametros de salida:  Numero de las tiendas insertadas.
    Parametros de ent-sal: No aplica
    Valor de retorno:      No aplica 
    Creador:               Luis Daniel Rodriguez Garcia
    Fecha de creacion:     22 Noviembre de 2017
 *************************************************************************************************************/
 BEGIN 
    MERGE INTO UNIFORMES.TATIENDAS T
    USING  (
            SELECT  TDIRIP.FIPAISID AS FIPAIS, 
                    TO_NUMBER(TRIM(CC.FCIDCANAL)) AS FICANAL,
                    TDIRIP.FITIENDAID AS FISUCURSAL,             
                    TRIM(CC.FCNOMBRE) AS FCNOMBRE,
                    TRIM(TDIRIP.FCDIRECCIONIP) AS FCDIRIP
            FROM UNIFORMES.TATIENDASDIRIP TDIRIP
                    INNER JOIN  UNIFORMES.TACECO CC
                        ON      TO_NUMBER(SUBSTR(TRIM(TO_CHAR(CC.FICC)),csgTres,csgCuatro)) = TDIRIP.FITIENDAID
                        AND     CC.FIPAIS = TDIRIP.FIPAISID
                        AND     CC.FIESTATUS = csgUno
                        AND     CC.FIIDTIPOOP = csgDieceNueve
                        AND     FNREGRESANUMERO(CC.FCIDCANAL) = TDIRIP.FICANALCECO
            ) TGENERAL
    ON      (
            T.FIPAIS = TGENERAL.FIPAIS 
            AND T.FICANAL = TGENERAL.FICANAL
            AND T.FISUCURSAL = TGENERAL.FISUCURSAL
            )
    WHEN MATCHED THEN 
        UPDATE SET  T.FCNOMBRE = TGENERAL.FCNOMBRE,
                    T.FCDIRIP = TGENERAL.FCDIRIP
    WHEN NOT MATCHED THEN
            INSERT (
                    T.FIPAIS,
                    T.FICANAL,
                    T.FISUCURSAL,
                    T.FCNOMBRE,
                    T.FCDIRIP,
                    T.FIIDCDISTRIBUCION,
                    T.FIIDFORMADOR
                    ) 
            VALUES (
                    TGENERAL.FIPAIS,
                    TGENERAL.FICANAL,
                    TGENERAL.FISUCURSAL,
                    TGENERAL.FCNOMBRE,
                    TGENERAL.FCDIRIP,
                    csgCero,
                    csgCero
                    );
                    
    noTiendas := SQL%ROWCOUNT;
    
 EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
            vgErrCode := SQLCODE;
            vgErrMsg := SQLERRM;
            RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' "PASRVUNIFORMESCOMERCIO.SPACTUALIZATIENDAS": ' || vgErrMsg );

 END SPACTUALIZATIENDAS;
 
 FUNCTION FNREGRESANUMERO(
        paCadena UNIFORMES.TACECO.FCIDCANAL%TYPE)
 RETURN NUMBER
 IS
 vlNumero UNIFORMES.TAEQUIVALENCIACANALES.FICANALCECO%TYPE;
 /************************************************************************************************************
    Proyecto:              SRVUniformes Comercio 
    Descripcion:           Transforma una cadena a un numero
    Parametros de entrada: Una cadena de numeros
    Parametros de salida:  Un numero
    Parametros de ent-sal: No aplica
    Valor de retorno:      No aplica 
    Creador:               Luis Daniel Rodriguez Garcia
    Fecha de creacion:     5 de Marzo del 2017
 *************************************************************************************************************/
 BEGIN
    vlNumero := TO_NUMBER(TRIM(paCadena));
 RETURN vlNumero;
    
 EXCEPTION
    WHEN VALUE_ERROR THEN
        RETURN csgCero;
        
 END FNREGRESANUMERO;
 
 PROCEDURE SPCARGATIENDASDIRIP(
    paTiendas   IN OUT UNIFORMES.TYPARRTIENDASDIRIP,
    paNoTiendas OUT NUMBER,
    curResultado OUT rcgCursor) 
 IS
    CURSOR curEquivalenciaCanales IS (SELECT FICANAL,FICANALCECO FROM UNIFORMES.TAEQUIVALENCIACANALES);
 /************************************************************************************************************
    Proyecto:              SRVUniformes Comercio
    Descripcion:           Borra y realiza las nuevas inserciones a la tabla UNIFORMES.TATIENDASDIRIP
    Parametros de entrada: (paTiendas) Se agregan todas las tiendas en un TypeArray.
    Parametros de salida:  (paNoTiendas) Numero de las tiendas insertadas.
    Parametros de ent-sal: No aplica
    Valor de retorno:      No aplica 
    Creador:               Luis Rodriguez
    Fecha de creacion:     5 de Marzo del 2017
 *************************************************************************************************************/
 BEGIN
    
    IF paTiendas.COUNT > csgCero THEN
    
        EXECUTE IMMEDIATE 'TRUNCATE TABLE UNIFORMES.TATIENDASDIRIP DROP STORAGE';        

        FOR i IN paTiendas.FIRST..paTiendas.LAST LOOP
            FOR tipoCanal IN curEquivalenciaCanales LOOP

                IF ( tipoCanal.FICANAL =  paTiendas(i).FICANAL ) THEN
                
                    paTiendas(i).FICANALCECO := tipoCanal.FICANALCECO;
                    
                    INSERT INTO UNIFORMES.TATIENDASDIRIP
                        (
                            FITIENDAID,
                            FIPAISID,
                            FICANAL,
                            FICANALCECO,                        
                            FCDESCRIPCION,
                            FCDIRECCIONIP
                        ) 
                    VALUES 
                        (
                            paTiendas(i).FITIENDAID,
                            paTiendas(i).FIPAISID,
                            paTiendas(i).FICANAL,
                            paTiendas(i).FICANALCECO,
                            paTiendas(i).FCDESCRIPCION,
                            paTiendas(i).FCDIRECCIONIP
                        );
                END IF;
             END LOOP;
        END LOOP;        

        COMMIT;
        
        SELECT COUNT(FITIENDAID) INTO paNoTiendas FROM UNIFORMES.TATIENDASDIRIP;

        OPEN curResultado
            FOR
                SELECT  FITIENDAID,
                        FIPAISID,
                        FICANAL,
                        FICANALCECO,
                        FCDESCRIPCION,
                        FCDIRECCIONIP
                    FROM UNIFORMES.TATIENDASDIRIP;
        
    END IF;

 EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        vgErrCode := SQLCODE;
        vgErrMsg := SQLERRM;
        RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' "PACARGATIENDAS.SPCARGATIENDASIP": ' || vgErrMsg );

 END SPCARGATIENDASDIRIP;
 
 PROCEDURE SPACTUALIZADESCUENTOSSAP(
    paDescuentosSAP IN UNIFORMES.TYPEARRDESCUENTOSSAP,
    paNoRegistrosAct OUT NUMBER) 
 IS   
 /************************************************************************************************************
    Proyecto:              SRVUniformes Comercio
    Descripcion:           Actualiza e inserta inserciones a la tabla UNIFORMES.TADESCUENTOSSAP, es utilizado por un Cron
    Parametros de entrada: No aplica
    Parametros de salida:  Numero de las tiendas insertadas.
    Parametros de ent-sal: No aplica
    Valor de retorno:      No aplica 
    Creador:               Luis Daniel Rodriguez Garcia
    Fecha de creacion:     6 Marzo de 2017
 *************************************************************************************************************/
 BEGIN
        
    MERGE INTO UNIFORMES.TADESCUENTOSSAPTEST DSAP
        USING (SELECT   FIFOLIOSOLICITUD,
                        FIPEDIDO,
                        FCREFERENCIA,
                        FCSOCIEDAD,
                        FCCNOMINA,
                        FNTOTAL,
                        FDFECHAPAGO,
                        FISEMACTUAL,
                        FNSALDO,
                        FNPAGO
                FROM TABLE(paDescuentosSAP)) DRHSAP
        ON (DSAP.FIFOLIOCENTRAL = DRHSAP.FIFOLIOSOLICITUD AND
            DSAP.FIPEDIDO = DRHSAP.FIPEDIDO AND
            DSAP.FCSOCIEDAD = DRHSAP.FCSOCIEDAD AND
            DSAP.FDPAGO = DRHSAP.FDFECHAPAGO)
    WHEN NOT MATCHED THEN
        INSERT (FIFOLIOCENTRAL,
                FIPEDIDO,
                FCREFERENCIA,
                FCSOCIEDAD,
                FCCCNOMINA,
                FNTOTDESCUENTO,
                FDPAGO,
                FISEMADESCUENTO,
                FNSALDO,
                FNPAGO)
        VALUES( DRHSAP.FIFOLIOSOLICITUD,
                DRHSAP.FIPEDIDO,
                DRHSAP.FCREFERENCIA,
                DRHSAP.FCSOCIEDAD,
                DRHSAP.FCCNOMINA,
                DRHSAP.FNTOTAL,
                DRHSAP.FDFECHAPAGO,
                DRHSAP.FISEMACTUAL,
                DRHSAP.FNSALDO,
                DRHSAP.FNPAGO);
 
 paNoRegistrosAct := SQL%ROWCOUNT;
 
 EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
            vgErrCode := SQLCODE;
            vgErrMsg := SQLERRM;
            RAISE_APPLICATION_ERROR (-20002,'ERROR ' || vgErrCode  || ' "PASRVUNIFORMESCOMERCIO.SPACTUALIZADESCUENTOSSAP": ' || vgErrMsg );

 END SPACTUALIZADESCUENTOSSAP;
 
END PASRVUNIFORMESCOMERCIO;
/

SHOW ERRORS;


CREATE OR REPLACE PACKAGE BODY           PASRVOPERAUNIFORMES
AS
/*************************************************************
     Proyecto:                       Uniformes 
     Descripcion:                    Paquete para Crones De uniformes
     Parametros de entrada:          Todos los campos
     Parametros de salida:           No aplica
     Parametros de entrada-salida    No aplica
     Precondiciones:                 Tener creado el esquema
     Creador:                        R. Isaac Suárez Mercado
     Fecha de creacion:              09 Junio 2014
********************************************************************/
 

FUNCTION FNCONSULTATIENDAS
RETURN rcgCursor
IS
 /********************************************************************************
    Descripcion: Función consulta pedidos en cero 
    Parámetros de entrada:  No aplica
    Parámetros de salida: No aplica
    Parámetros de entrada-salida: Ninguno
    Valor de retorno: Cursor con resultado.
    Creador: 
    Fecha de creación: 09 JUNIO 2014
 **************************************************************************************/
  
    curDatos         rcgCursor; 
    vlEstatus        UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE:= 20;
  
BEGIN
  
   OPEN curDatos FOR
     SELECT A.FIPAIS 
           ,A.FICANAL 
           ,A.FISUCURSAL 
           ,A.FIFOLIOCENTRAL
           ,B.FCDIRIP 
           ,C.FIEMPLEADO  
           ,A.FICANTIDAD
           ,A.FISKU
           ,A.FIESTATUS
           ,TO_CHAR(A.FDACTUALIZACION,'DD/MM/YYYY HH24:MI:SS') AS FDACTUALIZACION
           ,E.FCSITUACION
       FROM UNIFORMES.TAEMPLEADOS E
      INNER JOIN UNIFORMES.TAPEDIDOS C
         ON (E.FIEMPLEADO = C.FIEMPLEADO)
      INNER JOIN UNIFORMES.TADETALLEPEDIDOS A
         ON (C.FIFOLIOCENTRAL = A.FIFOLIOCENTRAL)
      INNER JOIN UNIFORMES.TASUCURSALES B
         ON (A.FISUCURSAL = B.FISUCURSAL)
      WHERE A.FIESTATUS = vlEstatus;
  
   RETURN curDatos;
  
END FNCONSULTATIENDAS;


PROCEDURE SPACTPEDIDOTIENDA(
   paPais      IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FIPAIS%TYPE
  ,paCanal     IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FICANAL%TYPE
  ,paSucursal  IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FISUCURSAL%TYPE
  ,paPedido    IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FIPEDIDO%TYPE
  ,paFolioCentral  IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FIFOLIOCENTRAL%TYPE
  ,paSKU       IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FISKU%TYPE
  ,paEstatusAnt  IN  UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE
  ,paActualizacion  IN VARCHAR2 )
IS
/********************************************************************************
    Descripcion: actualiza pedido tienda 
    Parámetros de entrada:  No aplica
    Parámetros de salida: No aplica
    Parámetros de entrada-salida: Ninguno
    Valor de retorno: Cursor con resultado.
    Creador: 
    Fecha de creación: 09 JUNIO 2014
**************************************************************************************/

    cslCero      NUMBER(1):= 0;
    vlEstatus    UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE:= 30;  -- ENVIADO A TIENDA
BEGIN

    UPDATE UNIFORMES.TADETALLEPEDIDOS
       SET FIPEDIDO = paPedido
     WHERE FIFOLIOCENTRAL = paFolioCentral 
       AND FIPAIS = paPais
       AND FICANAL = paCanal
       AND FISUCURSAL = paSucursal
       AND FIPEDIDO =  cslCero
       AND FISKU =  paSKU;
       
       
   UNIFORMES.PAWSUNIFORMES.SPACTMOVTOPEDIDOS( paPais
                                             ,paCanal
                                             ,paSucursal
                                             ,paPedido
                                             ,paFolioCentral
                                             ,paSKU
                                             ,paEstatusAnt
                                             ,paActualizacion
                                             ,vlEstatus);    

END SPACTPEDIDOTIENDA;


FUNCTION FNCONSULTAABASTO
RETURN rcgCursor
IS
 /********************************************************************************
    Descripcion: Función consulta pedidos en cero 
    Parámetros de entrada:  No aplica
    Parámetros de salida: No aplica
    Parámetros de entrada-salida: Ninguno
    Valor de retorno: Cursor con resultado.
    Creador: 
    Fecha de creación: 09 JUNIO 2014
**************************************************************************************/
  
    curDatos         rcgCursor; 
    vlEstatus        UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE := 30;  -- Enviado a Tienda
  
BEGIN
  
   OPEN curDatos FOR
     SELECT A.FIPAIS 
           ,A.FICANAL 
           ,A.FISUCURSAL 
           ,A.FIPEDIDO   -- Pedido de tienda
           ,A.FIFOLIOCENTRAL
           ,A.FISKU
           ,A.FICANTIDAD
           ,A.FIESTATUS
           ,TO_CHAR(A.FDACTUALIZACION,'DD/MM/YYYY HH24:MI:SS') AS FDACTUALIZACION
           ,C.FIEMPLEADO
           ,C.FITIPO  -- Tipo de Pedido
       FROM UNIFORMES.TADETALLEPEDIDOS A
      INNER JOIN UNIFORMES.TAPEDIDOS C
         ON A.FIFOLIOCENTRAL = C.FIFOLIOCENTRAL
      WHERE A.FIESTATUS = vlEstatus;
  
 RETURN curDatos;
  
END FNCONSULTAABASTO;
  
  
PROCEDURE SPACTPEDIDOABASTO(
   paPais      IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FIPAIS%TYPE
  ,paCanal     IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FICANAL%TYPE
  ,paSucursal  IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FISUCURSAL%TYPE
  ,paPedido    IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FIPEDIDO%TYPE
  ,paFolioCentral  IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FIFOLIOCENTRAL%TYPE
  ,paSKU       IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FISKU%TYPE
  ,paEstatusAnt  IN  UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE
  ,paActualizacion  IN VARCHAR2 )
IS
 /********************************************************************************
    Descripcion: actualiza pedido tienda 
    Parámetros de entrada:  No aplica
    Parámetros de salida: No aplica
    Parámetros de entrada-salida: Ninguno
    Valor de retorno: Cursor con resultado.
    Creador: 
    Fecha de creación: 10 JUNIO 2014
 **************************************************************************************/

   vlEstatus    UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE:= 40;  -- Enviado a abasto
     
BEGIN

       
   UNIFORMES.PAWSUNIFORMES.SPACTMOVTOPEDIDOS( paPais
                                             ,paCanal
                                             ,paSucursal
                                             ,paPedido
                                             ,paFolioCentral
                                             ,paSKU
                                             ,paEstatusAnt
                                             ,paActualizacion
                                             ,vlEstatus);    

END SPACTPEDIDOABASTO;
  

PROCEDURE SPCANCELAPEDIDOXBAJA(
   paPais      IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FIPAIS%TYPE
  ,paCanal     IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FICANAL%TYPE
  ,paSucursal  IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FISUCURSAL%TYPE
  ,paPedido    IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FIPEDIDO%TYPE
  ,paFolioCentral  IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FIFOLIOCENTRAL%TYPE
  ,paSKU       IN  UNIFORMES.TAMOVTODETALLEPEDIDOS.FISKU%TYPE
  ,paEstatusAnt  IN  UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE
  ,paActualizacion  IN VARCHAR2 )
IS
 /********************************************************************************
    Descripcion: actualiza pedido tienda 
    Parámetros de entrada:  No aplica
    Parámetros de salida: No aplica
    Parámetros de entrada-salida: Ninguno
    Valor de retorno: Cursor con resultado.
    Creador: 
    Fecha de creación: 10 JUNIO 2014
 **************************************************************************************/

     vlEstatus    UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE:= 500;  -- Cancelado por Baja de Empleado
     
BEGIN

       
   UNIFORMES.PAWSUNIFORMES.SPACTMOVTOPEDIDOS( paPais
                                             ,paCanal
                                             ,paSucursal
                                             ,paPedido
                                             ,paFolioCentral
                                             ,paSKU
                                             ,paEstatusAnt
                                             ,paActualizacion
                                             ,vlEstatus);    

END SPCANCELAPEDIDOXBAJA;


FUNCTION FNCONSULTAPEDIDOSRH
RETURN rcgCursor
IS
 /********************************************************************************
    Descripcion: Función consulta pedidos en cero 
    Parámetros de entrada:  No aplica
    Parámetros de salida: No aplica
    Parámetros de entrada-salida: Ninguno
    Valor de retorno: Cursor con resultado.
    Creador: R. Isaac Suarez Mercado
    Fecha de creación: 09 JUNIO 2014
 **************************************************************************************/
  
   curDatos         rcgCursor; 
   vlEstatus        UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE := 0;
  
BEGIN
  
   OPEN curDatos FOR
     SELECT A.FIPAIS 
           ,A.FICANAL 
           ,A.FISUCURSAL 
           ,A.FIFOLIOCENTRAL
           ,C.FIEMPLEADO
           ,A.FICANTIDAD
           ,A.FISKU
           ,A.FIESTATUS
           ,TO_CHAR(A.FDACTUALIZACION,'DD/MM/YYYY HH24:MI:SS')  AS FDACTUALIZACION
       FROM UNIFORMES.TADETALLEPEDIDOS A
      INNER JOIN UNIFORMES.TAPEDIDOS C
         ON (A.FIFOLIOCENTRAL = C.FIFOLIOCENTRAL)
      WHERE A.FIESTATUS = vlEstatus;
  
  RETURN curDatos;
  
END FNCONSULTAPEDIDOSRH;


FUNCTION FNCONSULTASPPI
RETURN PASRVCARGADATOS.rcgCursor
IS
/********************************************************************************
Proyecto:                           Uniformes
Descripcion:                        Paquete para  FNCONSULTASPPI
Parametros de entrada:              Todos los campos  FNCONSULTASPPI
Parametros de salida:               No aplica
Parametros de entrada-salida        No aplica
Precondiciones:                     Tener creado el esquema
Creador:                            
Fecha de creacion:                 
 ********************************************************************************/

      vlEstatusSAP   UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE:= 100;  -- estatus descto SAP
      vlEstatusEnt   UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE:= 90;   -- estatus Descargado ( entregado)
      vlCero         NUMBER(1) := 0;
      curDatosSPPI   UNIFORMES.PASRVCARGADATOS.rcgCursor; --Cursor que va a contener los datos de la consulta 
      
                                      
BEGIN 
  
   OPEN curDatosSPPI FOR
     SELECT SPPI.FCCLAVEUSUARIO AS CLAVEUSUARIO 
           ,SPPI.FCIDSISTEMASATELITAL AS IDSISTEMASATELITAL
           ,SPPI.FCCLAVECENTROPROVEEDOR AS CLAVECENTROPROVEEDOR
           ,SPPI.FCCLAVESERVICIO AS CLAVESERVICIO
           ,LPAD (SPPI.FCCLAVESOCIEDAD ,4 ,0) AS CLAVESOCIEDAD 
           ,DP.FIFOLIOCENTRAL
           ,DP.FIPEDIDO
           ,SPPI.FCDESCRIPCION AS DESCRIPCION
           ,SPPI.FCCONCEPTO AS CONCEPTO
           ,SPPI.FCMONEDA AS MONEDA  
           ,TO_CHAR(TRUNC(SYSDATE, 'MM'), 'dd/mm/yyyy') FECHA_INICIAL
           ,TO_CHAR(TRUNC(LAST_DAY(SYSDATE)), 'dd/mm/yyyy') FECHA_FINAL
           ,(DP.FNCOSTO - DP.FNDESCUENTO)  AS  IMPORTETOTAL
           ,SPPI.FCORDEN   AS ORDEN 
           ,E.FICECO   AS  CENCOSNUM
           ,DP.FIPAIS
           ,DP.FICANAL
           ,DP.FISUCURSAL
           ,DP.FISKU
           ,DP.FIESTATUS
           ,TO_CHAR(DP.FDACTUALIZACION,'DD/MM/YYYY HH24:MI:SS') AS FDACTUALIZACION     
       FROM UNIFORMES.TAEMPLEADOS E
 INNER JOIN UNIFORMES.TAPEDIDOS P
         ON (E.FIEMPLEADO = P.FIEMPLEADO)
 INNER JOIN UNIFORMES.TADETALLEPEDIDOS  DP
         ON (P.FIFOLIOCENTRAL = DP.FIFOLIOCENTRAL)
 INNER JOIN UNIFORMES.TAPARAMETROSSPPI SPPI
         ON (DP.FICANAL = SPPI.FICANAL)
      WHERE DP.FIESTATUS =  vlEstatusSAP
      UNION 
     SELECT SPPI.FCCLAVEUSUARIO AS CLAVEUSUARIO 
           ,SPPI.FCIDSISTEMASATELITAL AS IDSISTEMASATELITAL
           ,SPPI.FCCLAVECENTROPROVEEDOR AS CLAVECENTROPROVEEDOR
           ,SPPI.FCCLAVESERVICIO AS CLAVESERVICIO
           ,LPAD (SPPI.FCCLAVESOCIEDAD ,4 ,0) AS CLAVESOCIEDAD 
           ,DP.FIFOLIOCENTRAL
           ,DP.FIPEDIDO
           ,SPPI.FCDESCRIPCION AS DESCRIPCION
           ,SPPI.FCCONCEPTO AS CONCEPTO
           ,SPPI.FCMONEDA AS MONEDA  
           ,TO_CHAR(TRUNC(SYSDATE, 'MM'), 'dd/mm/yyyy') FECHA_INICIAL
           ,TO_CHAR(TRUNC(LAST_DAY(SYSDATE)), 'dd/mm/yyyy') FECHA_FINAL
           ,(DP.FNCOSTO - DP.FNDESCUENTO)  AS  IMPORTETOTAL
           ,SPPI.FCORDEN   AS ORDEN 
           ,E.FICECO   AS  CENCOSNUM
           ,DP.FIPAIS
           ,DP.FICANAL
           ,DP.FISUCURSAL
           ,DP.FISKU
           ,DP.FIESTATUS
           ,TO_CHAR(DP.FDACTUALIZACION,'DD/MM/YYYY HH24:MI:SS') AS FDACTUALIZACION     
       FROM UNIFORMES.TAEMPLEADOS E
 INNER JOIN UNIFORMES.TAPEDIDOS P
         ON (E.FIEMPLEADO = P.FIEMPLEADO)
 INNER JOIN UNIFORMES.TADETALLEPEDIDOS  DP
         ON (P.FIFOLIOCENTRAL = DP.FIFOLIOCENTRAL)
 INNER JOIN UNIFORMES.TAPARAMETROSSPPI SPPI
         ON (DP.FICANAL = SPPI.FICANAL)
      WHERE DP.FIESTATUS = vlEstatusEnt
        AND DP.FNDESCUENTO = vlCero;
  
   RETURN curDatosSPPI;
   
END FNCONSULTASPPI;



PROCEDURE SPINSCONFIRMACIONSPPI(
   paPais         IN  UNIFORMES.TADETALLEPEDIDOS.FIPAIS%TYPE
  ,paCanal        IN  UNIFORMES.TADETALLEPEDIDOS.FICANAL%TYPE
  ,paSucursal     IN  UNIFORMES.TADETALLEPEDIDOS.FISUCURSAL%TYPE
  ,paSKU          IN  UNIFORMES.TADETALLEPEDIDOS.FISKU%TYPE
  ,paEstatusAnt    IN UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE         -- Estatus del Pedido
  ,paActualizacion IN  VARCHAR2  
  ,paPedido        IN  UNIFORMES.TADESCUENTOSSPPI.FIPEDIDO%TYPE
  ,paFolioCentral  IN  UNIFORMES.TADESCUENTOSSPPI.FIFOLIOCENTRAL%TYPE
  ,paEstatus       IN  UNIFORMES.TADESCUENTOSSPPI.FIESTATUS%TYPE   -- Respuesta SPPI
  ,paPeticion      IN  UNIFORMES.TADESCUENTOSSPPI.FCPETICION%TYPE
  ,paRespuesta     IN  UNIFORMES.TADESCUENTOSSPPI.FCRESPUESTA%TYPE
  ,paFolioSPPI     IN  UNIFORMES.TADESCUENTOSSPPI.FIFOLIOSPPI%TYPE )
IS
/********************************************************************************
Proyecto:                           Uniformes
Descripcion:                        Paquete para respuesta de SPPI
Parametros de entrada:              Todos los campos que expone Sppi
Parametros de salida:               No aplica
Parametros de entrada-salida        No aplica
Precondiciones:                     Tener creado el esquema
Creador:                            
Fecha de creacion:                 
 ********************************************************************************/
  
   vlRespSppiOk     UNIFORMES.TADESCUENTOSSPPI.FIESTATUS%TYPE:= 1;
   vlFechaActual    UNIFORMES.TADETALLEPEDIDOS.FDACTUALIZACION%TYPE:=SYSDATE;
   vlEstatusSPPI    UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE:= 110;  -- estatus descto SPPI
   vlConsec         UNIFORMES.TADESCUENTOSSPPI.FICONSECUTIVO%TYPE:=0; -- consecutivo  
   
BEGIN
    
  
  SELECT COUNT(ROWID)+1
         INTO vlConsec
         FROM UNIFORMES.TADESCUENTOSSPPI
        WHERE FIFOLIOCENTRAL = paFolioCentral
          AND FIPAIS = paPais
          AND FICANAL = paCanal
          AND FISUCURSAL = paSucursal
          AND FIPEDIDO = paPedido
          AND FISKU = paSKU;
     
   INSERT INTO UNIFORMES.TADESCUENTOSSPPI( FIFOLIOCENTRAL
                                          ,FIPAIS
                                          ,FICANAL
                                          ,FISUCURSAL
                                          ,FIPEDIDO
                                          ,FISKU
                                          ,FICONSECUTIVO
                                          ,FIESTATUS
                                          ,FCPETICION
                                          ,FCRESPUESTA
                                          ,FIFOLIOSPPI
                                          ,FIPORCENTAJEAVANCE
                                          ,FCDETALLEERROR)
                                   VALUES( paFolioCentral
                                          ,paPais 
                                          ,paCanal 
                                          ,paSucursal 
                                          ,paPedido 
                                          ,paSKU  
                                          ,vlConsec
                                          ,paEstatus
                                          ,paPeticion
                                          ,paRespuesta
                                          ,paFolioSPPI
                                          ,0
                                          ,'-');

   IF( paEstatus = vlRespSppiOk ) THEN
          
      UNIFORMES.PAWSUNIFORMES.SPACTMOVTOPEDIDOS( paPais
                                                ,paCanal
                                                ,paSucursal
                                                ,paPedido
                                                ,paFolioCentral
                                                ,paSKU
                                                ,paEstatusAnt
                                                ,paActualizacion
                                                ,vlEstatusSPPI);
                                                
   END IF;
        
                                                                                 
END SPINSCONFIRMACIONSPPI;

   
FUNCTION FNOBTIENEDESCEMPSAP
RETURN PASRVOPERAUNIFORMES.rcgCursor
IS
/********************************************************************************
Proyecto:      Uniformes
Descripcion:       Extrae informacion de los pedidos de los empleados para aplicar descuentos SAP
Parametros de entrada:    No aplica
Parametros de salida:   CURSOR
Parametros de entrada-salida    No aplica
Precondiciones:   Tener creado el esquema
Creador:                  aor
Fecha de creacion:         08-07-2014
 ********************************************************************************/
   
   vlEstatus    UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE := 90;    -- Entregado
   vlCero       NUMBER(1) := 0;
   curDatosEmp  UNIFORMES.PASRVOPERAUNIFORMES.rcgCursor; 
   
       
BEGIN 

   OPEN curDatosEmp FOR
    SELECT LPAD(E.FIEMPLEADO, 8, 0) AS ID_EMPLEADO_SAP
           ,TO_CHAR( NEXT_DAY(SYSDATE, TO_CHAR(TO_DATE('05-06-2006', 'dd-mm-yyyy'), 'Day')), 'yyyymmdd' ) AS FECHA_DESCUENTO
           ,B.FIPEDIDO
           ,B.FNDESCUENTO AS TOTAL_PAGAR
           ,ROUND(B.FNDESCUENTO/8, 2) DESCTO_SEMANAL
           ,A.FIFOLIOCENTRAL
           ,B.FIPAIS
           ,B.FICANAL 
           ,B.FISUCURSAL 
           ,B.FISKU
           ,B.FIESTATUS 
           ,TO_CHAR(B.FDACTUALIZACION,'DD/MM/YYYY HH24:MI:SS')  AS FDACTUALIZACION  
      FROM UNIFORMES.TAPEDIDOS A
     INNER JOIN UNIFORMES.TAEMPLEADOS E  
        ON (E.FIEMPLEADO = A.FIEMPLEADO)
     INNER JOIN UNIFORMES.TADETALLEPEDIDOS  B
        ON (A.FIFOLIOCENTRAL = B.FIFOLIOCENTRAL)
     WHERE B.FIESTATUS = vlEstatus
       AND B.FNDESCUENTO <> vlCero
     ORDER BY E.FIEMPLEADO;
    
  RETURN curDatosEmp;
   
END FNOBTIENEDESCEMPSAP;


--SAP --
PROCEDURE SPINSERTACONFIRMACIONWSSAP( 
   paFolioCentral  IN  UNIFORMES.TADESCUENTOSXPEDIDOS.FIFOLIOCENTRAL%TYPE
  ,paPais         IN  UNIFORMES.TADESCUENTOSXPEDIDOS.FIPAIS%TYPE
  ,paCanal        IN  UNIFORMES.TADESCUENTOSXPEDIDOS.FICANAL%TYPE
  ,paSucursal     IN  UNIFORMES.TADESCUENTOSXPEDIDOS.FISUCURSAL%TYPE
  ,paPedido        IN  UNIFORMES.TADESCUENTOSXPEDIDOS.FIPEDIDO%TYPE
  ,paSKU          IN  UNIFORMES.TADESCUENTOSXPEDIDOS.FISKU%TYPE
  ,paReferencia     IN UNIFORMES.TADESCUENTOSXPEDIDOS.FCREFERENCIA%TYPE
  ,paEstatusPedidoAnt    IN UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE
  ,paActualizacion IN VARCHAR2 
  ,paEstatus       IN  UNIFORMES.TADESCUENTOSXPEDIDOS.FIESTATUS%TYPE  -- wsSapResp 
  ,paPeticion      IN  UNIFORMES.TADESCUENTOSXPEDIDOS.FCPETICION%TYPE
  ,paRespuesta     IN  UNIFORMES.TADESCUENTOSXPEDIDOS.FCRESPUESTA%TYPE )
IS
/********************************************************************************
Proyecto:                           Uniformes
Descripcion:                        Aplica actualizaciones  de descuentos SAP
Parametros de entrada:             No aplica
Parametros de salida:               No aplica
Parametros de entrada-salida        No aplica
Precondiciones:                     Tener creado el esquema
Creador:                        
Fecha de creacion:             08-07-2014
 ********************************************************************************/
     
  vlFechaActual     UNIFORMES.TADETALLEPEDIDOS.FDACTUALIZACION%TYPE:= SYSDATE;
  vlEstDesctoSap    UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE:= 100; --Descuento SAP   
  vlRespSapOk       UNIFORMES.TADESCUENTOSXPEDIDOS.FIESTATUS%TYPE:= 1;
  vlConsec          UNIFORMES.TADESCUENTOSXPEDIDOS.FICONSECUTIVO%TYPE:=0; -- consecutivo
BEGIN
  
 SELECT COUNT(FICONSECUTIVO)+1
         INTO vlConsec
         FROM UNIFORMES.TADESCUENTOSXPEDIDOS
        WHERE FIFOLIOCENTRAL = paFolioCentral
          AND FIPAIS = paPais
          AND FICANAL = paCanal
          AND FISUCURSAL = paSucursal
          AND FIPEDIDO = paPedido
          AND FISKU = paSKU
          AND FCREFERENCIA = paReferencia;
          
   INSERT INTO UNIFORMES.TADESCUENTOSXPEDIDOS(FIFOLIOCENTRAL
                                             ,FIPAIS
                                             ,FICANAL
                                             ,FISUCURSAL
                                             ,FIPEDIDO
                                             ,FISKU
                                             ,FCREFERENCIA
                                             ,FICONSECUTIVO
                                             ,FIESTATUS
                                             ,FCPETICION
                                             ,FCRESPUESTA)
                                       VALUES(paFolioCentral
                                             ,paPais
                                             ,paCanal
                                             ,paSucursal
                                             ,paPedido
                                             ,paSKU
                                             ,paReferencia   -- 'FOLIO_CENTRAL - PEDIDO - 1'
                                             ,vlConsec          
                                             ,paEstatus    -- Respuesta SAP
                                             ,paPeticion
                                             ,paRespuesta);   
                                          
   IF( paEstatus = vlRespSapOk ) THEN
   
      UNIFORMES.PAWSUNIFORMES.SPACTMOVTOPEDIDOS( paPais
                                                ,paCanal
                                                ,paSucursal
                                                ,paPedido
                                                ,paFolioCentral
                                                ,paSKU
                                                ,paEstatusPedidoAnt
                                                ,paActualizacion
                                                ,vlEstDesctoSap);

   END IF;

END SPINSERTACONFIRMACIONWSSAP;

 PROCEDURE SPDETALLECARGASPPI(paIdPais            IN UNIFORMES.TADESCUENTOSSPPI.FIPAIS%TYPE,
                               paIdCanal           IN UNIFORMES.TADESCUENTOSSPPI.FICANAL%TYPE,
                               paSucursal          IN UNIFORMES.TADESCUENTOSSPPI.FISUCURSAL%TYPE,
                               paPedido            IN UNIFORMES.TADESCUENTOSSPPI.FIPEDIDO%TYPE,
                               paFolioCentral      IN UNIFORMES.TADESCUENTOSSPPI.FIFOLIOCENTRAL%TYPE,
                               paSKU               IN UNIFORMES.TADESCUENTOSSPPI.FISKU%TYPE,
                               paFolioSPPI         IN UNIFORMES.TADESCUENTOSSPPI.FIFOLIOSPPI%TYPE,
                               paDetalleError      IN UNIFORMES.TADESCUENTOSSPPI.FCDETALLEERROR%TYPE,
                               paEstatusAnterior   IN UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE,
                               paFechActualizacion IN VARCHAR2) IS
    /*************************************************************
       Proyecto:                       Uniformes 
       Descripcion:                    Controla el detalle de carga para SPPI
       Parametros de entrada:          Todos los campos que se exponen
       Parametros de salida:           No aplica
       Parametros de entrada-salida    No aplica
       Precondiciones:                 Tener creado el esquema
       Creador:                        Antonio Olvera Reyna
       Fecha de creacion:              28 AGOSTO 2014
    ****************************************************************/
    vlCuatro              NUMBER(1) := 4;
    vlCinco               NUMBER(1) := 5;
    vlConsec UNIFORMES.TADESCUENTOSSPPI.FICONSECUTIVO%TYPE:=0; -- consecutivo  
    vlEstatusMensajeError NUMBER(3) := 0;   -- Estatus a actualizar.
    vlEstatusError        NUMBER(3) := 520; -- Con mensaje de error para SPPI.    
    vlEstatusReintento    NUMBER(3) := 100; -- En error el estatus regresa a 100 
                                            -- para enviar nuevamete, y generar folioSPPI. 
    
  BEGIN
  
    SELECT COUNT(ROWID)
      INTO vlConsec
      FROM UNIFORMES.TADESCUENTOSSPPI
     WHERE FIFOLIOCENTRAL = paFolioCentral
       AND FIPAIS = paIdPais
       AND FICANAL = paIdCanal
       AND FISUCURSAL = paSucursal
       AND FIPEDIDO = paPedido
       AND FISKU = paSKU;
       
    IF(vlConsec < vlCinco)
    THEN 
       IF(vlConsec = vlCuatro)
       THEN 
          vlEstatusMensajeError := vlEstatusError;
       ELSE
          vlEstatusMensajeError := vlEstatusReintento;
       END IF;
       
       UPDATE UNIFORMES.TADESCUENTOSSPPI
          SET FCDETALLEERROR = paDetalleError
        WHERE FIFOLIOCENTRAL = paFolioCentral
          AND FIPAIS = paIdPais
          AND FICANAL = paIdCanal
          AND FISUCURSAL = paSucursal
          AND FIPEDIDO = paPedido
          AND FISKU = paSKU
          AND FIFOLIOSPPI = paFolioSPPI;
     
       UNIFORMES.PAWSUNIFORMES.SPACTMOVTOPEDIDOS(paIdPais,
                                                 paIdCanal,
                                                 paSucursal,
                                                 paPedido,
                                                 paFolioCentral,
                                                 paSKU,
                                                 paEstatusAnterior,
                                                 paFechActualizacion,
                                                 vlEstatusMensajeError);
    END IF;  

        
  END SPDETALLECARGASPPI;


  PROCEDURE SPACTAVANCECARGASPPI(paIdPais            IN UNIFORMES.TADETALLEPEDIDOS.FIPAIS%TYPE,
                                 paIdCanal           IN UNIFORMES.TADETALLEPEDIDOS.FICANAL%TYPE,
                                 paSucursal          IN UNIFORMES.TADETALLEPEDIDOS.FISUCURSAL%TYPE,
                                 paPedido            IN UNIFORMES.TADETALLEPEDIDOS.FIPEDIDO%TYPE,
                                 paFolioCentral      IN UNIFORMES.TADETALLEPEDIDOS.FIFOLIOCENTRAL%TYPE,
                                 paSKU               IN UNIFORMES.TADETALLEPEDIDOS.FISKU%TYPE,
                                 paEstatusAnterior   IN UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE,
                                 paFechActualizacion IN VARCHAR2,
                                 paPorcentajeAvance  IN UNIFORMES.TADESCUENTOSSPPI.FIPORCENTAJEAVANCE%TYPE,
                                 paFolioSPPI         IN UNIFORMES.TADESCUENTOSSPPI.FIFOLIOSPPI%TYPE,
                                 paStatusServicio    IN NUMBER,
                                 paPeticion          IN CLOB,
                                 paRespuesta         IN CLOB) IS
    /*************************************************************
       Proyecto:                       Uniformes 
       Descripcion:                    Controla el avance de carga para SPPI
       Parametros de entrada:          Todos los campos que se exponen
       Parametros de salida:           No aplica
       Parametros de entrada-salida    No aplica
       Precondiciones:                 Tener creado el esquema
       Creador:                     Antonio Olvera Reyna
       Fecha de creacion:             28 AGOSTO 2014
    ****************************************************************/
    vlEstatusAvanceCarga   NUMBER(3) := 120; --Cuando ya trae el 100%
    vlEstatusError         NUMBER(3) := 510; --Si hay un error en el servicio
    vlServicioERR          NUMBER(2) := 0;
    vlPorcentajeCompletado NUMBER(3) := 100;
  
  BEGIN
  
    IF paStatusServicio = vlServicioERR THEN
      vlEstatusAvanceCarga := vlEstatusError;
    
    END IF;
  
    UPDATE UNIFORMES.TADESCUENTOSSPPI
       SET FIPORCENTAJEAVANCE = paPorcentajeAvance
     WHERE FIFOLIOCENTRAL = paFolioCentral
       AND FIPAIS = paIdPais
       AND FICANAL = paIdCanal
       AND FISUCURSAL = paSucursal
       AND FIPEDIDO = paPedido
       AND FISKU = paSKU
       AND FIFOLIOSPPI = paFolioSPPI;
  
    IF ((vlEstatusAvanceCarga = vlEstatusError) OR
       (paPorcentajeAvance = vlPorcentajeCompletado)) THEN
    
      UPDATE UNIFORMES.TADESCUENTOSSPPI
         SET FCPETICION  = paPeticion,
             FCRESPUESTA = paRespuesta,
             FIESTATUS = (CASE
                           WHEN vlEstatusAvanceCarga IN (vlEstatusError) THEN
                            0
                           ELSE
                            FIESTATUS
                         END)
       WHERE FIFOLIOCENTRAL = paFolioCentral
         AND FIPAIS = paIdPais
         AND FICANAL = paIdCanal
         AND FISUCURSAL = paSucursal
         AND FIPEDIDO = paPedido
         AND FISKU = paSKU
         AND FIFOLIOSPPI = paFolioSPPI;
    
      UNIFORMES.PAWSUNIFORMES.SPACTMOVTOPEDIDOS(paIdPais,
                                                paIdCanal,
                                                paSucursal,
                                                paPedido,
                                                paFolioCentral,
                                                paSKU,
                                                paEstatusAnterior,
                                                paFechActualizacion,
                                                vlEstatusAvanceCarga);
    END IF;
  
  END;

  FUNCTION FNCONSPARAMETROSSPPI(paEstatusDescuento UNIFORMES.TADESCUENTOSSPPI.FIESTATUS%TYPE,
                                paEstatusPedido    UNIFORMES.TADETALLEPEDIDOS.FIESTATUS%TYPE)
    RETURN rcgCursor IS
    /*************************************************************
       Proyecto:                       Uniformes 
       Descripcion:                    Devuelve  parametros de entrada SPPI para emplear con servicios
       Parametros de entrada:          paDescuentoEnviado: Estado del descuento 1 valido, 0 invalido
                                                   paEstatusAplicaPedido: Estatus en que deben estar los pedidos para extraer
       Parametros de salida:           No aplica
       Parametros de entrada-salida    No aplica
       Precondiciones:                 Tener creado el esquema
       Creador:                     Antonio Olvera Reyna
       Fecha de creacion:             28 AGOSTO 2014
    ****************************************************************/
    curDatos rcgCursor;
  
  BEGIN
  
    OPEN curDatos FOR
      SELECT DESCSPPI.FIFOLIOCENTRAL,
             DESCSPPI.FIPAIS,
             DESCSPPI.FICANAL,
             DESCSPPI.FISUCURSAL,
             DESCSPPI.FIPEDIDO,
             DESCSPPI.FISKU,
             DETPED.FIESTATUS,
             TO_CHAR(DETPED.FDACTUALIZACION, 'DD/MM/YYYY HH24:MI:SS') FDACTUALIZACION,
             PARSPPI.FCCLAVEUSUARIO,
             PARSPPI.FCIDSISTEMASATELITAL,
             DESCSPPI.FIFOLIOSPPI
        FROM UNIFORMES.TADESCUENTOSSPPI DESCSPPI
       INNER JOIN UNIFORMES.TADETALLEPEDIDOS DETPED
          ON (DESCSPPI.FIFOLIOCENTRAL = DETPED.FIFOLIOCENTRAL AND
             DESCSPPI.FIPAIS = DETPED.FIPAIS AND
             DESCSPPI.FISUCURSAL = DETPED.FISUCURSAL AND
             DESCSPPI.FICANAL = DETPED.FICANAL AND
             DESCSPPI.FIPEDIDO = DETPED.FIPEDIDO AND
             DESCSPPI.FISKU = DETPED.FISKU)
       INNER JOIN UNIFORMES.TAPARAMETROSSPPI PARSPPI
          ON (DESCSPPI.FICANAL = PARSPPI.FICANAL)
         AND DESCSPPI.FIESTATUS = paEstatusDescuento
         AND DETPED.FIESTATUS = paEstatusPedido;
  
    RETURN curDatos;
  
  END FNCONSPARAMETROSSPPI;
  
  
  PROCEDURE SPINSDESCTOSAP(paFolioCentral  IN UNIFORMES.TADESCUENTOSSAP.FIFOLIOCENTRAL%TYPE,
                           paPedido        IN UNIFORMES.TADESCUENTOSSAP.FIPEDIDO%TYPE,
                           paReferencia    IN UNIFORMES.TADESCUENTOSSAP.FCREFERENCIA%TYPE,
                           paSociedad      IN UNIFORMES.TADESCUENTOSSAP.FCSOCIEDAD%TYPE,
                           paCcnomina      IN UNIFORMES.TADESCUENTOSSAP.FCCCNOMINA%TYPE,
                           paTotdescuento  IN UNIFORMES.TADESCUENTOSSAP.FNTOTDESCUENTO%TYPE,
                           paFechaPago     IN VARCHAR2,
                           paSemaDescuento IN UNIFORMES.TADESCUENTOSSAP.FISEMADESCUENTO%TYPE,
                           paSaldo         IN UNIFORMES.TADESCUENTOSSAP.FNSALDO%TYPE,
                           paPago          IN UNIFORMES.TADESCUENTOSSAP.FNPAGO%TYPE) IS
    /********************************************************************************
       Descripcion:  Actualiza la información obtenida de la Base de Datos de SAP,
                     de los descuentos a empleados
       Parámetros de entrada:  paFolioCentral - Folio Central
                               paPedido - Numero de Pedido
                               paReferencia - Referencia
                               paSociedad - Sociedad
                               paCcnomina - Centro de Costos
                               paTotdescuento - Total a Descontar
                               paFechaPago - Fecha de Pago
                               paSemaDescuento - Semana de Descuento
                               paSaldo - Saldo
       Parámetros de entrada-salida: Ninguno
       Valor de retorno: Ninguno.
       Creador:  Carolina Pérez Vite
       Fecha de creación: 1 Octubre 2014
    **************************************************************************************/
  BEGIN
  
     MERGE INTO UNIFORMES.TADESCUENTOSSAP DATOS
         USING (SELECT paFolioCentral FOLIOCENTRAL,
                       paPedido PEDIDO,
                       paSociedad SOCIEDAD,
                       TO_DATE(paFechaPago, 'DD/MM/YYYY') FPAGO
                  FROM DUAL) VALORES
            ON (DATOS.FIFOLIOCENTRAL = VALORES.FOLIOCENTRAL AND
                DATOS.FIPEDIDO       = VALORES.PEDIDO       AND
                DATOS.FCSOCIEDAD     = VALORES.SOCIEDAD     AND
                DATOS.FDPAGO         = VALORES.FPAGO)
      WHEN MATCHED THEN
         UPDATE 
            SET FCREFERENCIA    = paReferencia,
                FCCCNOMINA      = paCcnomina,
                FNTOTDESCUENTO  = paTotdescuento,
                FISEMADESCUENTO = paSemaDescuento,
                FNSALDO         = paSaldo,
                FNPAGO          = paPago
      WHEN NOT MATCHED THEN
         INSERT (FIFOLIOCENTRAL,
                 FIPEDIDO,
                 FCREFERENCIA,
                 FCSOCIEDAD,
                 FCCCNOMINA,
                 FNTOTDESCUENTO,
                 FDPAGO,
                 FISEMADESCUENTO,
                 FNSALDO,
                 FNPAGO)
         VALUES (paFolioCentral,
                 paPedido,
                 paReferencia,
                 paSociedad,
                 paCcnomina,
                 paTotdescuento,
                 TO_DATE(paFechaPago, 'DD/MM/YYYY'),
                 paSemaDescuento,
                 paSaldo,
                 paPago);
                 
  END SPINSDESCTOSAP;
  

END PASRVOPERAUNIFORMES;
/

SHOW ERRORS;


CREATE OR REPLACE PACKAGE BODY           PASRVCARGADATOS
AS
   /*************************************************************
   Proyecto:                           Uniformes
   Descripcion:                         Paquete para obtener registros de SAP
   Parametros de entrada:               No aplica
   Parametros de salida:                  No aplica
   Parametros de entrada-salida          No aplica
   Precondiciones:                       Tener creado el esquema
   Creador:                            Laura Garcia
   Fecha de creacion:                 13 JUNIO 2014
   *************************************************************/
 

PROCEDURE SPINSEMPLEADOS (
    paEmpleadoNum           IN      UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE
   ,paEmpleadoNombre        IN      UNIFORMES.TAEMPLEADOS.FCNOMBRE%TYPE
   ,paGenero                IN      UNIFORMES.TAEMPLEADOS.FCGENERO%TYPE
   ,paPosicion              IN      UNIFORMES.TAEMPLEADOS.FIPOSICION%TYPE
   ,paPosicionDesc          IN      UNIFORMES.TAEMPLEADOS.FCPOSICION%TYPE
   ,paSituacion             IN      UNIFORMES.TAEMPLEADOS.FCSITUACION%TYPE
   ,paFuncion               IN      UNIFORMES.TAEMPLEADOS.FIFUNCION%TYPE
   ,paCeco                  IN      UNIFORMES.TAEMPLEADOS.FICECO%TYPE 
   ,paCecoDesc              IN      UNIFORMES.TAEMPLEADOS.FCCECO%TYPE
   ,paPais                  IN      UNIFORMES.TAEMPLEADOS.FCPAIS%TYPE
   ,paFecIngreso            IN      VARCHAR2
   ,paFecBaja               IN      VARCHAR2
   ,paFecAnterior           IN      VARCHAR2
   ,paFecMovimiento         IN      VARCHAR2
   )
IS
/********************************************************************************
Proyecto:                           Uniformes
Descripcion:                        Paquete para obtener registros de SAP
Parametros de entrada:              Todos los campos que expone SAP
Parametros de salida:               No aplica
Parametros de entrada-salida        No aplica
Precondiciones:                     Tener creado el esquema
Creador:                            
Fecha de creacion:                 
 ********************************************************************************/

   vlNumEmpleado         UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE := 0;

BEGIN
                               --- TABLA DE REFERENCIA   RHEKT.RH_EMP_SAP_FBP
     vlNumEmpleado := trim(paEmpleadoNum);

      MERGE INTO UNIFORMES.TAEMPLEADOS DATOS
         USING (SELECT vlNumEmpleado NUMEMP
                       FROM DUAL) VALORES
            ON (DATOS.FIEMPLEADO = VALORES.NUMEMP)
      WHEN MATCHED THEN
         UPDATE 
            SET FCNOMBRE = paEmpleadoNombre
              , FCGENERO = paGenero
              , FIPOSICION = paPosicion
              , FCPOSICION = paPosicionDesc
              , FCSITUACION = paSituacion
              , FIFUNCION = paFuncion
              , FICECO = paCeco
              , FCCECO = paCecoDesc
              , FCPAIS = paPais                 
              , FDINGRESO =  TO_DATE(paFecIngreso,'YYYYMMDD')
              , FDBAJA = TO_DATE(paFecBaja,'YYYYMMDD')
              , FDANTERIOR = TO_DATE(paFecAnterior,'YYYYMMDD')
              , FDMOVIMIENTO = TO_DATE(paFecMovimiento,'YYYYMMDD')
      WHEN NOT MATCHED THEN
         INSERT (FIEMPLEADO
               , FCNOMBRE
               , FCGENERO
               , FIPOSICION
               , FCPOSICION
               , FCSITUACION
               , FIFUNCION
               , FICECO
               , FCCECO
               , FCPAIS
               , FDINGRESO
               , FDBAJA
               , FDANTERIOR
               , FDMOVIMIENTO)
        VALUES ( paEmpleadoNum
               , paEmpleadoNombre
               , paGenero
               , paPosicion
               , paPosicionDesc
               , paSituacion
               , paFuncion
               , paCeco
               , paCecoDesc
               , paPais
               , TO_DATE(paFecIngreso,'YYYYMMDD')
               , TO_DATE(paFecBaja,'YYYYMMDD')
               , TO_DATE(paFecAnterior,'YYYYMMDD')
               , TO_DATE(paFecMovimiento,'YYYYMMDD'));
  
   
END SPINSEMPLEADOS;


PROCEDURE SPINSERTACECO
   (paCC      IN     UNIFORMES.TACECO.FICC%TYPE
   ,paN1      IN     UNIFORMES.TACECO.FCN1%TYPE
   ,paN2      IN     UNIFORMES.TACECO.FCN2%TYPE
   ,paN3      IN     UNIFORMES.TACECO.FCN3%TYPE
   ,paN4      IN     UNIFORMES.TACECO.FCN4%TYPE
   ,paN5      IN     UNIFORMES.TACECO.FCN5%TYPE
   ,paN6      IN     UNIFORMES.TACECO.FCN6%TYPE
   ,paN7      IN     UNIFORMES.TACECO.FCN7%TYPE
   ,paN8      IN     UNIFORMES.TACECO.FCN8%TYPE
   ,paN9      IN     UNIFORMES.TACECO.FCN9%TYPE
   ,paN10     IN     UNIFORMES.TACECO.FCN10%TYPE
   ,paN11     IN     UNIFORMES.TACECO.FCN11%TYPE
   ,paN12     IN     UNIFORMES.TACECO.FCN12%TYPE
   ,paN13     IN     UNIFORMES.TACECO.FCN13%TYPE
   ,paNumeco       IN     UNIFORMES.TACECO.FINUMECO%TYPE
   ,paNombre       IN     UNIFORMES.TACECO.FCNOMBRE%TYPE
   ,paIdCCPadre    IN     UNIFORMES.TACECO.FCIDCCPADRE%TYPE
   ,paNombrePadre  IN     UNIFORMES.TACECO.FCNOMBREPADRE%TYPE
   ,paIdentidad    IN     UNIFORMES.TACECO.FIIDENTIDAD%TYPE
   ,paNombreEntidad  IN     UNIFORMES.TACECO.FCNOMBREENTIDAD%TYPE
   ,paIdCanal        IN     UNIFORMES.TACECO.FCIDCANAL%TYPE
   ,paCanal          IN     UNIFORMES.TACECO.FCCANAL%TYPE
   ,paColor          IN     UNIFORMES.TACECO.FCCOLOR%TYPE
   ,paTipoCanal      IN     UNIFORMES.TACECO.FCTIPOCANAL%TYPE
   ,paIdTipoOp       IN     UNIFORMES.TACECO.FIIDTIPOOP%TYPE
   ,paTipoCentro     IN     UNIFORMES.TACECO.FCTIPOCENTRO%TYPE
   ,paNivel          IN     UNIFORMES.TACECO.FINIVEL%TYPE
   ,paEstatus         IN     UNIFORMES.TACECO.FIESTATUS%TYPE
   ,paEstatusDesc     IN     UNIFORMES.TACECO.FCESTATUSDESC%TYPE
   ,paIdPais         IN     UNIFORMES.TACECO.FIPAIS%TYPE
   ,paPais           IN     UNIFORMES.TACECO.FCPAIS%TYPE
   ,paIdResp         IN     UNIFORMES.TACECO.FIIDRESP%TYPE
   ,paNombreResp     IN     UNIFORMES.TACECO.FCNOMBRERESP%TYPE
   ,paIdGuncorp      IN     UNIFORMES.TACECO.FIIDGUNCORP%TYPE
   ,paGuncorp        IN     UNIFORMES.TACECO.FCGUNCORP%TYPE
   ,paIdDireccionRH  IN     UNIFORMES.TACECO.FIIDDIRECCIONRH%TYPE
   ,paDireccionRH    IN     UNIFORMES.TACECO.FCDIRECCIONRH%TYPE
   ,paIdAreaRH       IN     UNIFORMES.TACECO.FIIDAREARH%TYPE
   ,paAreaRH         IN     UNIFORMES.TACECO.FCAREARH%TYPE
   ,paTipoSucursal   IN     UNIFORMES.TACECO.FCTIPOSUCURSAL%TYPE
   ,paNomTipoSucursal  IN     UNIFORMES.TACECO.FCNOMTIPOSUCURSAL%TYPE) 
IS
/******************************************************************************
Proyecto:    Actualización de información Central
Descripcion: Actualiza la información de la tabla UNIFORMES.TACECO a
             partir de la infromación Operativa de la base de datos de CECO.
Parametros de entrada:  paCC --> Centro de costos
                        paN1 --> Centro de costos de nivel 1
                        paN2 --> Centro de costos de nivel 2
                        paN3 --> Centro de costos de nivel 3
                        paN4 --> Centro de costos de nivel 4
                        paN5 --> Centro de costos de nivel 5
                        paN6 --> Centro de costos de nivel 6
                        paN7 --> Centro de costos de nivel 7
                        paN8 --> Centro de costos de nivel 8
                        paN9 --> Centro de costos de nivel 9
                        paN10 --> Centro de costos de nivel 10
                        paN11 --> Centro de costos de nivel 11
                        paN12 --> Centro de costos de nivel 12
                        paN13 --> Centro de costos de nivel 13
                        paNUMECO --> Número de tienda
                        paNOMBRE --> Nombre del centro de costos
                        paIDCCPADRE --> Centro de costos padre
                        paNOMBREPADRE --> Nombre del centro de costos padre
                        paIDENTIDAD --> Entidad del centro de costos
                        paNOMBREENTIDAD --> Nombre de la entidad del centro de costos
                        paIDCANAL --> Id del canal del centro de costos
                        paCANAL --> Nombre del canal del centro de costos
                        paCOLOR --> Color contable del centro de costos
                        paTIPOCANAL --> Tipo de canal del centro de costos
                        paIDTIPOOP --> Id del tipo de operación del centro de costos
                        paTIPOCENTRO --> Tipo de centro de costos
                        paNIVEL --> Nivel del centro de costos en la estructura
                        paSTATUS --> Id Status del centro de costos
                        paSTATUS_DESC --> Descripción del status del centro de costos
                        paIPAIS --> Id del país del centro de costos
                        paPAIS --> Nombre del país del centro de costos
                        paIDLOCALIDAD --> Id Localidad del centro de costos
                        paNOMBRE_LOCALIDAD --> Nombre de la localidad del centro de costos
                        paIDESTADO --> Id Estado del centro de costos
                        paNOMBRE_ESTADO --> Nombre del estado del centro de costos
                        paIDMUNICIPIO --> Id Municipio del centro de costos
                        paNOMBRE_MUNICIPIO --> Nombre del municipìo del centro de costos
                        paIDRESP --> Id Responsable del centro de costos
                        paNOMBRERESP --> Nombre del responsable del centro de costos
                        paIDGUNCORP --> Id Gun Corp
                        paGUN_CORP -->  Nombre Gun Corp
                        paIDDIRECCIONRH --> Id dirección de Recursos Humanos
                        paDIRECCIONRH --> Nombre dirección de Recursos Humanos
                        paIDAREARH --> Id Area de Recursos Humanos
                        paAREARH --> Nombre del Area de Recursos Humanos
                        paTIPOSUCURSAL --> Tipo de sucurusal
                        paNOMTIPOSUCURSAL --> Nombre del tipo de sucursal
Parametros de salida:         No aplica
Parametros de entrada-salida: No aplica
Precondiciones:    Ninguna
Creador:           
Fecha de creacion: 
******************************************************************************/

BEGIN
 
      
      
   MERGE INTO UNIFORMES.TACECO CECOGP
        USING (SELECT paCC CENTROCOSTO
                  FROM DUAL) TMPCC2
          ON (CECOGP.FICC = TMPCC2.CENTROCOSTO)
  WHEN MATCHED THEN
         UPDATE
            SET FCN1 =  paN1 
              , FCN2 =  paN2 
              , FCN3 =  paN3 
              , FCN4 =  paN4 
              , FCN5 =  paN5 
              , FCN6 =  paN6 
              , FCN7 =  paN7 
              , FCN8 =  paN8 
              , FCN9 =  paN9 
              , FCN10 =  paN10 
              , FCN11 =  paN11 
              , FCN12 =  paN12 
              , FCN13 =  paN13 
              , FINUMECO =  paNumeco
              , FCNOMBRE =  paNombre
              , FCIDCCPADRE =  paIdCCPadre
              , FCNOMBREPADRE =  paNombrePadre
              , FIIDENTIDAD =  paIdEntidad
              , FCNOMBREENTIDAD =  paNombreEntidad
              , FCIDCANAL =  paIdCanal
              , FCCANAL =  paCanal
              , FCCOLOR =  paColor
              , FCTIPOCANAL =  paTipoCanal
              , FIIDTIPOOP =  paIdTipoOp
              , FCTIPOCENTRO =  paTipoCentro
              , FINIVEL =  paNivel
              , FIESTATUS =  paEstatus
              , FCESTATUSDESC =  paEstatusDesc
              , FIPAIS =  paIdPais
              , FCPAIS =  paPais
              , FIIDRESP =  paIdResp
              , FCNOMBRERESP =  paNombreResp
              , FIIDGUNCORP =  paIdGuncorp
              , FCGUNCORP =  paGuncorp
              , FIIDDIRECCIONRH =  paIdDireccionRH
              , FCDIRECCIONRH =  paDireccionRH
              , FIIDAREARH =  paIdAreaRH
              , FCAREARH =  paAreaRH
              , FCTIPOSUCURSAL =  paTipoSucursal
              , FCNOMTIPOSUCURSAL =  paNomTipoSucursal            
 WHEN NOT MATCHED 
      THEN
       INSERT (CECOGP.FICC
              ,CECOGP.FCN1
              ,CECOGP.FCN2
              ,CECOGP.FCN3
              ,CECOGP.FCN4
              ,CECOGP.FCN5
              ,CECOGP.FCN6
              ,CECOGP.FCN7
              ,CECOGP.FCN8
              ,CECOGP.FCN9
              ,CECOGP.FCN10
              ,CECOGP.FCN11
              ,CECOGP.FCN12
              ,CECOGP.FCN13
              ,CECOGP.FINUMECO
              ,CECOGP.FCNOMBRE
              ,CECOGP.FCIDCCPADRE
              ,CECOGP.FCNOMBREPADRE
              ,CECOGP.FIIDENTIDAD
              ,CECOGP.FCNOMBREENTIDAD
              ,CECOGP.FCIDCANAL
              ,CECOGP.FCCANAL
              ,CECOGP.FCCOLOR
              ,CECOGP.FCTIPOCANAL
              ,CECOGP.FIIDTIPOOP
              ,CECOGP.FCTIPOCENTRO
              ,CECOGP.FINIVEL
              ,CECOGP.FIESTATUS
              ,CECOGP.FCESTATUSDESC
              ,CECOGP.FIPAIS
              ,CECOGP.FCPAIS
              ,CECOGP.FIIDRESP
              ,CECOGP.FCNOMBRERESP
              ,CECOGP.FIIDGUNCORP
              ,CECOGP.FCGUNCORP
              ,CECOGP.FIIDDIRECCIONRH
              ,CECOGP.FCDIRECCIONRH
              ,CECOGP.FIIDAREARH
              ,CECOGP.FCAREARH
              ,CECOGP.FCTIPOSUCURSAL
              ,CECOGP.FCNOMTIPOSUCURSAL )
     VALUES (  paCC
              ,paN1 
              ,paN2 
              ,paN3 
              ,paN4 
              ,paN5 
              ,paN6 
              ,paN7 
              ,paN8 
              ,paN9 
              ,paN10 
              ,paN11 
              ,paN12 
              ,paN13 
              ,paNumeco
              ,paNombre
              ,paIdCCPadre
              ,paNombrePadre
              ,paIdentidad
              ,paNombreEntidad
              ,paIdCanal
              ,paCanal
              ,paColor
              ,paTipoCanal
              ,paIdTipoOp
              ,paTipoCentro
              ,paNivel
              ,paEstatus
              ,paEstatusDesc
              ,paIdPais
              ,paPais
              ,paIdResp
              ,paNombreResp
              ,paIdguncorp
              ,paGuncorp
              ,paIdDireccionRH
              ,paDireccionRH
              ,paIdAreaRH
              ,paAreaRH
              ,paTipoSucursal
              ,paNomTipoSucursal );
                 
END SPINSERTACECO;


PROCEDURE SPACTUALIZASUCURSAL
   (paSucursalID   IN UNIFORMES.TASUCURSALES.FISUCURSAL%TYPE
   ,paSucursalDesc IN UNIFORMES.TASUCURSALES.FCDESCRIPCION%TYPE
   ,paDireccionIP  IN UNIFORMES.TASUCURSALES.FCDIRIP%TYPE)
IS
/*******************************************************************************
   Proyecto:   UNIFORMES
   Descripción:  Actualiza la información de la tabla SUCURSALES
   Parámetros de Entrada: paSucursalID   -- ID de la Sucursal.
                          paSucursalDesc -- Descripción de la Sucursal.
                          paDireccionIP  -- Direccion IP de la Sucursal.
   Parámetros de Salida: N/A
   Valor de Retorno:     N/A
   Parámetros de Entrada-Salida: N/A
 *******************************************************************************/

   vlCentroDistribucion  UNIFORMES.TASUCURSALES.FIIDCDISTRIBUCION%TYPE:=0;
   vlIdFormador          UNIFORMES.TASUCURSALES.FIIDFORMADOR%TYPE:=0;
   
BEGIN

   MERGE INTO UNIFORMES.TASUCURSALES SUC
     USING (SELECT paSucursalID   IDSUCURSAL
                  ,paSucursalDesc DESCSUCURSAL
                  ,paDireccionIP  DIRECCIONIP
                            FROM DUAL) TMPSUC
        ON (SUC.FISUCURSAL = TMPSUC.IDSUCURSAL)
  WHEN MATCHED THEN
          UPDATE
              SET FCDESCRIPCION = paSucursalDesc,
                  FCDIRIP = paDireccionIP
  WHEN NOT MATCHED THEN
        INSERT (SUC.FISUCURSAL
               ,SUC.FCDESCRIPCION
               ,SUC.FCDIRIP
               ,SUC.FIIDCDISTRIBUCION
               ,SUC.FIIDFORMADOR)
        VALUES (paSucursalID
               ,paSucursalDesc
               ,paDireccionIP
               ,vlCentroDistribucion
               ,vlIdFormador);
   
END SPACTUALIZASUCURSAL;


PROCEDURE SPCONSULTADATOSPEDIDOUNIFORMES(
   paNumEmpleado   IN    UNIFORMES.TAEMPLEADOS.FIEMPLEADO%TYPE,
   paCurPedidoActual OUT rcgCursor )
IS      
/********************************************************************************
   Descripcion: procedimiento consulta empleado pedido  que regresa los datos 
   Parámetros de entrada: paNumEmpleado
   Parámetros de salida: No aplica
   Parámetros de entrada-salida: Ninguno
   Valor de retorno: Cursor con resultado.
   Creador: Julio Alberto ortiz
   Fecha de creación: 16 JULIO 2014
**************************************************************************************/
      
   vlCanal              UNIFORMES.TACECO.FCIDCANAL%TYPE:= 1;  -- 
   vlSituacion          UNIFORMES.TAEMPLEADOS.FCSITUACION%TYPE := 'A';
   vlTipoSemestral      UNIFORMES.TAPEDIDOS.FITIPO%TYPE := 2;   -- Carga Semestral
    
BEGIN
   
   OPEN paCurPedidoActual FOR 
      SELECT EMP.FIEMPLEADO
            ,EMP.FIFUNCION
            ,EMP.FCPAIS
        FROM UNIFORMES.TAEMPLEADOS EMP 
       WHERE EMP.FCSITUACION = vlSituacion   -- ACTIVO  
         AND EMP.FIEMPLEADO = paNumEmpleado;         

END SPCONSULTADATOSPEDIDOUNIFORMES; 


PROCEDURE SPCONSULTAPRECSKU(
   paSku   IN   INT,
   paCurPedidoActual OUT rcgCursor )
IS
/********************************************************************************
   Descripcion: Consulta el precio del sku que se ingresa
   Parámetros de entrada: paSku
   Parámetros de salida: paCurPedidoActual 
   Parámetros de entrada-salida: Ninguno
   Valor de retorno: 
   Creador: Julio Alberto Ortiz Anaya 
   Fecha de creación: 17 JULIO 2014
**************************************************************************************/  
BEGIN
   
   OPEN paCurPedidoActual FOR 
    SELECT PROD.FISKU
          ,PROD.FNCOSTO
          ,PROD.FNDESCUENTO
      FROM UNIFORMES.TAPRODUCTOS PROD
     WHERE PROD.FISKU = paSku; -- ACTIVO  
        
        
END SPCONSULTAPRECSKU;

  PROCEDURE SPACTUALIZACD (paCD           IN     UNIFORMES.TASUCURSALES.FIIDCDISTRIBUCION%TYPE
                          ,paTiendas      IN     UNIFORMES.TASUCURSALES.FISUCURSAL%TYPE )
IS
/********************************************************************************
Proyecto:                           Uniformes
Descripcion:                        Paquete para obtener registros de SAP
Parametros de entrada:              Todos los campos que expone SAP
Parametros de salida:               No aplica
Parametros de entrada-salida        No aplica
Precondiciones:                     Tener creado el esquema
Creador:                            
Fecha de creacion:                 
 ********************************************************************************/

   

BEGIN
                               
   UPDATE UNIFORMES.TASUCURSALES 
      SET FIIDCDISTRIBUCION = paCD 
    WHERE FISUCURSAL = paTiendas;


END SPACTUALIZACD;


   
END PASRVCARGADATOS;
/

SHOW ERRORS;


ALTER TABLE TADESCUENTOSSAP ADD (
  CONSTRAINT PK_TADESCUENTOSSAP
 PRIMARY KEY
 (FIFOLIOCENTRAL, FIPEDIDO, FCSOCIEDAD, FDPAGO));

ALTER TABLE TATIPOSPRODUCTO ADD (
  CONSTRAINT PK_TATIPOSPRODUCTO
 PRIMARY KEY
 (FITIPO));

ALTER TABLE TATALLAS ADD (
  CONSTRAINT PK_TATALLAS
 PRIMARY KEY
 (FITALLA));

ALTER TABLE TASUCURSALES ADD (
  CONSTRAINT PK_TASUCURSALES
 PRIMARY KEY
 (FISUCURSAL));

ALTER TABLE TAREMISIONES ADD (
  CONSTRAINT PK_TAREMISIONES
 PRIMARY KEY
 (FIFOLIOCENTRAL, FIPAIS, FICANAL, FISUCURSAL, FIPEDIDO, FISKU, FIREMISION));

ALTER TABLE TARELACIONESCANAL ADD (
  CONSTRAINT PK_TARELACIONESCANAL
 PRIMARY KEY
 (FIUNIDADNEGOCIO, FCIDCANAL));

ALTER TABLE TAPRODUCTOSXKIT ADD (
  CONSTRAINT PK_TAPRODUCTOSXKIT
 PRIMARY KEY
 (FIKIT, FISKU));

ALTER TABLE TAPRODUCTOS ADD (
  CONSTRAINT PK_TAPRODUCTOS
 PRIMARY KEY
 (FISKU));

ALTER TABLE TAPEDIDOS ADD (
  CONSTRAINT PK_TAPEDIDOS
 PRIMARY KEY
 (FIFOLIOCENTRAL));

ALTER TABLE TAPARAMETROSSPPI ADD (
  CONSTRAINT PK_TAPARAMETROSSPPI
 PRIMARY KEY
 (FICANAL));

ALTER TABLE TAMOVTODETALLEPEDIDOS ADD (
  CONSTRAINT PK_TAMOVTODETALLEPEDIDOS
 PRIMARY KEY
 (FIFOLIOCENTRAL, FIPAIS, FICANAL, FISUCURSAL, FIPEDIDO, FISKU, FIESTADO));

ALTER TABLE TAKITS ADD (
  CONSTRAINT PK_TAKITS
 PRIMARY KEY
 (FIKIT));

ALTER TABLE TAFUNCIONES ADD (
  CONSTRAINT PK_TAFUNCIONES
 PRIMARY KEY
 (FIFUNCIONSAP, FIUNIDADNEGOCIO, FCIDCANAL));

ALTER TABLE TAEMPLEADOS ADD (
  CONSTRAINT PK_TAEMPLEADOS
 PRIMARY KEY
 (FIEMPLEADO));

ALTER TABLE TADETALLEPEDIDOS ADD (
  CONSTRAINT PK_TADETALLEPEDIDOS
 PRIMARY KEY
 (FIFOLIOCENTRAL, FIPAIS, FICANAL, FISUCURSAL, FIPEDIDO, FISKU));

ALTER TABLE TACECO ADD (
  CONSTRAINT PK_TACECO
 PRIMARY KEY
 (FICC));

ALTER TABLE TACARGAS ADD (
  CONSTRAINT PK_TACARGAS
 PRIMARY KEY
 (FIIDCARGA));

ALTER TABLE TADESCUENTOSXPEDIDOS ADD (
  CONSTRAINT PK_TADESCUENTOSXPEDIDOS
 PRIMARY KEY
 (FIFOLIOCENTRAL, FIPAIS, FICANAL, FISUCURSAL, FIPEDIDO, FISKU, FCREFERENCIA, FICONSECUTIVO));

ALTER TABLE TADESCUENTOSSPPI ADD (
  CONSTRAINT PK_TADESCUENTOSSPPI
 PRIMARY KEY
 (FIFOLIOCENTRAL, FIPAIS, FICANAL, FISUCURSAL, FIPEDIDO, FISKU, FICONSECUTIVO));

ALTER TABLE TATIPOSERROR ADD (
  CONSTRAINT PK_TATIPOSERROR
 PRIMARY KEY
 (FIIDERROR));

ALTER TABLE TATIENDASDIRIP ADD (
  CONSTRAINT PK_TATIENDASDIRIP
 PRIMARY KEY
 (FITIENDAID, FIPAISID, FICANAL, FICANALCECO));

ALTER TABLE TAEQUIVALENCIACANALES ADD (
  CONSTRAINT PK_TAEQUIVALENCIACANALES
 PRIMARY KEY
 (FICANALCECO, FICANAL));

ALTER TABLE TAREINYECCIONPEDIDOSCD ADD (
  CONSTRAINT PK_TAREINYECCIONPEDIDOSCD
 PRIMARY KEY
 (FIPAIS, FICANAL, FIIDSUCURSAL, FIPEDIDO, FISKU));

ALTER TABLE TAESTATUSPEDIDOS ADD (
  CONSTRAINT PK_TAESTATUSPEDIDOS
 PRIMARY KEY
 (FIIDESTATUSPEDIDO));

ALTER TABLE TATIPOSOLICITUD ADD (
  CONSTRAINT PK_TATIPOSOLICITUD
 PRIMARY KEY
 (FIIDTIPOSOLICITUD));

ALTER TABLE TASOLICITUDES ADD (
  CONSTRAINT PK_TASOLICITUDES
 PRIMARY KEY
 (FIFOLIOSOLICITUD));

ALTER TABLE TASOLICITUDESDETALLE ADD (
  CONSTRAINT PK_TASOLICITUDESDETALLE
 PRIMARY KEY
 (FIFOLIOSOLICITUD, FIIDDETALLE));

ALTER TABLE TATIENDAS ADD (
  CONSTRAINT PK_TATIENDAS
 PRIMARY KEY
 (FIPAIS, FICANAL, FISUCURSAL));

ALTER TABLE TAPEDIDOSCD ADD (
  CONSTRAINT PK_TAPEDIDOSCD
 PRIMARY KEY
 (FIPAIS, FICANAL, FIIDSUCURSAL, FIPEDIDO, FISKU));

ALTER TABLE TAREMISIONESXPEDIDO ADD (
  CONSTRAINT PK_TAREMISIONESXPEDIDO
 PRIMARY KEY
 (FIPAIS, FICANAL, FISUCURSAL, FIPEDIDO, FISKU, FIREMISION));

ALTER TABLE TATIPOCALCULOPRECIO ADD (
  CONSTRAINT PK_TATIPOCALCULOPRECIO
 PRIMARY KEY
 (FIIDTIPOCALCULO));

ALTER TABLE TATIPOSEVENTO ADD (
  CONSTRAINT PK_TATIPOSEVENTO
 PRIMARY KEY
 (FIIDTIPOEVENTO));

ALTER TABLE TABITACORASOLICITUD ADD (
  CONSTRAINT PK_TABITACORASOLICITUD
 PRIMARY KEY
 (FIIDBITACORA));

ALTER TABLE TACANTIDADES ADD (
  CONSTRAINT PK_TACANTIDADES
 PRIMARY KEY
 (FIIDTIPOSOLICITUD, FIIDTIPOPRENDA));

ALTER TABLE TAPRECIOS ADD (
  CONSTRAINT PK_TAPRECIOS
 PRIMARY KEY
 (FIIDTIPOSOLICITUD, FIIDTIPOPRENDA));

ALTER TABLE TASOLICITUDESXCARGA ADD (
  CONSTRAINT PK_TASOLICITUDESXCARGA
 PRIMARY KEY
 (FIFOLIOSOLICITUD, FIIDCARGA));

ALTER TABLE TAMENUS ADD (
  CONSTRAINT PK_TAMENUS
 PRIMARY KEY
 (FIIDMENU));

ALTER TABLE TAMENUSFUNCIONESXNEGOCIO ADD (
  CONSTRAINT PK_TAMENUSFUNCIONESXNEGOCIO
 PRIMARY KEY
 (FIIDMENU, FIIDNEGOCIO, FIFUNCIONSAP));

ALTER TABLE TACARGASXNEGOCIO ADD (
  CONSTRAINT PK_TACARGASXNEGOCIO
 PRIMARY KEY
 (FIIDCARGA, FIIDNEGOCIO));

ALTER TABLE TAGENERO ADD (
  CONSTRAINT PK_TAGENERO
 PRIMARY KEY
 (FIIDGENERO));

ALTER TABLE TATALLASXTIPOPRENDA ADD (
  CONSTRAINT PK_TATALLASXTIPOPRENDA
 PRIMARY KEY
 (FIIDTIPOPRENDA, FITALLA, FIIDGENERO));

ALTER TABLE TATIPOSPRENDA ADD (
  CONSTRAINT PK_TATIPOSPRENDA
 PRIMARY KEY
 (FIIDTIPOPRENDA));

ALTER TABLE TAPRENDAS ADD (
  CONSTRAINT PK_TAPRENDAS
 PRIMARY KEY
 (FISKU));

ALTER TABLE TASKUSXKIT ADD (
  CONSTRAINT PK_TASKUSXKIT
 PRIMARY KEY
 (FISKU, FIKIT));

ALTER TABLE TANEGOCIOS ADD (
  CONSTRAINT PK_TANEGOCIOS
 PRIMARY KEY
 (FIIDNEGOCIO));

ALTER TABLE TAFUNCIONESXNEGOCIO ADD (
  CONSTRAINT PK_TAFUNCIONESXNEGOCIO
 PRIMARY KEY
 (FIIDNEGOCIO, FIFUNCIONSAP));

ALTER TABLE TATIPOSPRENDAXKIT ADD (
  CONSTRAINT PK_TATIPOSPRENDAXKIT
 PRIMARY KEY
 (FIKIT, FIIDTIPOPRENDA));

ALTER TABLE TAREMISIONES ADD (
  CONSTRAINT FK_TAREMISIONES_01 
 FOREIGN KEY (FIFOLIOCENTRAL, FIPAIS, FICANAL, FISUCURSAL, FIPEDIDO, FISKU) 
 REFERENCES TADETALLEPEDIDOS (FIFOLIOCENTRAL,FIPAIS,FICANAL,FISUCURSAL,FIPEDIDO,FISKU));

ALTER TABLE TAPRODUCTOSXKIT ADD (
  CONSTRAINT FK_TAPRODUCTOSXKIT_02 
 FOREIGN KEY (FIKIT) 
 REFERENCES TAKITS (FIKIT),
  CONSTRAINT FK_TAPRODUCTOSXKIT_01 
 FOREIGN KEY (FISKU) 
 REFERENCES TAPRODUCTOS (FISKU));

ALTER TABLE TAPRODUCTOS ADD (
  CONSTRAINT FK_TAPRODUCTOS_02 
 FOREIGN KEY (FITIPO) 
 REFERENCES TATIPOSPRODUCTO (FITIPO)
    ON DELETE SET NULL,
  CONSTRAINT FK_TAPRODUCTOS_01 
 FOREIGN KEY (FITALLA) 
 REFERENCES TATALLAS (FITALLA)
    ON DELETE SET NULL);

ALTER TABLE TAPEDIDOS ADD (
  CONSTRAINT FK_TAPEDIDOS_02 
 FOREIGN KEY (FIIDCARGA) 
 REFERENCES TACARGAS (FIIDCARGA)
    ON DELETE SET NULL,
  CONSTRAINT FK_TAPEDIDOS_01 
 FOREIGN KEY (FIEMPLEADO) 
 REFERENCES TAEMPLEADOS (FIEMPLEADO)
    ON DELETE SET NULL);

ALTER TABLE TAMOVTODETALLEPEDIDOS ADD (
  CONSTRAINT FK_TAMOVTODETALLEPEDIDOS_01 
 FOREIGN KEY (FIFOLIOCENTRAL, FIPAIS, FICANAL, FISUCURSAL, FIPEDIDO, FISKU) 
 REFERENCES TADETALLEPEDIDOS (FIFOLIOCENTRAL,FIPAIS,FICANAL,FISUCURSAL,FIPEDIDO,FISKU));

ALTER TABLE TAFUNCIONES ADD (
  CONSTRAINT FK_TAFUNCIONES_02 
 FOREIGN KEY (FIUNIDADNEGOCIO, FCIDCANAL) 
 REFERENCES TARELACIONESCANAL (FIUNIDADNEGOCIO,FCIDCANAL),
  CONSTRAINT FK_TAFUNCIONES_01 
 FOREIGN KEY (FIKIT) 
 REFERENCES TAKITS (FIKIT)
    ON DELETE SET NULL);

ALTER TABLE TADETALLEPEDIDOS ADD (
  CONSTRAINT FK_TADETALLEPEDIDOS_02 
 FOREIGN KEY (FISKU) 
 REFERENCES TAPRODUCTOS (FISKU),
  CONSTRAINT FK_TADETALLEPEDIDOS_01 
 FOREIGN KEY (FIFOLIOCENTRAL) 
 REFERENCES TAPEDIDOS (FIFOLIOCENTRAL));

ALTER TABLE TATIENDASDIRIP ADD (
  CONSTRAINT FK_TATIENDASDIRIP_01 
 FOREIGN KEY (FICANALCECO, FICANAL) 
 REFERENCES TAEQUIVALENCIACANALES (FICANALCECO,FICANAL));

ALTER TABLE TAREINYECCIONPEDIDOSCD ADD (
  CONSTRAINT FK_TAREINYECCIONPEDIDOSCD_01 
 FOREIGN KEY (FIPAIS, FICANAL, FIIDSUCURSAL, FIPEDIDO, FISKU) 
 REFERENCES TAPEDIDOSCD (FIPAIS,FICANAL,FIIDSUCURSAL,FIPEDIDO,FISKU));

ALTER TABLE TASOLICITUDES ADD (
  CONSTRAINT FK_TASOLICITUDES_02 
 FOREIGN KEY (FIIDTIPOSOLICITUD) 
 REFERENCES TATIPOSOLICITUD (FIIDTIPOSOLICITUD),
  CONSTRAINT FK_TASOLICITUDES_01 
 FOREIGN KEY (FIIDNEGOCIO) 
 REFERENCES TANEGOCIOS (FIIDNEGOCIO));

ALTER TABLE TASOLICITUDESDETALLE ADD (
  CONSTRAINT FK_TASOLICITUDESDETALLE_01 
 FOREIGN KEY (FIFOLIOSOLICITUD) 
 REFERENCES TASOLICITUDES (FIFOLIOSOLICITUD) DISABLE,
  CONSTRAINT FK_TASOLICITUDESDETALLE_03 
 FOREIGN KEY (FITALLA) 
 REFERENCES TATALLAS (FITALLA),
  CONSTRAINT FK_TASOLICITUDESDETALLE_02 
 FOREIGN KEY (FIIDTIPOPRENDA) 
 REFERENCES TATIPOSPRENDA (FIIDTIPOPRENDA));

ALTER TABLE TAPEDIDOSCD ADD (
  CONSTRAINT FK_TAPEDIDOSCD_03 
 FOREIGN KEY (FIFOLIOSOLICITUD, FIIDDETALLE) 
 REFERENCES TASOLICITUDESDETALLE (FIFOLIOSOLICITUD,FIIDDETALLE) DISABLE,
  CONSTRAINT FK_TAPEDIDOSCD_04 
 FOREIGN KEY (FIPAIS, FICANAL, FIIDSUCURSAL) 
 REFERENCES TATIENDAS (FIPAIS,FICANAL,FISUCURSAL),
  CONSTRAINT FK_TAPEDIDOSCD_02 
 FOREIGN KEY (FISKU) 
 REFERENCES TAPRENDAS (FISKU),
  CONSTRAINT FK_TAPEDIDOSCD_01 
 FOREIGN KEY (FIIDESTATUSPEDIDO) 
 REFERENCES TAESTATUSPEDIDOS (FIIDESTATUSPEDIDO));

ALTER TABLE TAREMISIONESXPEDIDO ADD (
  CONSTRAINT FK_TAREMISIONESXPEDIDO_01 
 FOREIGN KEY (FIPAIS, FICANAL, FISUCURSAL, FIPEDIDO, FISKU) 
 REFERENCES TAPEDIDOSCD (FIPAIS,FICANAL,FIIDSUCURSAL,FIPEDIDO,FISKU));

ALTER TABLE TABITACORASOLICITUD ADD (
  CONSTRAINT FK_TABITACORASOLICITUD_03 
 FOREIGN KEY (FIFOLIOSOLICITUD, FIIDDETALLE) 
 REFERENCES TASOLICITUDESDETALLE (FIFOLIOSOLICITUD,FIIDDETALLE) DISABLE,
  CONSTRAINT FK_TABITACORASOLICITUD_05 
 FOREIGN KEY (FIIDERROR) 
 REFERENCES TATIPOSERROR (FIIDERROR),
  CONSTRAINT FK_TABITACORASOLICITUD_04 
 FOREIGN KEY (FIIDTIPOEVENTO) 
 REFERENCES TATIPOSEVENTO (FIIDTIPOEVENTO),
  CONSTRAINT FK_TABITACORASOLICITUD_02 
 FOREIGN KEY (FIIDESTATUSNVO) 
 REFERENCES TAESTATUSPEDIDOS (FIIDESTATUSPEDIDO),
  CONSTRAINT FK_TABITACORASOLICITUD_01 
 FOREIGN KEY (FIIDESTATUSANT) 
 REFERENCES TAESTATUSPEDIDOS (FIIDESTATUSPEDIDO));

ALTER TABLE TACANTIDADES ADD (
  CONSTRAINT FK_TACANTIDADES_02 
 FOREIGN KEY (FIIDTIPOPRENDA) 
 REFERENCES TATIPOSPRENDA (FIIDTIPOPRENDA),
  CONSTRAINT FK_TACANTIDADES_01 
 FOREIGN KEY (FIIDTIPOSOLICITUD) 
 REFERENCES TATIPOSOLICITUD (FIIDTIPOSOLICITUD));

ALTER TABLE TAPRECIOS ADD (
  CONSTRAINT FK_TAPRECIOS_03 
 FOREIGN KEY (FIIDTIPOPRENDA) 
 REFERENCES TATIPOSPRENDA (FIIDTIPOPRENDA),
  CONSTRAINT FK_TAPRECIOS_02 
 FOREIGN KEY (FIIDTIPOSOLICITUD) 
 REFERENCES TATIPOSOLICITUD (FIIDTIPOSOLICITUD),
  CONSTRAINT FK_TAPRECIOS_01 
 FOREIGN KEY (FIIDTIPOCALCULO) 
 REFERENCES TATIPOCALCULOPRECIO (FIIDTIPOCALCULO));

ALTER TABLE TASOLICITUDESXCARGA ADD (
  CONSTRAINT FK_TASOLICITUDESXCARGA_02 
 FOREIGN KEY (FIFOLIOSOLICITUD) 
 REFERENCES TASOLICITUDES (FIFOLIOSOLICITUD) DISABLE,
  CONSTRAINT FK_TASOLICITUDESXCARGA_01 
 FOREIGN KEY (FIIDCARGA) 
 REFERENCES TACARGAS (FIIDCARGA));

ALTER TABLE TAMENUSFUNCIONESXNEGOCIO ADD (
  CONSTRAINT FK_TAMENUSFUNCIONESXNEGOCIO_02 
 FOREIGN KEY (FIIDNEGOCIO, FIFUNCIONSAP) 
 REFERENCES TAFUNCIONESXNEGOCIO (FIIDNEGOCIO,FIFUNCIONSAP),
  CONSTRAINT FK_TAMENUSFUNCIONESXNEGOCIO_01 
 FOREIGN KEY (FIIDMENU) 
 REFERENCES TAMENUS (FIIDMENU));

ALTER TABLE TACARGASXNEGOCIO ADD (
  CONSTRAINT FK_TACARGASXNEGOCIO_02 
 FOREIGN KEY (FIIDNEGOCIO) 
 REFERENCES TANEGOCIOS (FIIDNEGOCIO),
  CONSTRAINT FK_TACARGASXNEGOCIO_01 
 FOREIGN KEY (FIIDCARGA) 
 REFERENCES TACARGAS (FIIDCARGA));

ALTER TABLE TATALLASXTIPOPRENDA ADD (
  CONSTRAINT FK_TATALLASXTIPOPRENDA_03 
 FOREIGN KEY (FITALLA) 
 REFERENCES TATALLAS (FITALLA),
  CONSTRAINT FK_TATALLASXTIPOPRENDA_02 
 FOREIGN KEY (FIIDTIPOPRENDA) 
 REFERENCES TATIPOSPRENDA (FIIDTIPOPRENDA),
  CONSTRAINT FK_TATALLASXTIPOPRENDA_01 
 FOREIGN KEY (FIIDGENERO) 
 REFERENCES TAGENERO (FIIDGENERO));

ALTER TABLE TAPRENDAS ADD (
  CONSTRAINT FK_TAPRENDAS_01 
 FOREIGN KEY (FIIDTIPOPRENDA, FITALLA, FIIDGENERO) 
 REFERENCES TATALLASXTIPOPRENDA (FIIDTIPOPRENDA,FITALLA,FIIDGENERO));

ALTER TABLE TASKUSXKIT ADD (
  CONSTRAINT FK_TASKUSXKIT_02 
 FOREIGN KEY (FISKU) 
 REFERENCES TAPRENDAS (FISKU),
  CONSTRAINT FK_TASKUSXKIT_01 
 FOREIGN KEY (FIKIT) 
 REFERENCES TAKITS (FIKIT));

ALTER TABLE TAFUNCIONESXNEGOCIO ADD (
  CONSTRAINT FK_TAFUNCIONESXNEGOCIO_02 
 FOREIGN KEY (FIIDNEGOCIO) 
 REFERENCES TANEGOCIOS (FIIDNEGOCIO),
  CONSTRAINT FK_TAFUNCIONESXNEGOCIO_01 
 FOREIGN KEY (FIKIT) 
 REFERENCES TAKITS (FIKIT));

ALTER TABLE TATIPOSPRENDAXKIT ADD (
  CONSTRAINT FK_TATIPOSPRENDAXKIT_02 
 FOREIGN KEY (FIIDTIPOPRENDA) 
 REFERENCES TATIPOSPRENDA (FIIDTIPOPRENDA),
  CONSTRAINT FK_TATIPOSPRENDAXKIT_01 
 FOREIGN KEY (FIKIT) 
 REFERENCES TAKITS (FIKIT));

GRANT EXECUTE ON PASRVUNIFORMESCOMERCIO TO UNIFORMES;

GRANT EXECUTE ON PASRVCARGADATOS TO USRUNIFORMESSRV;

GRANT EXECUTE ON PASRVOPERAUNIFORMES TO USRUNIFORMESSRV;

GRANT EXECUTE ON PAWSUNIFORMES TO USRUNIFORMESWS;

